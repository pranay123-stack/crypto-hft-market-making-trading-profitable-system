================================================================================
BUILD AUTOMATION FOR HFT SYSTEMS
================================================================================
Complete build automation using CMake, Conan, and vcpkg for C++ HFT systems
with optimized compilation, dependency management, and reproducible builds.

Last Updated: 2025-11-25
================================================================================

TABLE OF CONTENTS
================================================================================
1. CMake Configuration
2. Conan Package Management
3. vcpkg Integration
4. Build Scripts
5. Cross-Platform Builds
6. Optimization Flags
7. Static Analysis Integration
8. Continuous Build System
9. Caching Strategies

================================================================================
1. CMAKE CONFIGURATION
================================================================================

# CMakeLists.txt - Root
cmake_minimum_required(VERSION 3.27)

project(HFT_Trading_Engine
    VERSION 1.0.0
    DESCRIPTION "High-Frequency Trading Engine"
    LANGUAGES CXX C
)

# C++ Standard
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Export compile commands for clang-tidy
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Build type
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
endif()

message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "C++ Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")

# Options
option(ENABLE_TESTING "Enable unit tests" ON)
option(ENABLE_BENCHMARKS "Enable benchmarks" ON)
option(ENABLE_COVERAGE "Enable code coverage" OFF)
option(ENABLE_SANITIZERS "Enable sanitizers" OFF)
option(ENABLE_LTO "Enable link-time optimization" ON)
option(ENABLE_IPO "Enable interprocedural optimization" ON)
option(USE_CONAN "Use Conan for dependency management" ON)
option(USE_VCPKG "Use vcpkg for dependency management" OFF)
option(BUILD_SHARED_LIBS "Build shared libraries" OFF)

# Include directories
include_directories(
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_BINARY_DIR}/generated/include
)

# Compiler-specific optimizations
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    # Base flags
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Wpedantic")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=native -mtune=native")

    # Release optimizations
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -O3")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -DNDEBUG")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -ffast-math")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -funroll-loops")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -finline-functions")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -fomit-frame-pointer")

    # Debug flags
    set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -g3 -O0")
    set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -fno-omit-frame-pointer")

    # RelWithDebInfo
    set(CMAKE_CXX_FLAGS_RELWITHDEBINFO "${CMAKE_CXX_FLAGS_RELWITHDEBINFO} -O2 -g")
endif()

if(CMAKE_CXX_COMPILER_ID MATCHES "GNU")
    # GCC-specific optimizations
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -flto=auto")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -fuse-linker-plugin")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wno-psabi")
endif()

if(CMAKE_CXX_COMPILER_ID MATCHES "Clang")
    # Clang-specific optimizations
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -flto=thin")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wno-unused-command-line-argument")
endif()

# Link-time optimization
if(ENABLE_LTO AND NOT CMAKE_BUILD_TYPE STREQUAL "Debug")
    include(CheckIPOSupported)
    check_ipo_supported(RESULT ipo_supported OUTPUT ipo_output)
    if(ipo_supported)
        message(STATUS "IPO/LTO enabled")
        set(CMAKE_INTERPROCEDURAL_OPTIMIZATION TRUE)
    else()
        message(WARNING "IPO/LTO not supported: ${ipo_output}")
    endif()
endif()

# Sanitizers
if(ENABLE_SANITIZERS)
    if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
        set(SANITIZER_FLAGS "-fsanitize=address,undefined -fno-omit-frame-pointer")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${SANITIZER_FLAGS}")
        set(CMAKE_LINKER_FLAGS "${CMAKE_LINKER_FLAGS} ${SANITIZER_FLAGS}")
        message(STATUS "Sanitizers enabled: AddressSanitizer, UndefinedBehaviorSanitizer")
    endif()
endif()

# Code coverage
if(ENABLE_COVERAGE)
    if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
        set(COVERAGE_FLAGS "--coverage -fprofile-arcs -ftest-coverage")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${COVERAGE_FLAGS}")
        set(CMAKE_LINKER_FLAGS "${CMAKE_LINKER_FLAGS} ${COVERAGE_FLAGS}")
        message(STATUS "Code coverage enabled")
    endif()
endif()

# Dependency management
if(USE_CONAN)
    include(${CMAKE_BINARY_DIR}/conan_toolchain.cmake OPTIONAL)
    find_package(fmt REQUIRED)
    find_package(spdlog REQUIRED)
    find_package(nlohmann_json REQUIRED)
    find_package(Boost REQUIRED COMPONENTS system thread)
    find_package(GTest REQUIRED)
    find_package(benchmark REQUIRED)
elseif(USE_VCPKG)
    find_package(fmt CONFIG REQUIRED)
    find_package(spdlog CONFIG REQUIRED)
    find_package(nlohmann_json CONFIG REQUIRED)
    find_package(Boost REQUIRED COMPONENTS system thread)
    find_package(GTest CONFIG REQUIRED)
    find_package(benchmark CONFIG REQUIRED)
endif()

# Custom modules
list(APPEND CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/cmake")
include(CompilerWarnings)
include(StaticAnalysis)
include(Documentation)

# Subdirectories
add_subdirectory(src)

if(ENABLE_TESTING)
    enable_testing()
    add_subdirectory(tests)
endif()

if(ENABLE_BENCHMARKS)
    add_subdirectory(benchmarks)
endif()

# Installation
include(GNUInstallDirs)
install(TARGETS trading-engine
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
)

install(DIRECTORY ${CMAKE_SOURCE_DIR}/include/
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
    FILES_MATCHING PATTERN "*.hpp"
)

install(FILES ${CMAKE_SOURCE_DIR}/config/production.yaml
    DESTINATION ${CMAKE_INSTALL_SYSCONFDIR}/hft-trading
)

# CPack configuration
set(CPACK_PACKAGE_NAME "hft-trading-engine")
set(CPACK_PACKAGE_VERSION "${PROJECT_VERSION}")
set(CPACK_PACKAGE_VENDOR "HFT Trading Inc.")
set(CPACK_PACKAGE_DESCRIPTION_SUMMARY "High-Frequency Trading Engine")
set(CPACK_GENERATOR "TGZ;DEB;RPM")
set(CPACK_DEBIAN_PACKAGE_MAINTAINER "DevOps Team")
include(CPack)

# Print configuration summary
message(STATUS "=====================================")
message(STATUS "Configuration Summary:")
message(STATUS "  Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "  C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "  Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "  Testing: ${ENABLE_TESTING}")
message(STATUS "  Benchmarks: ${ENABLE_BENCHMARKS}")
message(STATUS "  Coverage: ${ENABLE_COVERAGE}")
message(STATUS "  Sanitizers: ${ENABLE_SANITIZERS}")
message(STATUS "  LTO: ${ENABLE_LTO}")
message(STATUS "  Dependency Manager: ${USE_CONAN}Conan ${USE_VCPKG}vcpkg")
message(STATUS "=====================================")

---
# src/CMakeLists.txt
set(TRADING_ENGINE_SOURCES
    main.cpp
    order_manager.cpp
    market_data_handler.cpp
    execution_engine.cpp
    risk_manager.cpp
    strategy_engine.cpp
    network/tcp_server.cpp
    network/websocket_server.cpp
    utils/logger.cpp
    utils/metrics.cpp
)

set(TRADING_ENGINE_HEADERS
    ${CMAKE_SOURCE_DIR}/include/order_manager.hpp
    ${CMAKE_SOURCE_DIR}/include/market_data_handler.hpp
    ${CMAKE_SOURCE_DIR}/include/execution_engine.hpp
    ${CMAKE_SOURCE_DIR}/include/risk_manager.hpp
    ${CMAKE_SOURCE_DIR}/include/strategy_engine.hpp
    ${CMAKE_SOURCE_DIR}/include/network/tcp_server.hpp
    ${CMAKE_SOURCE_DIR}/include/network/websocket_server.hpp
    ${CMAKE_SOURCE_DIR}/include/utils/logger.hpp
    ${CMAKE_SOURCE_DIR}/include/utils/metrics.hpp
)

# Main executable
add_executable(trading-engine ${TRADING_ENGINE_SOURCES} ${TRADING_ENGINE_HEADERS})

# Libraries
target_link_libraries(trading-engine PRIVATE
    fmt::fmt
    spdlog::spdlog
    nlohmann_json::nlohmann_json
    Boost::system
    Boost::thread
    pthread
)

# Compile options
target_compile_options(trading-engine PRIVATE
    $<$<CXX_COMPILER_ID:GNU,Clang>:-Wall -Wextra -Wpedantic>
    $<$<CONFIG:Release>:-O3 -DNDEBUG>
    $<$<CONFIG:Debug>:-g3 -O0>
)

# Set properties
set_target_properties(trading-engine PROPERTIES
    CXX_STANDARD 20
    CXX_STANDARD_REQUIRED ON
    CXX_EXTENSIONS OFF
    RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
)

---
# cmake/CompilerWarnings.cmake
function(set_project_warnings target)
    set(CLANG_WARNINGS
        -Wall
        -Wextra
        -Wpedantic
        -Wshadow
        -Wnon-virtual-dtor
        -Wold-style-cast
        -Wcast-align
        -Wunused
        -Woverloaded-virtual
        -Wconversion
        -Wsign-conversion
        -Wnull-dereference
        -Wdouble-promotion
        -Wformat=2
    )

    set(GCC_WARNINGS
        ${CLANG_WARNINGS}
        -Wmisleading-indentation
        -Wduplicated-cond
        -Wduplicated-branches
        -Wlogical-op
        -Wuseless-cast
    )

    if(CMAKE_CXX_COMPILER_ID MATCHES "Clang")
        set(PROJECT_WARNINGS ${CLANG_WARNINGS})
    elseif(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
        set(PROJECT_WARNINGS ${GCC_WARNINGS})
    endif()

    target_compile_options(${target} PRIVATE ${PROJECT_WARNINGS})
endfunction()

---
# cmake/StaticAnalysis.cmake
find_program(CPPCHECK cppcheck)
if(CPPCHECK)
    set(CMAKE_CXX_CPPCHECK
        ${CPPCHECK}
        --enable=all
        --suppress=missingInclude
        --inline-suppr
        --std=c++20
    )
    message(STATUS "cppcheck found: ${CPPCHECK}")
endif()

find_program(CLANG_TIDY clang-tidy)
if(CLANG_TIDY)
    set(CMAKE_CXX_CLANG_TIDY
        ${CLANG_TIDY}
        -checks=*,-fuchsia-*,-google-*,-zircon-*,-abseil-*,-modernize-use-trailing-return-type
        -header-filter=.*
    )
    message(STATUS "clang-tidy found: ${CLANG_TIDY}")
endif()

find_program(IWYU include-what-you-use)
if(IWYU)
    set(CMAKE_CXX_INCLUDE_WHAT_YOU_USE ${IWYU})
    message(STATUS "include-what-you-use found: ${IWYU}")
endif()

================================================================================
2. CONAN PACKAGE MANAGEMENT
================================================================================

# conanfile.py
from conan import ConanFile
from conan.tools.cmake import CMakeToolchain, CMake, cmake_layout, CMakeDeps
from conan.tools.build import check_min_cppstd

class HFTTradingEngineConan(ConanFile):
    name = "hft-trading-engine"
    version = "1.0.0"
    license = "Proprietary"
    author = "Trading Platform Team"
    url = "https://github.com/company/hft-trading-engine"
    description = "High-Frequency Trading Engine"
    topics = ("trading", "hft", "finance")

    settings = "os", "compiler", "build_type", "arch"
    options = {
        "shared": [True, False],
        "fPIC": [True, False],
        "with_tests": [True, False],
        "with_benchmarks": [True, False],
    }
    default_options = {
        "shared": False,
        "fPIC": True,
        "with_tests": True,
        "with_benchmarks": True,
    }

    exports_sources = "CMakeLists.txt", "src/*", "include/*", "cmake/*"

    def config_options(self):
        if self.settings.os == "Windows":
            del self.options.fPIC

    def configure(self):
        if self.options.shared:
            self.options.rm_safe("fPIC")

    def validate(self):
        check_min_cppstd(self, "20")

    def requirements(self):
        # Core dependencies
        self.requires("fmt/10.1.1")
        self.requires("spdlog/1.12.0")
        self.requires("nlohmann_json/3.11.3")
        self.requires("boost/1.83.0")

        # Networking
        self.requires("asio/1.28.0")

        # Serialization
        self.requires("protobuf/3.21.12")
        self.requires("flatbuffers/23.5.26")

        # Database
        self.requires("libpq/15.4")
        self.requires("hiredis/1.2.0")

        # Metrics
        self.requires("prometheus-cpp/1.1.0")

        if self.options.with_tests:
            self.requires("gtest/1.14.0")
            self.requires("catch2/3.5.0")

        if self.options.with_benchmarks:
            self.requires("benchmark/1.8.3")

    def build_requirements(self):
        self.tool_requires("cmake/3.27.0")

    def layout(self):
        cmake_layout(self)

    def generate(self):
        # CMake toolchain
        tc = CMakeToolchain(self)
        tc.variables["ENABLE_TESTING"] = self.options.with_tests
        tc.variables["ENABLE_BENCHMARKS"] = self.options.with_benchmarks
        tc.generate()

        # CMake dependencies
        deps = CMakeDeps(self)
        deps.generate()

    def build(self):
        cmake = CMake(self)
        cmake.configure()
        cmake.build()
        if self.options.with_tests:
            cmake.test()

    def package(self):
        cmake = CMake(self)
        cmake.install()

    def package_info(self):
        self.cpp_info.libs = ["trading-engine"]
        self.cpp_info.includedirs = ["include"]
        self.cpp_info.cxxflags = ["-march=native", "-mtune=native"]

---
# conanfile.txt (simplified version)
[requires]
fmt/10.1.1
spdlog/1.12.0
nlohmann_json/3.11.3
boost/1.83.0
asio/1.28.0
protobuf/3.21.12
flatbuffers/23.5.26
libpq/15.4
hiredis/1.2.0
prometheus-cpp/1.1.0
gtest/1.14.0
benchmark/1.8.3

[generators]
CMakeToolchain
CMakeDeps

[options]
boost:shared=False
boost:header_only=False
boost:without_test=True

[settings]
os=Linux
arch=x86_64
compiler=gcc
compiler.version=13
compiler.libcxx=libstdc++11
build_type=Release

---
# Conan profile for production
# profiles/production
[settings]
os=Linux
os_build=Linux
arch=x86_64
arch_build=x86_64
compiler=gcc
compiler.version=13
compiler.libcxx=libstdc++11
compiler.cppstd=20
build_type=Release

[options]
*:shared=False

[buildenv]
CC=gcc-13
CXX=g++-13

[conf]
tools.cmake.cmaketoolchain:generator=Ninja
tools.build:jobs=8

[buildenv]
CFLAGS=-march=native -mtune=native -O3
CXXFLAGS=-march=native -mtune=native -O3 -std=c++20

================================================================================
3. VCPKG INTEGRATION
================================================================================

# vcpkg.json
{
  "name": "hft-trading-engine",
  "version": "1.0.0",
  "description": "High-Frequency Trading Engine",
  "dependencies": [
    "fmt",
    "spdlog",
    "nlohmann-json",
    "boost-system",
    "boost-thread",
    "boost-asio",
    "asio",
    "protobuf",
    "flatbuffers",
    "libpq",
    "hiredis",
    "prometheus-cpp",
    "gtest",
    "benchmark"
  ],
  "builtin-baseline": "a42af01b72c28a8e1d7b48107b33e4f286a55ef6",
  "overrides": [
    {
      "name": "boost",
      "version": "1.83.0"
    }
  ]
}

---
# vcpkg-configuration.json
{
  "default-registry": {
    "kind": "git",
    "repository": "https://github.com/microsoft/vcpkg",
    "baseline": "a42af01b72c28a8e1d7b48107b33e4f286a55ef6"
  },
  "registries": [
    {
      "kind": "git",
      "repository": "https://github.com/company/vcpkg-registry",
      "baseline": "main",
      "packages": ["internal-*"]
    }
  ]
}

---
# CMakePresets.json for vcpkg
{
  "version": 3,
  "cmakeMinimumRequired": {
    "major": 3,
    "minor": 27,
    "patch": 0
  },
  "configurePresets": [
    {
      "name": "vcpkg",
      "hidden": true,
      "toolchainFile": "$env{VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake"
    },
    {
      "name": "linux-release",
      "inherits": "vcpkg",
      "generator": "Ninja",
      "binaryDir": "${sourceDir}/build/release",
      "cacheVariables": {
        "CMAKE_BUILD_TYPE": "Release",
        "CMAKE_CXX_COMPILER": "g++-13",
        "CMAKE_C_COMPILER": "gcc-13",
        "ENABLE_TESTING": "ON",
        "ENABLE_BENCHMARKS": "ON"
      }
    },
    {
      "name": "linux-debug",
      "inherits": "vcpkg",
      "generator": "Ninja",
      "binaryDir": "${sourceDir}/build/debug",
      "cacheVariables": {
        "CMAKE_BUILD_TYPE": "Debug",
        "CMAKE_CXX_COMPILER": "g++-13",
        "CMAKE_C_COMPILER": "gcc-13",
        "ENABLE_TESTING": "ON",
        "ENABLE_SANITIZERS": "ON"
      }
    }
  ],
  "buildPresets": [
    {
      "name": "release",
      "configurePreset": "linux-release",
      "configuration": "Release",
      "jobs": 8
    },
    {
      "name": "debug",
      "configurePreset": "linux-debug",
      "configuration": "Debug",
      "jobs": 8
    }
  ],
  "testPresets": [
    {
      "name": "release-tests",
      "configurePreset": "linux-release",
      "output": {
        "outputOnFailure": true
      },
      "execution": {
        "noTestsAction": "error",
        "stopOnFailure": false,
        "jobs": 8
      }
    }
  ]
}

================================================================================
4. BUILD SCRIPTS
================================================================================

# scripts/build.sh
#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
BUILD_TYPE="${1:-Release}"
USE_CONAN="${USE_CONAN:-1}"
USE_VCPKG="${USE_VCPKG:-0}"
JOBS="${JOBS:-$(nproc)}"

echo "========================================"
echo "Building HFT Trading Engine"
echo "========================================"
echo "Build Type: ${BUILD_TYPE}"
echo "Jobs: ${JOBS}"
echo "Use Conan: ${USE_CONAN}"
echo "Use vcpkg: ${USE_VCPKG}"
echo "========================================"

cd "$PROJECT_ROOT"

# Clean previous build
if [ -d "build" ]; then
    echo "Cleaning previous build..."
    rm -rf build
fi

mkdir -p build
cd build

# Dependency management
if [ "$USE_CONAN" == "1" ]; then
    echo "Installing dependencies with Conan..."
    conan install .. \
        --build=missing \
        --settings build_type=${BUILD_TYPE} \
        --settings compiler.cppstd=20 \
        --profile=../profiles/production
fi

# Configure CMake
echo "Configuring CMake..."
cmake .. \
    -G Ninja \
    -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
    -DCMAKE_CXX_COMPILER=g++-13 \
    -DCMAKE_C_COMPILER=gcc-13 \
    -DENABLE_TESTING=ON \
    -DENABLE_BENCHMARKS=ON \
    -DUSE_CONAN=${USE_CONAN} \
    -DUSE_VCPKG=${USE_VCPKG}

# Build
echo "Building..."
cmake --build . --config ${BUILD_TYPE} -j ${JOBS}

# Run tests
if [ "$RUN_TESTS" == "1" ]; then
    echo "Running tests..."
    ctest --output-on-failure -j ${JOBS}
fi

echo "========================================"
echo "Build completed successfully!"
echo "Binary: build/bin/trading-engine"
echo "========================================"

---
# scripts/build-optimized.sh
#!/bin/bash
set -e

BUILD_DIR="build-optimized"
JOBS=$(nproc)

# Advanced optimization flags
CXXFLAGS="-O3 -march=native -mtune=native -flto -ffast-math"
CXXFLAGS="${CXXFLAGS} -funroll-loops -finline-functions"
CXXFLAGS="${CXXFLAGS} -fomit-frame-pointer -fno-exceptions"

# PGO (Profile-Guided Optimization) build
echo "Stage 1: Instrumented build for profiling..."
cmake -B ${BUILD_DIR}-pgo1 \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CXX_FLAGS="${CXXFLAGS} -fprofile-generate" \
    -DCMAKE_EXE_LINKER_FLAGS="-fprofile-generate"

cmake --build ${BUILD_DIR}-pgo1 -j ${JOBS}

echo "Stage 2: Collecting profile data..."
${BUILD_DIR}-pgo1/bin/trading-engine --benchmark > /dev/null 2>&1 || true

echo "Stage 3: Optimized build with profile data..."
cmake -B ${BUILD_DIR} \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CXX_FLAGS="${CXXFLAGS} -fprofile-use" \
    -DCMAKE_EXE_LINKER_FLAGS="-fprofile-use"

cmake --build ${BUILD_DIR} -j ${JOBS}

echo "PGO-optimized build completed: ${BUILD_DIR}/bin/trading-engine"

---
# scripts/cross-compile.sh
#!/bin/bash
set -e

TARGET_ARCH="${1:-aarch64}"
BUILD_DIR="build-${TARGET_ARCH}"

case ${TARGET_ARCH} in
    aarch64)
        TOOLCHAIN_FILE="cmake/toolchains/aarch64-linux-gnu.cmake"
        ;;
    armv7)
        TOOLCHAIN_FILE="cmake/toolchains/arm-linux-gnueabihf.cmake"
        ;;
    *)
        echo "Unsupported architecture: ${TARGET_ARCH}"
        exit 1
        ;;
esac

cmake -B ${BUILD_DIR} \
    -DCMAKE_TOOLCHAIN_FILE=${TOOLCHAIN_FILE} \
    -DCMAKE_BUILD_TYPE=Release

cmake --build ${BUILD_DIR} -j $(nproc)

echo "Cross-compilation for ${TARGET_ARCH} completed"

---
# cmake/toolchains/aarch64-linux-gnu.cmake
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR aarch64)

set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)

set(CMAKE_FIND_ROOT_PATH /usr/aarch64-linux-gnu)
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)

================================================================================
5. CONTINUOUS BUILD SYSTEM
================================================================================

# scripts/ci-build.sh
#!/bin/bash
set -e

# Environment variables
export CC=gcc-13
export CXX=g++-13
export CCACHE_DIR=${CCACHE_DIR:-$HOME/.ccache}
export CONAN_USER_HOME=${CONAN_USER_HOME:-$HOME/.conan2}

BUILD_TYPE="${BUILD_TYPE:-Release}"
ENABLE_COVERAGE="${ENABLE_COVERAGE:-0}"
ENABLE_SANITIZERS="${ENABLE_SANITIZERS:-0}"

echo "CI Build Configuration:"
echo "  Build Type: ${BUILD_TYPE}"
echo "  Coverage: ${ENABLE_COVERAGE}"
echo "  Sanitizers: ${ENABLE_SANITIZERS}"

# Setup ccache
ccache --zero-stats
ccache --max-size=5G

# Install Conan dependencies
conan install . --build=missing \
    -s build_type=${BUILD_TYPE} \
    -s compiler.cppstd=20

# Configure
cmake -B build \
    -G Ninja \
    -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
    -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
    -DENABLE_TESTING=ON \
    -DENABLE_BENCHMARKS=ON \
    -DENABLE_COVERAGE=${ENABLE_COVERAGE} \
    -DENABLE_SANITIZERS=${ENABLE_SANITIZERS}

# Build
cmake --build build -j $(nproc)

# Test
cd build
ctest --output-on-failure -j $(nproc)

# Generate coverage report
if [ "$ENABLE_COVERAGE" == "1" ]; then
    lcov --capture --directory . --output-file coverage.info
    lcov --remove coverage.info '/usr/*' '*/test/*' --output-file coverage.info
    lcov --list coverage.info
    genhtml coverage.info --output-directory coverage-report
fi

# Show ccache stats
ccache --show-stats

echo "CI Build completed successfully"

---
# Makefile wrapper
.PHONY: all build test clean install benchmark coverage

BUILD_TYPE ?= Release
BUILD_DIR ?= build
JOBS ?= $(shell nproc)

all: build

build:
	@./scripts/build.sh $(BUILD_TYPE)

test: build
	@cd $(BUILD_DIR) && ctest --output-on-failure -j $(JOBS)

benchmark: build
	@$(BUILD_DIR)/bin/benchmarks

clean:
	@rm -rf $(BUILD_DIR)
	@rm -rf build-*
	@rm -f compile_commands.json

install: build
	@cd $(BUILD_DIR) && cmake --install .

coverage:
	@ENABLE_COVERAGE=1 ./scripts/ci-build.sh
	@xdg-open $(BUILD_DIR)/coverage-report/index.html

format:
	@find src include tests -name '*.cpp' -o -name '*.hpp' | xargs clang-format -i

lint:
	@find src include -name '*.cpp' -o -name '*.hpp' | xargs clang-tidy -p $(BUILD_DIR)

package:
	@cd $(BUILD_DIR) && cpack

================================================================================
6. CACHING STRATEGIES
================================================================================

# .ccache/ccache.conf
max_size = 10.0G
compression = true
compression_level = 6
sloppiness = file_macro,time_macros,include_file_mtime,include_file_ctime
hash_dir = false

# scripts/setup-build-cache.sh
#!/bin/bash

# Setup ccache
ccache --set-config=max_size=10G
ccache --set-config=compression=true
ccache --set-config=compression_level=6

# Setup Conan cache
export CONAN_USER_HOME=$HOME/.conan2
mkdir -p $CONAN_USER_HOME

# Setup vcpkg binary caching
export VCPKG_DEFAULT_BINARY_CACHE=$HOME/.vcpkg-cache
mkdir -p $VCPKG_DEFAULT_BINARY_CACHE

echo "Build caches configured"
echo "  ccache: $(ccache --get-config=cache_dir)"
echo "  Conan: $CONAN_USER_HOME"
echo "  vcpkg: $VCPKG_DEFAULT_BINARY_CACHE"

================================================================================
BUILD BEST PRACTICES FOR HFT SYSTEMS
================================================================================

1. OPTIMIZATION LEVELS
   - Use -O3 for production builds
   - Enable LTO/IPO for additional optimizations
   - Use PGO for critical hot paths
   - Enable -march=native for maximum performance

2. DEPENDENCY MANAGEMENT
   - Use Conan or vcpkg for reproducible builds
   - Pin exact dependency versions
   - Pre-build and cache dependencies
   - Use binary caching for faster builds

3. BUILD PERFORMANCE
   - Enable ccache for incremental builds
   - Use Ninja generator for parallel builds
   - Maximize CPU utilization with -j flag
   - Distributed compilation with distcc/icecc

4. TESTING
   - Run unit tests on every build
   - Benchmark critical paths regularly
   - Track performance regressions
   - Code coverage > 80%

5. CONTINUOUS INTEGRATION
   - Build on every commit
   - Test multiple compilers (GCC, Clang)
   - Test debug and release configurations
   - Generate and track metrics

================================================================================
END OF BUILD AUTOMATION GUIDE
================================================================================
