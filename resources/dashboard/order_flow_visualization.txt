================================================================================
ORDER FLOW VISUALIZATION DASHBOARD - HFT TRADING SYSTEM
Order Book Depth, Flow Imbalance, and Market Microstructure Analysis
================================================================================

OVERVIEW
--------
Advanced visualization dashboards for monitoring order flow, order book dynamics,
market depth, liquidity metrics, and trade flow imbalances in real-time.

================================================================================
ORDER FLOW DASHBOARD CONFIGURATION
================================================================================

{
  "dashboard": {
    "uid": "hft-orderflow",
    "title": "Order Flow & Book Visualization",
    "tags": ["orderflow", "orderbook", "liquidity", "microstructure"],
    "timezone": "UTC",
    "refresh": "100ms",
    "time": {
      "from": "now-5m",
      "to": "now"
    },
    "variables": [
      {
        "name": "symbol",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(hft_orderbook_depth, symbol)",
        "multi": false,
        "includeAll": false,
        "current": {
          "selected": true,
          "text": "BTC-USD",
          "value": "BTC-USD"
        }
      },
      {
        "name": "exchange",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(hft_orderbook_depth{symbol=\"$symbol\"}, exchange)",
        "multi": false,
        "includeAll": false
      },
      {
        "name": "depth_levels",
        "type": "custom",
        "query": "5,10,20,50,100",
        "current": {
          "value": "20"
        }
      }
    ]
  }
}

================================================================================
PANEL 1: REAL-TIME ORDER BOOK DEPTH (BID/ASK)
================================================================================

{
  "id": 201,
  "gridPos": {"h": 12, "w": 12, "x": 0, "y": 0},
  "type": "bargauge",
  "title": "Order Book Depth - $symbol",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_orderbook_bid_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-9]+\"} * -1",
      "legendFormat": "Bid L{{level}}",
      "refId": "A",
      "instant": true
    },
    {
      "expr": "hft_orderbook_ask_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-9]+\"}",
      "legendFormat": "Ask L{{level}}",
      "refId": "B",
      "instant": true
    }
  ],
  "fieldConfig": {
    "defaults": {
      "unit": "short",
      "decimals": 4,
      "min": -1000,
      "max": 1000,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "green"},
          {"value": 0, "color": "red"}
        ]
      },
      "color": {
        "mode": "thresholds"
      }
    },
    "overrides": [
      {
        "matcher": {"id": "byRegexp", "options": "Bid.*"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "green"}}
        ]
      },
      {
        "matcher": {"id": "byRegexp", "options": "Ask.*"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "red"}}
        ]
      }
    ]
  },
  "options": {
    "orientation": "horizontal",
    "displayMode": "gradient",
    "showUnfilled": true,
    "text": {
      "titleSize": 12,
      "valueSize": 14
    }
  },
  "transformations": [
    {
      "id": "sortBy",
      "options": {
        "sort": [{"field": "level", "desc": false}]
      }
    },
    {
      "id": "limit",
      "options": {
        "limitField": "$depth_levels"
      }
    }
  ]
}

================================================================================
PANEL 2: ORDER BOOK PRICE LEVELS (TABLE)
================================================================================

{
  "id": 202,
  "gridPos": {"h": 12, "w": 12, "x": 12, "y": 0},
  "type": "table",
  "title": "Order Book Levels - $symbol",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_orderbook_bid_price{symbol=\"$symbol\", exchange=\"$exchange\"}",
      "format": "table",
      "instant": true,
      "refId": "A"
    },
    {
      "expr": "hft_orderbook_bid_volume{symbol=\"$symbol\", exchange=\"$exchange\"}",
      "format": "table",
      "instant": true,
      "refId": "B"
    },
    {
      "expr": "hft_orderbook_ask_price{symbol=\"$symbol\", exchange=\"$exchange\"}",
      "format": "table",
      "instant": true,
      "refId": "C"
    },
    {
      "expr": "hft_orderbook_ask_volume{symbol=\"$symbol\", exchange=\"$exchange\"}",
      "format": "table",
      "instant": true,
      "refId": "D"
    }
  ],
  "transformations": [
    {
      "id": "merge",
      "options": {}
    },
    {
      "id": "organize",
      "options": {
        "excludeByName": {
          "Time": true,
          "__name__": true,
          "symbol": true,
          "exchange": true
        },
        "renameByPattern": {
          "Value #A": "Bid Price",
          "Value #B": "Bid Volume",
          "Value #C": "Ask Price",
          "Value #D": "Ask Volume",
          "level": "Level"
        },
        "indexByName": {
          "Level": 0,
          "Bid Volume": 1,
          "Bid Price": 2,
          "Ask Price": 3,
          "Ask Volume": 4
        }
      }
    },
    {
      "id": "sortBy",
      "options": {
        "sort": [{"field": "Level", "desc": false}]
      }
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "align": "center",
        "displayMode": "auto"
      }
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "Bid Price"},
        "properties": [
          {"id": "decimals", "value": 2},
          {"id": "custom.width", "value": 120},
          {
            "id": "custom.displayMode",
            "value": "color-background"
          },
          {
            "id": "color",
            "value": {"mode": "fixed", "fixedColor": "green"}
          }
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Ask Price"},
        "properties": [
          {"id": "decimals", "value": 2},
          {"id": "custom.width", "value": 120},
          {
            "id": "custom.displayMode",
            "value": "color-background"
          },
          {
            "id": "color",
            "value": {"mode": "fixed", "fixedColor": "red"}
          }
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Bid Volume"},
        "properties": [
          {"id": "decimals", "value": 4},
          {"id": "custom.displayMode", "value": "gradient-gauge"},
          {"id": "min", "value": 0},
          {"id": "max", "value": 100}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Ask Volume"},
        "properties": [
          {"id": "decimals", "value": 4},
          {"id": "custom.displayMode", "value": "gradient-gauge"},
          {"id": "min", "value": 0},
          {"id": "max", "value": 100}
        ]
      }
    ]
  }
}

================================================================================
PANEL 3: ORDER FLOW IMBALANCE
================================================================================

{
  "id": 203,
  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
  "type": "timeseries",
  "title": "Order Flow Imbalance (OFI)",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "(sum(hft_orderbook_bid_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-4]\"}) - sum(hft_orderbook_ask_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-4]\"})) / (sum(hft_orderbook_bid_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-4]\"}) + sum(hft_orderbook_ask_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-4]\"}))",
      "legendFormat": "OFI (Top 5 levels)",
      "refId": "A"
    },
    {
      "expr": "(sum(hft_orderbook_bid_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-9]\"}) - sum(hft_orderbook_ask_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-9]\"})) / (sum(hft_orderbook_bid_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-9]\"}) + sum(hft_orderbook_ask_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-9]\"}))",
      "legendFormat": "OFI (Top 10 levels)",
      "refId": "B"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineInterpolation": "smooth",
        "lineWidth": 2,
        "fillOpacity": 25,
        "gradientMode": "hue",
        "showPoints": "never"
      },
      "unit": "percentunit",
      "decimals": 3,
      "min": -1,
      "max": 1,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": -1, "color": "red"},
          {"value": -0.2, "color": "yellow"},
          {"value": 0.2, "color": "green"}
        ]
      }
    }
  },
  "options": {
    "tooltip": {
      "mode": "multi"
    },
    "legend": {
      "displayMode": "list",
      "placement": "bottom"
    }
  }
}

================================================================================
PANEL 4: BID-ASK SPREAD
================================================================================

{
  "id": 204,
  "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
  "type": "timeseries",
  "title": "Bid-Ask Spread (Absolute & Basis Points)",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_orderbook_ask_price{symbol=\"$symbol\", exchange=\"$exchange\", level=\"0\"} - hft_orderbook_bid_price{symbol=\"$symbol\", exchange=\"$exchange\", level=\"0\"}",
      "legendFormat": "Spread (Absolute)",
      "refId": "A"
    },
    {
      "expr": "(hft_orderbook_ask_price{symbol=\"$symbol\", exchange=\"$exchange\", level=\"0\"} - hft_orderbook_bid_price{symbol=\"$symbol\", exchange=\"$exchange\", level=\"0\"}) / ((hft_orderbook_ask_price{symbol=\"$symbol\", exchange=\"$exchange\", level=\"0\"} + hft_orderbook_bid_price{symbol=\"$symbol\", exchange=\"$exchange\", level=\"0\"}) / 2) * 10000",
      "legendFormat": "Spread (bps)",
      "refId": "B"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 20
      },
      "decimals": 2
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "Spread (Absolute)"},
        "properties": [
          {"id": "unit", "value": "currencyUSD"},
          {"id": "custom.axisPlacement", "value": "left"},
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "blue"}}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Spread (bps)"},
        "properties": [
          {"id": "unit", "value": "bps"},
          {"id": "custom.axisPlacement", "value": "right"},
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "orange"}}
        ]
      }
    ]
  }
}

================================================================================
PANEL 5: TRADE FLOW DIRECTION (AGGRESSOR SIDE)
================================================================================

{
  "id": 205,
  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 20},
  "type": "timeseries",
  "title": "Trade Flow by Aggressor Side",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "sum(rate(hft_trades_volume{symbol=\"$symbol\", exchange=\"$exchange\", aggressor_side=\"buy\"}[10s])) * 10",
      "legendFormat": "Buy Volume/sec",
      "refId": "A"
    },
    {
      "expr": "sum(rate(hft_trades_volume{symbol=\"$symbol\", exchange=\"$exchange\", aggressor_side=\"sell\"}[10s])) * 10 * -1",
      "legendFormat": "Sell Volume/sec",
      "refId": "B"
    },
    {
      "expr": "sum(rate(hft_trades_count{symbol=\"$symbol\", exchange=\"$exchange\", aggressor_side=\"buy\"}[10s])) * 10",
      "legendFormat": "Buy Count/sec",
      "refId": "C"
    },
    {
      "expr": "sum(rate(hft_trades_count{symbol=\"$symbol\", exchange=\"$exchange\", aggressor_side=\"sell\"}[10s])) * 10 * -1",
      "legendFormat": "Sell Count/sec",
      "refId": "D"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "bars",
        "lineWidth": 0,
        "fillOpacity": 80,
        "barAlignment": 0,
        "stacking": {
          "mode": "normal",
          "group": "A"
        }
      },
      "decimals": 2
    },
    "overrides": [
      {
        "matcher": {"id": "byRegexp", "options": "Buy.*"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "green"}}
        ]
      },
      {
        "matcher": {"id": "byRegexp", "options": "Sell.*"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "red"}}
        ]
      },
      {
        "matcher": {"id": "byRegexp", "options": ".*Volume.*"},
        "properties": [
          {"id": "custom.axisPlacement", "value": "left"}
        ]
      },
      {
        "matcher": {"id": "byRegexp", "options": ".*Count.*"},
        "properties": [
          {"id": "custom.axisPlacement", "value": "right"}
        ]
      }
    ]
  }
}

================================================================================
PANEL 6: VOLUME-WEIGHTED AVERAGE PRICE (VWAP)
================================================================================

{
  "id": 206,
  "gridPos": {"h": 8, "w": 12, "x": 12, "y": 20},
  "type": "timeseries",
  "title": "VWAP Analysis",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_vwap_price{symbol=\"$symbol\", exchange=\"$exchange\"}",
      "legendFormat": "VWAP",
      "refId": "A"
    },
    {
      "expr": "hft_last_trade_price{symbol=\"$symbol\", exchange=\"$exchange\"}",
      "legendFormat": "Last Price",
      "refId": "B"
    },
    {
      "expr": "(hft_last_trade_price{symbol=\"$symbol\", exchange=\"$exchange\"} - hft_vwap_price{symbol=\"$symbol\", exchange=\"$exchange\"}) / hft_vwap_price{symbol=\"$symbol\", exchange=\"$exchange\"} * 10000",
      "legendFormat": "Distance from VWAP (bps)",
      "refId": "C"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 10
      },
      "decimals": 2
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "VWAP"},
        "properties": [
          {"id": "unit", "value": "currencyUSD"},
          {"id": "custom.lineWidth", "value": 3},
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "purple"}},
          {"id": "custom.axisPlacement", "value": "left"}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Last Price"},
        "properties": [
          {"id": "unit", "value": "currencyUSD"},
          {"id": "custom.lineStyle", "value": {"fill": "dot"}},
          {"id": "custom.axisPlacement", "value": "left"}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Distance from VWAP (bps)"},
        "properties": [
          {"id": "unit", "value": "bps"},
          {"id": "custom.axisPlacement", "value": "right"},
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "orange"}}
        ]
      }
    ]
  }
}

================================================================================
PANEL 7: LIQUIDITY HEATMAP
================================================================================

{
  "id": 207,
  "gridPos": {"h": 10, "w": 24, "x": 0, "y": 28},
  "type": "heatmap",
  "title": "Order Book Liquidity Heatmap",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_orderbook_bid_volume{symbol=\"$symbol\", exchange=\"$exchange\"}",
      "legendFormat": "{{level}}",
      "refId": "A"
    },
    {
      "expr": "hft_orderbook_ask_volume{symbol=\"$symbol\", exchange=\"$exchange\"}",
      "legendFormat": "{{level}}",
      "refId": "B"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "hideFrom": {
          "tooltip": false,
          "viz": false,
          "legend": false
        }
      }
    }
  },
  "options": {
    "calculate": false,
    "color": {
      "mode": "scheme",
      "scheme": "Spectral",
      "steps": 64,
      "exponent": 0.5,
      "fill": "#000000"
    },
    "yAxis": {
      "unit": "short",
      "decimals": 0,
      "reverse": false
    },
    "cellGap": 1,
    "cellValues": {
      "unit": "short",
      "decimals": 2
    },
    "tooltip": {
      "show": true,
      "yHistogram": false
    },
    "legend": {
      "show": true
    }
  }
}

================================================================================
PANEL 8: MARKET DEPTH CHART
================================================================================

{
  "id": 208,
  "gridPos": {"h": 10, "w": 12, "x": 0, "y": 38},
  "type": "timeseries",
  "title": "Cumulative Market Depth",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "sum(hft_orderbook_bid_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-4]\"}) by (timestamp)",
      "legendFormat": "Bid Depth (L0-4)",
      "refId": "A"
    },
    {
      "expr": "sum(hft_orderbook_bid_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-9]\"}) by (timestamp)",
      "legendFormat": "Bid Depth (L0-9)",
      "refId": "B"
    },
    {
      "expr": "sum(hft_orderbook_bid_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-1][0-9]\"}) by (timestamp)",
      "legendFormat": "Bid Depth (L0-19)",
      "refId": "C"
    },
    {
      "expr": "sum(hft_orderbook_ask_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-4]\"}) by (timestamp)",
      "legendFormat": "Ask Depth (L0-4)",
      "refId": "D"
    },
    {
      "expr": "sum(hft_orderbook_ask_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-9]\"}) by (timestamp)",
      "legendFormat": "Ask Depth (L0-9)",
      "refId": "E"
    },
    {
      "expr": "sum(hft_orderbook_ask_volume{symbol=\"$symbol\", exchange=\"$exchange\", level=~\"[0-1][0-9]\"}) by (timestamp)",
      "legendFormat": "Ask Depth (L0-19)",
      "refId": "F"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 20,
        "gradientMode": "none"
      },
      "unit": "short",
      "decimals": 2
    },
    "overrides": [
      {
        "matcher": {"id": "byRegexp", "options": "Bid.*"},
        "properties": [
          {"id": "color", "value": {"mode": "palette-classic"}}
        ]
      },
      {
        "matcher": {"id": "byRegexp", "options": "Ask.*"},
        "properties": [
          {"id": "color", "value": {"mode": "palette-classic"}}
        ]
      }
    ]
  }
}

================================================================================
PANEL 9: TRADE SIZE DISTRIBUTION
================================================================================

{
  "id": 209,
  "gridPos": {"h": 10, "w": 12, "x": 12, "y": 38},
  "type": "histogram",
  "title": "Trade Size Distribution",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_trade_size_usd{symbol=\"$symbol\", exchange=\"$exchange\"}",
      "legendFormat": "Trade Size",
      "refId": "A"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "fillOpacity": 80,
        "lineWidth": 1
      },
      "unit": "currencyUSD",
      "decimals": 0
    }
  },
  "options": {
    "bucketOffset": 0,
    "bucketSize": 1000,
    "legend": {
      "displayMode": "list",
      "placement": "bottom",
      "calcs": ["mean", "max"]
    }
  }
}

================================================================================
SQL QUERIES FOR ORDER FLOW ANALYSIS
================================================================================

-- Query 1: Order Book Snapshot
SELECT
    timestamp,
    symbol,
    exchange,
    level,
    bid_price,
    bid_volume,
    ask_price,
    ask_volume,
    bid_price * bid_volume AS bid_notional,
    ask_price * ask_volume AS ask_notional
FROM orderbook_snapshots
WHERE symbol = $symbol
    AND exchange = $exchange
    AND timestamp >= NOW() - INTERVAL '5 minutes'
    AND level < 20
ORDER BY timestamp DESC, level ASC
LIMIT 1000;

-- Query 2: Order Flow Imbalance Over Time
SELECT
    time_bucket('1 second', timestamp) AS bucket,
    symbol,
    SUM(CASE WHEN side = 'bid' THEN volume ELSE 0 END) AS bid_volume,
    SUM(CASE WHEN side = 'ask' THEN volume ELSE 0 END) AS ask_volume,
    (SUM(CASE WHEN side = 'bid' THEN volume ELSE 0 END) - SUM(CASE WHEN side = 'ask' THEN volume ELSE 0 END)) /
    (SUM(CASE WHEN side = 'bid' THEN volume ELSE 0 END) + SUM(CASE WHEN side = 'ask' THEN volume ELSE 0 END)) AS ofi,
    SUM(CASE WHEN side = 'bid' THEN volume * price ELSE 0 END) AS bid_notional,
    SUM(CASE WHEN side = 'ask' THEN volume * price ELSE 0 END) AS ask_notional
FROM orderbook_updates
WHERE symbol = $symbol
    AND timestamp >= NOW() - INTERVAL '1 hour'
GROUP BY bucket, symbol
ORDER BY bucket DESC;

-- Query 3: Aggressive vs Passive Order Flow
SELECT
    time_bucket('1 second', timestamp) AS bucket,
    symbol,
    aggressor_side,
    COUNT(*) AS trade_count,
    SUM(volume) AS total_volume,
    SUM(volume * price) AS total_notional,
    AVG(price) AS avg_price,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY volume) AS median_volume,
    MAX(volume) AS max_trade_size,
    MIN(volume) AS min_trade_size
FROM trades
WHERE symbol = $symbol
    AND timestamp >= NOW() - INTERVAL '30 minutes'
GROUP BY bucket, symbol, aggressor_side
ORDER BY bucket DESC, aggressor_side;

-- Query 4: Spread Analysis
SELECT
    time_bucket('100 milliseconds', timestamp) AS bucket,
    symbol,
    AVG(ask_price_0 - bid_price_0) AS avg_spread,
    MIN(ask_price_0 - bid_price_0) AS min_spread,
    MAX(ask_price_0 - bid_price_0) AS max_spread,
    AVG((ask_price_0 - bid_price_0) / ((ask_price_0 + bid_price_0) / 2) * 10000) AS avg_spread_bps,
    STDDEV(ask_price_0 - bid_price_0) AS spread_volatility
FROM orderbook_snapshots
WHERE symbol = $symbol
    AND timestamp >= NOW() - INTERVAL '15 minutes'
GROUP BY bucket, symbol
ORDER BY bucket DESC;

-- Query 5: Liquidity Depth Over Time
SELECT
    time_bucket('1 second', timestamp) AS bucket,
    symbol,
    SUM(CASE WHEN level < 5 THEN bid_volume ELSE 0 END) AS bid_depth_5,
    SUM(CASE WHEN level < 10 THEN bid_volume ELSE 0 END) AS bid_depth_10,
    SUM(CASE WHEN level < 20 THEN bid_volume ELSE 0 END) AS bid_depth_20,
    SUM(CASE WHEN level < 5 THEN ask_volume ELSE 0 END) AS ask_depth_5,
    SUM(CASE WHEN level < 10 THEN ask_volume ELSE 0 END) AS ask_depth_10,
    SUM(CASE WHEN level < 20 THEN ask_volume ELSE 0 END) AS ask_depth_20
FROM orderbook_snapshots
WHERE symbol = $symbol
    AND timestamp >= NOW() - INTERVAL '10 minutes'
GROUP BY bucket, symbol
ORDER BY bucket DESC;

-- Query 6: Price Impact Analysis
WITH depth_before AS (
    SELECT
        timestamp,
        symbol,
        SUM(CASE WHEN side = 'bid' THEN volume ELSE 0 END) AS total_bid_depth,
        SUM(CASE WHEN side = 'ask' THEN volume ELSE 0 END) AS total_ask_depth
    FROM orderbook_snapshots
    WHERE symbol = $symbol
    GROUP BY timestamp, symbol
),
large_trades AS (
    SELECT
        timestamp,
        symbol,
        aggressor_side,
        volume,
        price,
        volume * price AS notional
    FROM trades
    WHERE symbol = $symbol
        AND volume * price > 10000
)
SELECT
    lt.timestamp,
    lt.symbol,
    lt.aggressor_side,
    lt.volume,
    lt.notional,
    db.total_bid_depth,
    db.total_ask_depth,
    CASE
        WHEN lt.aggressor_side = 'buy' THEN lt.notional / db.total_ask_depth
        ELSE lt.notional / db.total_bid_depth
    END AS relative_impact
FROM large_trades lt
LEFT JOIN depth_before db ON
    lt.symbol = db.symbol AND
    db.timestamp <= lt.timestamp
ORDER BY lt.timestamp DESC
LIMIT 100;

================================================================================
PROMETHEUS QUERIES FOR ORDER FLOW MONITORING
================================================================================

# Order Book Imbalance (Top of Book)
(hft_orderbook_bid_volume{level="0"} - hft_orderbook_ask_volume{level="0"}) /
(hft_orderbook_bid_volume{level="0"} + hft_orderbook_ask_volume{level="0"})

# Microprice (probability-weighted mid)
(hft_orderbook_bid_price{level="0"} * hft_orderbook_ask_volume{level="0"} +
 hft_orderbook_ask_price{level="0"} * hft_orderbook_bid_volume{level="0"}) /
(hft_orderbook_bid_volume{level="0"} + hft_orderbook_ask_volume{level="0"})

# Trade Arrival Rate
rate(hft_trades_count[10s]) * 10

# Average Trade Size
rate(hft_trades_volume[1m]) / rate(hft_trades_count[1m])

# Buy/Sell Imbalance
(rate(hft_trades_volume{aggressor_side="buy"}[1m]) -
 rate(hft_trades_volume{aggressor_side="sell"}[1m])) /
(rate(hft_trades_volume{aggressor_side="buy"}[1m]) +
 rate(hft_trades_volume{aggressor_side="sell"}[1m]))

# Effective Spread
avg_over_time(hft_effective_spread_bps[1m])

# Realized Spread
avg_over_time(hft_realized_spread_bps[1m])

# Quote Intensity (updates per second)
rate(hft_orderbook_updates_total[10s]) * 10

# Trade-to-Quote Ratio
rate(hft_trades_count[1m]) / rate(hft_orderbook_updates_total[1m])

# Depth at Best (in USD)
hft_orderbook_bid_volume{level="0"} * hft_orderbook_bid_price{level="0"} +
hft_orderbook_ask_volume{level="0"} * hft_orderbook_ask_price{level="0"}

================================================================================
WEBSOCKET DATA STREAMING IMPLEMENTATION
================================================================================

/* TypeScript WebSocket Client for Real-Time Order Flow */

interface OrderBookLevel {
    price: number;
    volume: number;
    orders: number;
}

interface OrderBookSnapshot {
    symbol: string;
    exchange: string;
    timestamp: number;
    bids: OrderBookLevel[];
    asks: OrderBookLevel[];
    sequence: number;
}

interface Trade {
    symbol: string;
    exchange: string;
    timestamp: number;
    price: number;
    volume: number;
    side: 'buy' | 'sell';
    aggressor_side: 'buy' | 'sell';
}

class OrderFlowStream {
    private ws: WebSocket;
    private orderbook: Map<string, OrderBookSnapshot>;
    private callbacks: Map<string, Function[]>;

    constructor(url: string) {
        this.ws = new WebSocket(url);
        this.orderbook = new Map();
        this.callbacks = new Map();
        this.setupHandlers();
    }

    private setupHandlers(): void {
        this.ws.onopen = () => {
            console.log('Order flow stream connected');
            this.subscribe(['orderbook', 'trades', 'quotes']);
        };

        this.ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            this.handleMessage(message);
        };

        this.ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        this.ws.onclose = () => {
            console.log('WebSocket closed, reconnecting...');
            setTimeout(() => this.reconnect(), 1000);
        };
    }

    private subscribe(channels: string[]): void {
        const message = {
            type: 'subscribe',
            channels: channels,
            symbols: ['BTC-USD', 'ETH-USD'],
            exchanges: ['COINBASE', 'BINANCE']
        };
        this.ws.send(JSON.stringify(message));
    }

    private handleMessage(message: any): void {
        switch (message.type) {
            case 'orderbook_snapshot':
                this.handleOrderBookSnapshot(message.data);
                break;
            case 'orderbook_update':
                this.handleOrderBookUpdate(message.data);
                break;
            case 'trade':
                this.handleTrade(message.data);
                break;
            case 'quote':
                this.handleQuote(message.data);
                break;
        }
    }

    private handleOrderBookSnapshot(data: OrderBookSnapshot): void {
        const key = `${data.symbol}-${data.exchange}`;
        this.orderbook.set(key, data);
        this.emit('orderbook', data);
    }

    private handleOrderBookUpdate(data: any): void {
        const key = `${data.symbol}-${data.exchange}`;
        const book = this.orderbook.get(key);

        if (book && data.sequence === book.sequence + 1) {
            // Apply incremental update
            this.applyUpdate(book, data);
            book.sequence = data.sequence;
            this.emit('orderbook', book);
        } else {
            // Request snapshot if sequence mismatch
            this.requestSnapshot(data.symbol, data.exchange);
        }
    }

    private applyUpdate(book: OrderBookSnapshot, update: any): void {
        // Update bids
        for (const [price, volume] of Object.entries(update.bids)) {
            const priceNum = parseFloat(price);
            const volNum = volume as number;

            if (volNum === 0) {
                book.bids = book.bids.filter(l => l.price !== priceNum);
            } else {
                const existing = book.bids.find(l => l.price === priceNum);
                if (existing) {
                    existing.volume = volNum;
                } else {
                    book.bids.push({price: priceNum, volume: volNum, orders: 1});
                    book.bids.sort((a, b) => b.price - a.price);
                }
            }
        }

        // Update asks
        for (const [price, volume] of Object.entries(update.asks)) {
            const priceNum = parseFloat(price);
            const volNum = volume as number;

            if (volNum === 0) {
                book.asks = book.asks.filter(l => l.price !== priceNum);
            } else {
                const existing = book.asks.find(l => l.price === priceNum);
                if (existing) {
                    existing.volume = volNum;
                } else {
                    book.asks.push({price: priceNum, volume: volNum, orders: 1});
                    book.asks.sort((a, b) => a.price - b.price);
                }
            }
        }
    }

    private handleTrade(data: Trade): void {
        this.emit('trade', data);
    }

    private handleQuote(data: any): void {
        this.emit('quote', data);
    }

    public on(event: string, callback: Function): void {
        if (!this.callbacks.has(event)) {
            this.callbacks.set(event, []);
        }
        this.callbacks.get(event)!.push(callback);
    }

    private emit(event: string, data: any): void {
        const callbacks = this.callbacks.get(event);
        if (callbacks) {
            callbacks.forEach(cb => cb(data));
        }
    }

    private requestSnapshot(symbol: string, exchange: string): void {
        this.ws.send(JSON.stringify({
            type: 'request_snapshot',
            symbol: symbol,
            exchange: exchange
        }));
    }

    private reconnect(): void {
        this.ws = new WebSocket(this.ws.url);
        this.setupHandlers();
    }

    public close(): void {
        this.ws.close();
    }
}

// Usage Example
const stream = new OrderFlowStream('wss://hft-system.example.com/orderflow');

stream.on('orderbook', (book: OrderBookSnapshot) => {
    updateOrderBookVisualization(book);
    calculateOrderFlowImbalance(book);
});

stream.on('trade', (trade: Trade) => {
    updateTradeFlow(trade);
    calculateVWAP(trade);
});

================================================================================
END OF ORDER FLOW VISUALIZATION DASHBOARD
================================================================================
