================================================================================
SYSTEM HEALTH DASHBOARD - HFT TRADING SYSTEM
Infrastructure Monitoring, Performance Metrics, and System Diagnostics
================================================================================

OVERVIEW
--------
Comprehensive system health monitoring for HFT infrastructure including CPU,
memory, network, disk I/O, service health, and performance bottleneck detection.

================================================================================
SYSTEM HEALTH DASHBOARD CONFIGURATION
================================================================================

{
  "dashboard": {
    "uid": "hft-system-health",
    "title": "System Health & Performance",
    "tags": ["system", "infrastructure", "performance", "health"],
    "timezone": "UTC",
    "refresh": "5s",
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "variables": [
      {
        "name": "instance",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(node_uname_info, instance)",
        "multi": true,
        "includeAll": true
      },
      {
        "name": "service",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(up, job)",
        "multi": true,
        "includeAll": true
      },
      {
        "name": "interval",
        "type": "custom",
        "query": "1s,5s,10s,30s,1m",
        "current": {"value": "5s"}
      }
    ]
  }
}

================================================================================
PANEL 1: SERVICE STATUS OVERVIEW
================================================================================

{
  "id": 401,
  "gridPos": {"h": 6, "w": 24, "x": 0, "y": 0},
  "type": "stat",
  "title": "Service Health Status",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "up{job=~\"$service\"}",
      "legendFormat": "{{job}} - {{instance}}",
      "refId": "A",
      "instant": true
    }
  ],
  "fieldConfig": {
    "defaults": {
      "mappings": [
        {
          "type": "value",
          "options": {
            "0": {"text": "DOWN", "color": "red"},
            "1": {"text": "UP", "color": "green"}
          }
        }
      ],
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "red"},
          {"value": 1, "color": "green"}
        ]
      },
      "noValue": "UNKNOWN"
    }
  },
  "options": {
    "graphMode": "none",
    "colorMode": "background",
    "orientation": "horizontal",
    "textMode": "value_and_name",
    "justifyMode": "center"
  }
}

================================================================================
PANEL 2: CPU USAGE BY CORE
================================================================================

{
  "id": 402,
  "gridPos": {"h": 10, "w": 12, "x": 0, "y": 6},
  "type": "timeseries",
  "title": "CPU Usage by Core (%)",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "100 - (avg by (instance, cpu) (irate(node_cpu_seconds_total{mode=\"idle\", instance=~\"$instance\"}[$interval])) * 100)",
      "legendFormat": "{{instance}} - CPU{{cpu}}",
      "refId": "A"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineInterpolation": "smooth",
        "lineWidth": 1,
        "fillOpacity": 20,
        "gradientMode": "opacity",
        "showPoints": "never"
      },
      "unit": "percent",
      "min": 0,
      "max": 100,
      "decimals": 1,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "green"},
          {"value": 70, "color": "yellow"},
          {"value": 85, "color": "red"}
        ]
      }
    }
  },
  "options": {
    "tooltip": {
      "mode": "multi",
      "sort": "desc"
    },
    "legend": {
      "displayMode": "list",
      "placement": "bottom",
      "calcs": ["mean", "max"]
    }
  }
}

================================================================================
PANEL 3: MEMORY USAGE
================================================================================

{
  "id": 403,
  "gridPos": {"h": 10, "w": 12, "x": 12, "y": 6},
  "type": "timeseries",
  "title": "Memory Usage",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "node_memory_MemTotal_bytes{instance=~\"$instance\"} - node_memory_MemAvailable_bytes{instance=~\"$instance\"}",
      "legendFormat": "{{instance}} - Used",
      "refId": "A"
    },
    {
      "expr": "node_memory_Cached_bytes{instance=~\"$instance\"}",
      "legendFormat": "{{instance}} - Cached",
      "refId": "B"
    },
    {
      "expr": "node_memory_Buffers_bytes{instance=~\"$instance\"}",
      "legendFormat": "{{instance}} - Buffers",
      "refId": "C"
    },
    {
      "expr": "node_memory_MemAvailable_bytes{instance=~\"$instance\"}",
      "legendFormat": "{{instance}} - Available",
      "refId": "D"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 30,
        "stacking": {
          "mode": "normal",
          "group": "A"
        }
      },
      "unit": "bytes",
      "decimals": 0,
      "color": {
        "mode": "palette-classic"
      }
    }
  },
  "options": {
    "tooltip": {
      "mode": "multi"
    },
    "legend": {
      "displayMode": "table",
      "placement": "bottom",
      "calcs": ["lastNotNull", "max"]
    }
  }
}

================================================================================
PANEL 4: NETWORK THROUGHPUT
================================================================================

{
  "id": 404,
  "gridPos": {"h": 10, "w": 12, "x": 0, "y": 16},
  "type": "timeseries",
  "title": "Network Throughput",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "rate(node_network_receive_bytes_total{instance=~\"$instance\", device!=\"lo\"}[$interval])",
      "legendFormat": "{{instance}} {{device}} - RX",
      "refId": "A"
    },
    {
      "expr": "rate(node_network_transmit_bytes_total{instance=~\"$instance\", device!=\"lo\"}[$interval]) * -1",
      "legendFormat": "{{instance}} {{device}} - TX",
      "refId": "B"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 40
      },
      "unit": "Bps",
      "decimals": 0,
      "color": {
        "mode": "palette-classic"
      }
    },
    "overrides": [
      {
        "matcher": {"id": "byRegexp", "options": ".*RX"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "green"}}
        ]
      },
      {
        "matcher": {"id": "byRegexp", "options": ".*TX"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "blue"}}
        ]
      }
    ]
  }
}

================================================================================
PANEL 5: DISK I/O
================================================================================

{
  "id": 405,
  "gridPos": {"h": 10, "w": 12, "x": 12, "y": 16},
  "type": "timeseries",
  "title": "Disk I/O Operations",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "rate(node_disk_reads_completed_total{instance=~\"$instance\"}[$interval])",
      "legendFormat": "{{instance}} {{device}} - Reads/s",
      "refId": "A"
    },
    {
      "expr": "rate(node_disk_writes_completed_total{instance=~\"$instance\"}[$interval]) * -1",
      "legendFormat": "{{instance}} {{device}} - Writes/s",
      "refId": "B"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 30
      },
      "unit": "iops",
      "decimals": 0
    },
    "overrides": [
      {
        "matcher": {"id": "byRegexp", "options": ".*Reads.*"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "blue"}}
        ]
      },
      {
        "matcher": {"id": "byRegexp", "options": ".*Writes.*"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "purple"}}
        ]
      }
    ]
  }
}

================================================================================
PANEL 6: DISK LATENCY
================================================================================

{
  "id": 406,
  "gridPos": {"h": 10, "w": 12, "x": 0, "y": 26},
  "type": "timeseries",
  "title": "Disk I/O Latency",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "rate(node_disk_read_time_seconds_total{instance=~\"$instance\"}[$interval]) / rate(node_disk_reads_completed_total{instance=~\"$instance\"}[$interval]) * 1000",
      "legendFormat": "{{instance}} {{device}} - Read Latency",
      "refId": "A"
    },
    {
      "expr": "rate(node_disk_write_time_seconds_total{instance=~\"$instance\"}[$interval]) / rate(node_disk_writes_completed_total{instance=~\"$instance\"}[$interval]) * 1000",
      "legendFormat": "{{instance}} {{device}} - Write Latency",
      "refId": "B"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 20
      },
      "unit": "ms",
      "decimals": 2,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "green"},
          {"value": 10, "color": "yellow"},
          {"value": 50, "color": "red"}
        ]
      }
    }
  }
}

================================================================================
PANEL 7: DISK SPACE USAGE
================================================================================

{
  "id": 407,
  "gridPos": {"h": 10, "w": 12, "x": 12, "y": 26},
  "type": "bargauge",
  "title": "Disk Space Usage",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "(1 - (node_filesystem_avail_bytes{instance=~\"$instance\", fstype!=\"tmpfs\"} / node_filesystem_size_bytes{instance=~\"$instance\", fstype!=\"tmpfs\"})) * 100",
      "legendFormat": "{{instance}} {{mountpoint}}",
      "refId": "A",
      "instant": true
    }
  ],
  "fieldConfig": {
    "defaults": {
      "unit": "percent",
      "min": 0,
      "max": 100,
      "decimals": 1,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "green"},
          {"value": 70, "color": "yellow"},
          {"value": 85, "color": "orange"},
          {"value": 95, "color": "red"}
        ]
      }
    }
  },
  "options": {
    "orientation": "horizontal",
    "displayMode": "gradient",
    "showUnfilled": true
  }
}

================================================================================
PANEL 8: PROCESS MONITORING
================================================================================

{
  "id": 408,
  "gridPos": {"h": 10, "w": 12, "x": 0, "y": 36},
  "type": "table",
  "title": "Top Processes by CPU",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "topk(10, rate(process_cpu_seconds_total{instance=~\"$instance\"}[$interval]) * 100)",
      "format": "table",
      "instant": true,
      "refId": "A"
    },
    {
      "expr": "topk(10, process_resident_memory_bytes{instance=~\"$instance\"})",
      "format": "table",
      "instant": true,
      "refId": "B"
    },
    {
      "expr": "topk(10, process_open_fds{instance=~\"$instance\"})",
      "format": "table",
      "instant": true,
      "refId": "C"
    }
  ],
  "transformations": [
    {
      "id": "merge",
      "options": {}
    },
    {
      "id": "organize",
      "options": {
        "excludeByName": {
          "Time": true,
          "__name__": true
        },
        "renameByPattern": {
          "instance": "Instance",
          "job": "Service",
          "Value #A": "CPU %",
          "Value #B": "Memory",
          "Value #C": "Open FDs"
        }
      }
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "align": "center",
        "displayMode": "auto"
      }
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "CPU %"},
        "properties": [
          {"id": "unit", "value": "percent"},
          {"id": "decimals", "value": 2},
          {"id": "custom.displayMode", "value": "gradient-gauge"}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Memory"},
        "properties": [
          {"id": "unit", "value": "bytes"},
          {"id": "decimals", "value": 0},
          {"id": "custom.displayMode", "value": "gradient-gauge"}
        ]
      }
    ]
  }
}

================================================================================
PANEL 9: CONTEXT SWITCHES AND INTERRUPTS
================================================================================

{
  "id": 409,
  "gridPos": {"h": 10, "w": 12, "x": 12, "y": 36},
  "type": "timeseries",
  "title": "Context Switches & Interrupts",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "rate(node_context_switches_total{instance=~\"$instance\"}[$interval])",
      "legendFormat": "{{instance}} - Context Switches/s",
      "refId": "A"
    },
    {
      "expr": "rate(node_intr_total{instance=~\"$instance\"}[$interval])",
      "legendFormat": "{{instance}} - Interrupts/s",
      "refId": "B"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 20
      },
      "unit": "ops",
      "decimals": 0
    }
  }
}

================================================================================
PANEL 10: TCP CONNECTION STATES
================================================================================

{
  "id": 410,
  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 46},
  "type": "timeseries",
  "title": "TCP Connection States",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "node_netstat_Tcp_CurrEstab{instance=~\"$instance\"}",
      "legendFormat": "{{instance}} - ESTABLISHED",
      "refId": "A"
    },
    {
      "expr": "node_sockstat_TCP_tw{instance=~\"$instance\"}",
      "legendFormat": "{{instance}} - TIME_WAIT",
      "refId": "B"
    },
    {
      "expr": "node_sockstat_TCP_alloc{instance=~\"$instance\"}",
      "legendFormat": "{{instance}} - TOTAL",
      "refId": "C"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 20
      },
      "unit": "short",
      "decimals": 0
    }
  }
}

================================================================================
PANEL 11: SYSTEM LOAD AVERAGE
================================================================================

{
  "id": 411,
  "gridPos": {"h": 8, "w": 12, "x": 12, "y": 46},
  "type": "timeseries",
  "title": "System Load Average",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "node_load1{instance=~\"$instance\"}",
      "legendFormat": "{{instance}} - 1m",
      "refId": "A"
    },
    {
      "expr": "node_load5{instance=~\"$instance\"}",
      "legendFormat": "{{instance}} - 5m",
      "refId": "B"
    },
    {
      "expr": "node_load15{instance=~\"$instance\"}",
      "legendFormat": "{{instance}} - 15m",
      "refId": "C"
    },
    {
      "expr": "count(count(node_cpu_seconds_total{instance=~\"$instance\"}) by (cpu)) by (instance)",
      "legendFormat": "{{instance}} - CPU Count",
      "refId": "D"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 15
      },
      "decimals": 2
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "CPU Count"},
        "properties": [
          {
            "id": "custom.lineStyle",
            "value": {"fill": "dash", "dash": [5, 5]}
          },
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "red"}}
        ]
      }
    ]
  }
}

================================================================================
PANEL 12: TRADING ENGINE SPECIFIC METRICS
================================================================================

{
  "id": 412,
  "gridPos": {"h": 10, "w": 24, "x": 0, "y": 54},
  "type": "timeseries",
  "title": "HFT Application Metrics",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "rate(hft_order_processing_total[$interval])",
      "legendFormat": "Orders Processed/s",
      "refId": "A"
    },
    {
      "expr": "rate(hft_market_data_messages_total[$interval])",
      "legendFormat": "Market Data Msgs/s",
      "refId": "B"
    },
    {
      "expr": "hft_order_queue_depth",
      "legendFormat": "Order Queue Depth",
      "refId": "C"
    },
    {
      "expr": "hft_market_data_queue_depth",
      "legendFormat": "Market Data Queue Depth",
      "refId": "D"
    },
    {
      "expr": "rate(hft_gc_duration_seconds_sum[$interval]) / rate(hft_gc_duration_seconds_count[$interval]) * 1000",
      "legendFormat": "Avg GC Pause (ms)",
      "refId": "E"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 20
      },
      "decimals": 0
    },
    "overrides": [
      {
        "matcher": {"id": "byRegexp", "options": ".*/s"},
        "properties": [
          {"id": "unit", "value": "ops"},
          {"id": "custom.axisPlacement", "value": "left"}
        ]
      },
      {
        "matcher": {"id": "byRegexp", "options": ".*Queue.*"},
        "properties": [
          {"id": "unit", "value": "short"},
          {"id": "custom.axisPlacement", "value": "right"}
        ]
      },
      {
        "matcher": {"id": "byRegexp", "options": ".*GC.*"},
        "properties": [
          {"id": "unit", "value": "ms"},
          {"id": "custom.axisPlacement", "value": "right"}
        ]
      }
    ]
  }
}

================================================================================
PANEL 13: THREAD POOL UTILIZATION
================================================================================

{
  "id": 413,
  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 64},
  "type": "gauge",
  "title": "Thread Pool Utilization",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_threadpool_active_threads / hft_threadpool_total_threads * 100",
      "legendFormat": "{{pool_name}}",
      "refId": "A"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "unit": "percent",
      "min": 0,
      "max": 100,
      "decimals": 1,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "green"},
          {"value": 60, "color": "yellow"},
          {"value": 80, "color": "orange"},
          {"value": 95, "color": "red"}
        ]
      }
    }
  },
  "options": {
    "orientation": "auto",
    "showThresholdLabels": true,
    "showThresholdMarkers": true
  }
}

================================================================================
PANEL 14: CACHE HIT RATES
================================================================================

{
  "id": 414,
  "gridPos": {"h": 8, "w": 12, "x": 12, "y": 64},
  "type": "timeseries",
  "title": "Cache Hit Rates",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "rate(hft_cache_hits_total[$interval]) / (rate(hft_cache_hits_total[$interval]) + rate(hft_cache_misses_total[$interval])) * 100",
      "legendFormat": "{{cache_name}} Hit Rate",
      "refId": "A"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 30
      },
      "unit": "percent",
      "min": 0,
      "max": 100,
      "decimals": 2,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "red"},
          {"value": 80, "color": "yellow"},
          {"value": 95, "color": "green"}
        ]
      }
    }
  }
}

================================================================================
SQL QUERIES FOR SYSTEM DIAGNOSTICS
================================================================================

-- Query 1: System Resource Usage Over Time
SELECT
    time_bucket('1 minute', timestamp) AS bucket,
    instance,
    AVG(cpu_usage_percent) AS avg_cpu,
    MAX(cpu_usage_percent) AS max_cpu,
    AVG(memory_usage_percent) AS avg_memory,
    MAX(memory_usage_percent) AS max_memory,
    AVG(disk_io_util_percent) AS avg_disk_io,
    AVG(network_rx_mbps) AS avg_net_rx,
    AVG(network_tx_mbps) AS avg_net_tx
FROM system_metrics
WHERE timestamp >= NOW() - INTERVAL '1 hour'
    AND instance = ANY($instance)
GROUP BY bucket, instance
ORDER BY bucket DESC;

-- Query 2: Application Error Logs
SELECT
    timestamp,
    severity,
    component,
    message,
    COUNT(*) OVER (
        PARTITION BY component, message
        ORDER BY timestamp
        RANGE BETWEEN INTERVAL '5 minutes' PRECEDING AND CURRENT ROW
    ) AS occurrence_count
FROM application_logs
WHERE timestamp >= NOW() - INTERVAL '1 hour'
    AND severity IN ('ERROR', 'CRITICAL')
ORDER BY timestamp DESC
LIMIT 100;

-- Query 3: Performance Bottleneck Detection
WITH slow_operations AS (
    SELECT
        operation_type,
        AVG(duration_ms) AS avg_duration,
        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY duration_ms) AS p95_duration,
        PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY duration_ms) AS p99_duration,
        COUNT(*) AS operation_count,
        COUNT(*) FILTER (WHERE duration_ms > 100) AS slow_count
    FROM operation_metrics
    WHERE timestamp >= NOW() - INTERVAL '15 minutes'
    GROUP BY operation_type
)
SELECT
    operation_type,
    avg_duration,
    p95_duration,
    p99_duration,
    operation_count,
    slow_count,
    (slow_count::FLOAT / operation_count * 100) AS slow_operation_pct
FROM slow_operations
WHERE slow_count > 0
ORDER BY p99_duration DESC;

-- Query 4: Service Availability Report
SELECT
    service_name,
    instance,
    COUNT(*) AS total_checks,
    COUNT(*) FILTER (WHERE status = 'up') AS up_checks,
    COUNT(*) FILTER (WHERE status = 'down') AS down_checks,
    (COUNT(*) FILTER (WHERE status = 'up')::FLOAT / COUNT(*) * 100) AS uptime_pct,
    MAX(timestamp) FILTER (WHERE status = 'down') AS last_down_time
FROM service_health_checks
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY service_name, instance
ORDER BY uptime_pct ASC;

-- Query 5: Network Latency Analysis
SELECT
    time_bucket('10 seconds', timestamp) AS bucket,
    source_instance,
    destination_instance,
    AVG(latency_us) AS avg_latency_us,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY latency_us) AS p95_latency_us,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY latency_us) AS p99_latency_us,
    STDDEV(latency_us) AS latency_stddev,
    COUNT(*) FILTER (WHERE latency_us > 1000) AS high_latency_count
FROM network_latency_measurements
WHERE timestamp >= NOW() - INTERVAL '30 minutes'
GROUP BY bucket, source_instance, destination_instance
ORDER BY bucket DESC;

-- Query 6: Memory Leak Detection
WITH memory_trend AS (
    SELECT
        instance,
        service,
        timestamp,
        memory_used_bytes,
        LAG(memory_used_bytes, 1) OVER (PARTITION BY instance, service ORDER BY timestamp) AS prev_memory,
        LAG(memory_used_bytes, 12) OVER (PARTITION BY instance, service ORDER BY timestamp) AS memory_1h_ago
    FROM system_metrics
    WHERE timestamp >= NOW() - INTERVAL '6 hours'
        AND timestamp = time_bucket('5 minutes', timestamp)
)
SELECT
    instance,
    service,
    memory_used_bytes AS current_memory,
    memory_1h_ago,
    memory_used_bytes - memory_1h_ago AS memory_increase,
    (memory_used_bytes - memory_1h_ago)::FLOAT / NULLIF(memory_1h_ago, 0) * 100 AS memory_increase_pct,
    CASE
        WHEN memory_used_bytes > prev_memory AND
             prev_memory > memory_1h_ago
        THEN 'POTENTIAL_LEAK'
        ELSE 'NORMAL'
    END AS leak_indicator
FROM memory_trend
WHERE memory_1h_ago IS NOT NULL
    AND timestamp = (SELECT MAX(timestamp) FROM system_metrics)
ORDER BY memory_increase_pct DESC;

================================================================================
PROMETHEUS QUERIES FOR SYSTEM HEALTH
================================================================================

# CPU Steal Time (for VMs)
avg(rate(node_cpu_seconds_total{mode="steal"}[1m])) * 100

# Memory Pressure (PSI - Pressure Stall Information)
avg_over_time(node_pressure_memory_waiting_seconds_total[1m])

# Disk I/O Wait Time
rate(node_disk_io_time_seconds_total[1m])

# Network Packet Loss Rate
rate(node_network_transmit_errs_total[1m]) + rate(node_network_receive_errs_total[1m])

# File Descriptor Usage
process_open_fds / process_max_fds * 100

# Thread Count
process_threads

# Network Retransmit Rate
rate(node_netstat_Tcp_RetransSegs[1m]) / rate(node_netstat_Tcp_OutSegs[1m]) * 100

# Page Faults (Major)
rate(node_vmstat_pgmajfault[1m])

# Disk Queue Length
node_disk_io_now

# System Entropy (randomness available)
node_entropy_available_bits

================================================================================
SYSTEM HEALTH ALERTING RULES
================================================================================

groups:
  - name: system_health_alerts
    interval: 10s
    rules:
      # CPU Alerts
      - alert: HighCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High CPU usage on {{$labels.instance}}"
          description: "CPU usage is {{$value}}%"

      - alert: CriticalCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[1m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "CRITICAL: CPU usage on {{$labels.instance}}"
          description: "CPU usage is {{$value}}%"

      # Memory Alerts
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High memory usage on {{$labels.instance}}"
          description: "Memory usage is {{$value}}%"

      - alert: OutOfMemory
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 95
        for: 1m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "CRITICAL: Out of memory on {{$labels.instance}}"
          description: "Memory usage is {{$value}}%"

      # Disk Alerts
      - alert: LowDiskSpace
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "Low disk space on {{$labels.instance}}"
          description: "{{$labels.mountpoint}} is {{$value}}% full"

      - alert: DiskSpaceCritical
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 95
        for: 1m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "CRITICAL: Disk space on {{$labels.instance}}"
          description: "{{$labels.mountpoint}} is {{$value}}% full"

      # Service Health
      - alert: ServiceDown
        expr: up == 0
        for: 30s
        labels:
          severity: critical
          component: service
        annotations:
          summary: "Service {{$labels.job}} is down"
          description: "{{$labels.instance}} has been down for 30 seconds"

      # Network Alerts
      - alert: HighNetworkErrors
        expr: rate(node_network_receive_errs_total[1m]) > 10
        for: 2m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "High network errors on {{$labels.instance}}"
          description: "{{$value}} errors/s on {{$labels.device}}"

      # Application Alerts
      - alert: HighOrderQueueDepth
        expr: hft_order_queue_depth > 1000
        for: 30s
        labels:
          severity: warning
          component: application
        annotations:
          summary: "High order queue depth"
          description: "Queue depth is {{$value}} messages"

      - alert: HighGCPause
        expr: rate(hft_gc_duration_seconds_sum[1m]) / rate(hft_gc_duration_seconds_count[1m]) * 1000 > 100
        for: 2m
        labels:
          severity: warning
          component: application
        annotations:
          summary: "High GC pause times"
          description: "Average GC pause is {{$value}}ms"

================================================================================
END OF SYSTEM HEALTH DASHBOARD CONFIGURATION
================================================================================
