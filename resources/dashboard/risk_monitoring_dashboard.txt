================================================================================
RISK MONITORING DASHBOARD - HFT TRADING SYSTEM
Real-Time Risk Metrics, Limits, and Compliance Monitoring
================================================================================

OVERVIEW
--------
Comprehensive risk monitoring dashboard for tracking real-time risk exposures,
position limits, VaR, drawdowns, and compliance with risk management rules.

================================================================================
RISK DASHBOARD CONFIGURATION
================================================================================

{
  "dashboard": {
    "uid": "hft-risk-monitoring",
    "title": "Risk Monitoring Dashboard",
    "tags": ["risk", "compliance", "limits", "var"],
    "timezone": "UTC",
    "refresh": "1s",
    "time": {
      "from": "now-12h",
      "to": "now"
    },
    "variables": [
      {
        "name": "strategy",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(hft_position_exposure_usd, strategy)",
        "multi": true,
        "includeAll": true
      },
      {
        "name": "account",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(hft_account_balance, account_id)",
        "multi": false,
        "includeAll": true
      },
      {
        "name": "risk_threshold",
        "type": "custom",
        "query": "conservative,moderate,aggressive",
        "current": {"value": "moderate"}
      }
    ]
  }
}

================================================================================
PANEL 1: RISK OVERVIEW - KEY METRICS
================================================================================

{
  "id": 301,
  "gridPos": {"h": 6, "w": 24, "x": 0, "y": 0},
  "type": "stat",
  "title": "Risk Metrics Overview",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "sum(abs(hft_position_exposure_usd))",
      "legendFormat": "Gross Exposure",
      "refId": "A",
      "instant": true
    },
    {
      "expr": "sum(hft_position_exposure_usd)",
      "legendFormat": "Net Exposure",
      "refId": "B",
      "instant": true
    },
    {
      "expr": "hft_risk_var_usd{confidence=\"0.95\", horizon=\"1d\"}",
      "legendFormat": "VaR 95% (1D)",
      "refId": "C",
      "instant": true
    },
    {
      "expr": "hft_risk_cvar_usd{confidence=\"0.95\"}",
      "legendFormat": "CVaR 95%",
      "refId": "D",
      "instant": true
    },
    {
      "expr": "abs(hft_max_drawdown_usd)",
      "legendFormat": "Max Drawdown",
      "refId": "E",
      "instant": true
    },
    {
      "expr": "hft_leverage_ratio",
      "legendFormat": "Leverage Ratio",
      "refId": "F",
      "instant": true
    }
  ],
  "fieldConfig": {
    "defaults": {
      "unit": "currencyUSD",
      "decimals": 0,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "green"},
          {"value": 500000, "color": "yellow"},
          {"value": 1000000, "color": "red"}
        ]
      }
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "Leverage Ratio"},
        "properties": [
          {"id": "unit", "value": "none"},
          {"id": "decimals", "value": 2},
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "green"},
                {"value": 2, "color": "yellow"},
                {"value": 5, "color": "red"}
              ]
            }
          }
        ]
      }
    ]
  },
  "options": {
    "graphMode": "area",
    "colorMode": "background",
    "orientation": "horizontal",
    "textMode": "value_and_name",
    "justifyMode": "center"
  }
}

================================================================================
PANEL 2: POSITION LIMITS MONITORING
================================================================================

{
  "id": 302,
  "gridPos": {"h": 10, "w": 12, "x": 0, "y": 6},
  "type": "bargauge",
  "title": "Position Limits Utilization",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "abs(hft_position_exposure_usd{strategy=~\"$strategy\"}) / hft_position_limit_usd * 100",
      "legendFormat": "{{strategy}} - {{symbol}}",
      "refId": "A",
      "instant": true
    }
  ],
  "fieldConfig": {
    "defaults": {
      "unit": "percent",
      "min": 0,
      "max": 100,
      "decimals": 1,
      "thresholds": {
        "mode": "percentage",
        "steps": [
          {"value": null, "color": "green"},
          {"value": 60, "color": "yellow"},
          {"value": 80, "color": "orange"},
          {"value": 95, "color": "red"}
        ]
      },
      "mappings": [
        {
          "type": "special",
          "options": {
            "match": "null",
            "result": {"text": "No Limit"}
          }
        }
      ]
    }
  },
  "options": {
    "orientation": "horizontal",
    "displayMode": "gradient",
    "showUnfilled": true,
    "text": {
      "titleSize": 12,
      "valueSize": 16
    }
  },
  "transformations": [
    {
      "id": "sortBy",
      "options": {
        "sort": [{"field": "Value", "desc": true}]
      }
    }
  ]
}

================================================================================
PANEL 3: VAR AND CVAR TRACKING
================================================================================

{
  "id": 303,
  "gridPos": {"h": 10, "w": 12, "x": 12, "y": 6},
  "type": "timeseries",
  "title": "Value at Risk (VaR) and Conditional VaR",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_risk_var_usd{confidence=\"0.95\", horizon=\"1d\"}",
      "legendFormat": "VaR 95% (1D)",
      "refId": "A"
    },
    {
      "expr": "hft_risk_var_usd{confidence=\"0.99\", horizon=\"1d\"}",
      "legendFormat": "VaR 99% (1D)",
      "refId": "B"
    },
    {
      "expr": "hft_risk_cvar_usd{confidence=\"0.95\"}",
      "legendFormat": "CVaR 95%",
      "refId": "C"
    },
    {
      "expr": "hft_var_limit_usd",
      "legendFormat": "VaR Limit",
      "refId": "D"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineInterpolation": "smooth",
        "lineWidth": 2,
        "fillOpacity": 20,
        "showPoints": "never"
      },
      "unit": "currencyUSD",
      "decimals": 0,
      "color": {
        "mode": "palette-classic"
      }
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "VaR Limit"},
        "properties": [
          {
            "id": "custom.lineStyle",
            "value": {"fill": "dash", "dash": [10, 5]}
          },
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "red"}},
          {"id": "custom.lineWidth", "value": 3}
        ]
      }
    ]
  },
  "options": {
    "tooltip": {
      "mode": "multi",
      "sort": "desc"
    },
    "legend": {
      "displayMode": "table",
      "placement": "bottom",
      "calcs": ["lastNotNull", "max", "mean"]
    }
  }
}

================================================================================
PANEL 4: DRAWDOWN ANALYSIS
================================================================================

{
  "id": 304,
  "gridPos": {"h": 10, "w": 12, "x": 0, "y": 16},
  "type": "timeseries",
  "title": "Drawdown Analysis (Intraday)",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_strategy_pnl_usd - max_over_time(hft_strategy_pnl_usd[24h])",
      "legendFormat": "{{strategy}} - Drawdown",
      "refId": "A"
    },
    {
      "expr": "(hft_strategy_pnl_usd - max_over_time(hft_strategy_pnl_usd[24h])) / max_over_time(hft_strategy_pnl_usd[24h]) * 100",
      "legendFormat": "{{strategy}} - Drawdown %",
      "refId": "B"
    },
    {
      "expr": "-1 * hft_max_drawdown_limit_usd",
      "legendFormat": "Max Drawdown Limit",
      "refId": "C"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 30,
        "gradientMode": "opacity"
      },
      "unit": "currencyUSD",
      "decimals": 0,
      "max": 0
    },
    "overrides": [
      {
        "matcher": {"id": "byRegexp", "options": ".*%"},
        "properties": [
          {"id": "unit", "value": "percent"},
          {"id": "custom.axisPlacement", "value": "right"}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Max Drawdown Limit"},
        "properties": [
          {
            "id": "custom.lineStyle",
            "value": {"fill": "dash", "dash": [5, 5]}
          },
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "red"}},
          {"id": "custom.fillOpacity", "value": 0}
        ]
      }
    ]
  }
}

================================================================================
PANEL 5: EXPOSURE BY ASSET CLASS
================================================================================

{
  "id": 305,
  "gridPos": {"h": 10, "w": 12, "x": 12, "y": 16},
  "type": "piechart",
  "title": "Exposure by Asset Class",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "sum(abs(hft_position_exposure_usd)) by (asset_class)",
      "legendFormat": "{{asset_class}}",
      "refId": "A",
      "instant": true
    }
  ],
  "fieldConfig": {
    "defaults": {
      "unit": "currencyUSD",
      "decimals": 0,
      "color": {
        "mode": "palette-classic"
      }
    }
  },
  "options": {
    "pieType": "donut",
    "displayLabels": ["name", "value", "percent"],
    "tooltip": {
      "mode": "single"
    },
    "legend": {
      "displayMode": "table",
      "placement": "right",
      "values": ["value", "percent"]
    }
  }
}

================================================================================
PANEL 6: CONCENTRATION RISK
================================================================================

{
  "id": 306,
  "gridPos": {"h": 10, "w": 12, "x": 0, "y": 26},
  "type": "table",
  "title": "Concentration Risk by Symbol",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "abs(hft_position_exposure_usd)",
      "format": "table",
      "instant": true,
      "refId": "A"
    },
    {
      "expr": "abs(hft_position_exposure_usd) / sum(abs(hft_position_exposure_usd)) * 100",
      "format": "table",
      "instant": true,
      "refId": "B"
    },
    {
      "expr": "hft_position_quantity",
      "format": "table",
      "instant": true,
      "refId": "C"
    },
    {
      "expr": "hft_position_unrealized_pnl_usd",
      "format": "table",
      "instant": true,
      "refId": "D"
    },
    {
      "expr": "hft_position_duration_seconds / 3600",
      "format": "table",
      "instant": true,
      "refId": "E"
    }
  ],
  "transformations": [
    {
      "id": "merge",
      "options": {}
    },
    {
      "id": "organize",
      "options": {
        "excludeByName": {
          "Time": true,
          "__name__": true,
          "job": true,
          "instance": true
        },
        "renameByPattern": {
          "symbol": "Symbol",
          "strategy": "Strategy",
          "Value #A": "Exposure (USD)",
          "Value #B": "Concentration %",
          "Value #C": "Quantity",
          "Value #D": "Unrealized P&L",
          "Value #E": "Duration (hrs)"
        },
        "indexByName": {
          "Symbol": 0,
          "Strategy": 1,
          "Exposure (USD)": 2,
          "Concentration %": 3,
          "Quantity": 4,
          "Unrealized P&L": 5,
          "Duration (hrs)": 6
        }
      }
    },
    {
      "id": "sortBy",
      "options": {
        "sort": [{"field": "Exposure (USD)", "desc": true}]
      }
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "align": "center",
        "displayMode": "auto"
      }
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "Exposure (USD)"},
        "properties": [
          {"id": "unit", "value": "currencyUSD"},
          {"id": "decimals", "value": 0},
          {"id": "custom.displayMode", "value": "gradient-gauge"}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Concentration %"},
        "properties": [
          {"id": "unit", "value": "percent"},
          {"id": "decimals", "value": 2},
          {
            "id": "custom.displayMode",
            "value": "color-background"
          },
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "green"},
                {"value": 10, "color": "yellow"},
                {"value": 25, "color": "red"}
              ]
            }
          }
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Unrealized P&L"},
        "properties": [
          {"id": "unit", "value": "currencyUSD"},
          {"id": "decimals", "value": 2},
          {
            "id": "custom.displayMode",
            "value": "color-text"
          },
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "red"},
                {"value": 0, "color": "green"}
              ]
            }
          }
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Duration (hrs)"},
        "properties": [
          {"id": "decimals", "value": 1},
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "green"},
                {"value": 4, "color": "yellow"},
                {"value": 12, "color": "red"}
              ]
            }
          }
        ]
      }
    ]
  }
}

================================================================================
PANEL 7: GREEKS AND PORTFOLIO SENSITIVITIES
================================================================================

{
  "id": 307,
  "gridPos": {"h": 10, "w": 12, "x": 12, "y": 26},
  "type": "timeseries",
  "title": "Portfolio Greeks (Options)",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_portfolio_delta",
      "legendFormat": "Delta",
      "refId": "A"
    },
    {
      "expr": "hft_portfolio_gamma",
      "legendFormat": "Gamma",
      "refId": "B"
    },
    {
      "expr": "hft_portfolio_vega",
      "legendFormat": "Vega",
      "refId": "C"
    },
    {
      "expr": "hft_portfolio_theta",
      "legendFormat": "Theta",
      "refId": "D"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 15
      },
      "decimals": 2
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "Delta"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "blue"}}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Gamma"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "green"}},
          {"id": "custom.axisPlacement", "value": "right"}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Vega"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "purple"}}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "Theta"},
        "properties": [
          {"id": "color", "value": {"mode": "fixed", "fixedColor": "orange"}}
        ]
      }
    ]
  }
}

================================================================================
PANEL 8: RISK LIMIT BREACHES (TABLE)
================================================================================

{
  "id": 308,
  "gridPos": {"h": 8, "w": 24, "x": 0, "y": 36},
  "type": "table",
  "title": "Active Risk Limit Alerts",
  "datasource": "PostgreSQL",
  "targets": [
    {
      "rawSql": "SELECT timestamp, severity, risk_type, strategy, symbol, current_value, limit_value, breach_percentage, duration_seconds FROM risk_limit_breaches WHERE timestamp >= NOW() - INTERVAL '1 hour' AND is_active = true ORDER BY severity DESC, timestamp DESC LIMIT 50",
      "format": "table",
      "refId": "A"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "align": "left",
        "displayMode": "auto"
      }
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "severity"},
        "properties": [
          {"id": "custom.width", "value": 100},
          {
            "id": "custom.displayMode",
            "value": "color-background"
          },
          {
            "id": "mappings",
            "value": [
              {
                "type": "value",
                "options": {
                  "critical": {"color": "red", "text": "CRITICAL"},
                  "warning": {"color": "yellow", "text": "WARNING"},
                  "info": {"color": "blue", "text": "INFO"}
                }
              }
            ]
          }
        ]
      },
      {
        "matcher": {"id": "byName", "options": "breach_percentage"},
        "properties": [
          {"id": "unit", "value": "percent"},
          {"id": "decimals", "value": 1},
          {"id": "custom.displayMode", "value": "lcd-gauge"},
          {"id": "min", "value": 0},
          {"id": "max", "value": 200}
        ]
      },
      {
        "matcher": {"id": "byName", "options": "duration_seconds"},
        "properties": [
          {"id": "unit", "value": "s"},
          {"id": "decimals", "value": 0}
        ]
      }
    ]
  }
}

================================================================================
PANEL 9: MARGIN AND BUYING POWER
================================================================================

{
  "id": 309,
  "gridPos": {"h": 8, "w": 12, "x": 0, "y": 44},
  "type": "gauge",
  "title": "Margin Utilization",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_margin_used / hft_margin_available * 100",
      "legendFormat": "{{account_id}}",
      "refId": "A"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "unit": "percent",
      "min": 0,
      "max": 100,
      "decimals": 1,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "green"},
          {"value": 50, "color": "yellow"},
          {"value": 75, "color": "orange"},
          {"value": 90, "color": "red"}
        ]
      }
    }
  },
  "options": {
    "orientation": "auto",
    "showThresholdLabels": true,
    "showThresholdMarkers": true,
    "text": {
      "valueSize": 50
    }
  }
}

================================================================================
PANEL 10: STRESS TEST SCENARIOS
================================================================================

{
  "id": 310,
  "gridPos": {"h": 8, "w": 12, "x": 12, "y": 44},
  "type": "stat",
  "title": "Stress Test Scenarios",
  "datasource": "Prometheus",
  "targets": [
    {
      "expr": "hft_stress_test_pnl{scenario=\"market_crash_10pct\"}",
      "legendFormat": "Market Crash -10%",
      "refId": "A",
      "instant": true
    },
    {
      "expr": "hft_stress_test_pnl{scenario=\"volatility_spike_2x\"}",
      "legendFormat": "Vol Spike 2x",
      "refId": "B",
      "instant": true
    },
    {
      "expr": "hft_stress_test_pnl{scenario=\"liquidity_crisis\"}",
      "legendFormat": "Liquidity Crisis",
      "refId": "C",
      "instant": true
    },
    {
      "expr": "hft_stress_test_pnl{scenario=\"flash_crash\"}",
      "legendFormat": "Flash Crash",
      "refId": "D",
      "instant": true
    }
  ],
  "fieldConfig": {
    "defaults": {
      "unit": "currencyUSD",
      "decimals": 0,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "red"},
          {"value": -100000, "color": "orange"},
          {"value": -50000, "color": "yellow"},
          {"value": 0, "color": "green"}
        ]
      }
    }
  },
  "options": {
    "graphMode": "none",
    "colorMode": "background",
    "orientation": "horizontal",
    "textMode": "value_and_name"
  }
}

================================================================================
SQL QUERIES FOR RISK ANALYSIS
================================================================================

-- Query 1: Position Risk Summary
SELECT
    p.symbol,
    p.strategy,
    p.quantity,
    p.avg_entry_price,
    m.last_price AS current_price,
    (m.last_price - p.avg_entry_price) * p.quantity AS unrealized_pnl,
    ABS(m.last_price * p.quantity) AS position_value,
    ABS(m.last_price * p.quantity) / a.total_equity * 100 AS concentration_pct,
    p.var_1d_95 AS position_var,
    EXTRACT(EPOCH FROM (NOW() - p.entry_time)) / 3600 AS holding_hours
FROM positions p
JOIN market_data m ON p.symbol = m.symbol
JOIN (
    SELECT account_id, SUM(equity) AS total_equity
    FROM accounts
    GROUP BY account_id
) a ON p.account_id = a.account_id
WHERE p.quantity != 0
    AND m.timestamp = (SELECT MAX(timestamp) FROM market_data WHERE symbol = p.symbol)
ORDER BY ABS(m.last_price * p.quantity) DESC;

-- Query 2: VaR Calculation (Historical Simulation)
WITH returns AS (
    SELECT
        symbol,
        timestamp,
        price,
        LAG(price) OVER (PARTITION BY symbol ORDER BY timestamp) AS prev_price,
        (price - LAG(price) OVER (PARTITION BY symbol ORDER BY timestamp)) /
            LAG(price) OVER (PARTITION BY symbol ORDER BY timestamp) AS return
    FROM market_data
    WHERE timestamp >= NOW() - INTERVAL '30 days'
),
position_returns AS (
    SELECT
        r.timestamp,
        SUM(r.return * p.quantity * p.avg_entry_price) AS portfolio_return
    FROM returns r
    JOIN positions p ON r.symbol = p.symbol
    WHERE r.return IS NOT NULL
        AND p.quantity != 0
    GROUP BY r.timestamp
)
SELECT
    PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY portfolio_return) AS var_95_pct,
    PERCENTILE_CONT(0.01) WITHIN GROUP (ORDER BY portfolio_return) AS var_99_pct,
    AVG(portfolio_return) FILTER (WHERE portfolio_return <= PERCENTILE_CONT(0.05) WITHIN GROUP (ORDER BY portfolio_return)) AS cvar_95_pct
FROM position_returns;

-- Query 3: Risk Limit Breach History
SELECT
    DATE_TRUNC('hour', timestamp) AS hour,
    risk_type,
    COUNT(*) AS breach_count,
    AVG(breach_percentage) AS avg_breach_pct,
    MAX(breach_percentage) AS max_breach_pct,
    AVG(duration_seconds) AS avg_duration_sec,
    COUNT(DISTINCT strategy) AS affected_strategies
FROM risk_limit_breaches
WHERE timestamp >= NOW() - INTERVAL '24 hours'
GROUP BY hour, risk_type
ORDER BY hour DESC, breach_count DESC;

-- Query 4: Correlation Matrix for Portfolio
WITH symbol_returns AS (
    SELECT
        symbol,
        time_bucket('1 minute', timestamp) AS bucket,
        (MAX(price) - MIN(price)) / MIN(price) AS return
    FROM market_data
    WHERE timestamp >= NOW() - INTERVAL '1 hour'
    GROUP BY symbol, bucket
)
SELECT
    s1.symbol AS symbol1,
    s2.symbol AS symbol2,
    CORR(s1.return, s2.return) AS correlation
FROM symbol_returns s1
JOIN symbol_returns s2 ON s1.bucket = s2.bucket
WHERE s1.symbol < s2.symbol
GROUP BY s1.symbol, s2.symbol
HAVING COUNT(*) > 30
ORDER BY ABS(CORR(s1.return, s2.return)) DESC;

-- Query 5: Drawdown Analysis
WITH pnl_series AS (
    SELECT
        timestamp,
        strategy,
        pnl,
        MAX(pnl) OVER (
            PARTITION BY strategy
            ORDER BY timestamp
            ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
        ) AS running_max
    FROM strategy_pnl
    WHERE timestamp >= NOW() - INTERVAL '24 hours'
),
drawdowns AS (
    SELECT
        timestamp,
        strategy,
        pnl,
        running_max,
        pnl - running_max AS drawdown,
        (pnl - running_max) / NULLIF(running_max, 0) * 100 AS drawdown_pct
    FROM pnl_series
)
SELECT
    strategy,
    MIN(drawdown) AS max_drawdown,
    MIN(drawdown_pct) AS max_drawdown_pct,
    MAX(timestamp) FILTER (WHERE drawdown = MIN(drawdown)) AS max_dd_time,
    AVG(drawdown) AS avg_drawdown,
    COUNT(*) FILTER (WHERE drawdown < 0) AS periods_in_drawdown
FROM drawdowns
GROUP BY strategy
ORDER BY max_drawdown;

-- Query 6: Exposure by Exchange and Asset Class
SELECT
    p.exchange,
    p.asset_class,
    COUNT(DISTINCT p.symbol) AS num_symbols,
    SUM(ABS(p.quantity * m.last_price)) AS gross_exposure,
    SUM(p.quantity * m.last_price) AS net_exposure,
    SUM(p.unrealized_pnl) AS total_unrealized_pnl,
    SUM(ABS(p.quantity * m.last_price)) / SUM(SUM(ABS(p.quantity * m.last_price))) OVER () * 100 AS concentration_pct
FROM positions p
JOIN market_data m ON p.symbol = m.symbol
WHERE p.quantity != 0
    AND m.timestamp = (SELECT MAX(timestamp) FROM market_data WHERE symbol = p.symbol)
GROUP BY p.exchange, p.asset_class
ORDER BY gross_exposure DESC;

================================================================================
PROMETHEUS QUERIES FOR RISK MONITORING
================================================================================

# Position Concentration (Herfindahl Index)
sum((abs(hft_position_exposure_usd) / sum(abs(hft_position_exposure_usd)))^2)

# Portfolio Beta (relative to market)
sum(hft_position_beta * abs(hft_position_exposure_usd)) / sum(abs(hft_position_exposure_usd))

# Maximum Single Position Risk
max(abs(hft_position_exposure_usd))

# Risk-Adjusted Return (Sharpe-like)
avg_over_time(hft_daily_pnl_usd[30d]) / stddev_over_time(hft_daily_pnl_usd[30d])

# Leverage Ratio
sum(abs(hft_position_exposure_usd)) / hft_account_equity

# Margin Usage Ratio
hft_margin_used / hft_margin_available

# Position Duration (average in hours)
avg(hft_position_duration_seconds) / 3600

# Tail Risk Indicator (99th percentile loss)
histogram_quantile(0.01, sum(rate(hft_trade_pnl_bucket[1h])) by (le))

# Greeks Delta Exposure
sum(hft_position_delta * hft_position_quantity)

# Volatility Risk (weighted average)
sum(hft_position_implied_vol * abs(hft_position_exposure_usd)) / sum(abs(hft_position_exposure_usd))

================================================================================
RISK ALERTING RULES
================================================================================

groups:
  - name: risk_alerts
    interval: 1s
    rules:
      # Position Limit Alerts
      - alert: PositionLimitBreach
        expr: abs(hft_position_exposure_usd) > hft_position_limit_usd
        for: 0s
        labels:
          severity: critical
          component: risk
        annotations:
          summary: "Position limit breached"
          description: "{{$labels.strategy}} {{$labels.symbol}} exposure ${{$value}} exceeds limit"

      # VaR Limit Alerts
      - alert: VaRLimitExceeded
        expr: hft_risk_var_usd{confidence="0.95"} > hft_var_limit_usd
        for: 30s
        labels:
          severity: critical
          component: risk
        annotations:
          summary: "VaR limit exceeded"
          description: "Portfolio VaR ${{$value}} exceeds limit ${{hft_var_limit_usd}}"

      # Drawdown Alerts
      - alert: DrawdownLimitApproached
        expr: abs(hft_strategy_pnl_usd - max_over_time(hft_strategy_pnl_usd[24h])) > hft_max_drawdown_limit_usd * 0.8
        for: 1m
        labels:
          severity: warning
          component: risk
        annotations:
          summary: "Approaching drawdown limit"
          description: "{{$labels.strategy}} drawdown ${{$value}} approaching limit"

      - alert: DrawdownLimitBreached
        expr: abs(hft_strategy_pnl_usd - max_over_time(hft_strategy_pnl_usd[24h])) > hft_max_drawdown_limit_usd
        for: 0s
        labels:
          severity: critical
          component: risk
        annotations:
          summary: "CRITICAL: Drawdown limit breached"
          description: "{{$labels.strategy}} drawdown ${{$value}} exceeds limit - HALT TRADING"

      # Concentration Risk
      - alert: HighConcentrationRisk
        expr: abs(hft_position_exposure_usd) / sum(abs(hft_position_exposure_usd)) * 100 > 25
        for: 2m
        labels:
          severity: warning
          component: risk
        annotations:
          summary: "High concentration risk"
          description: "{{$labels.symbol}} represents {{$value}}% of portfolio"

      # Leverage Alerts
      - alert: HighLeverage
        expr: sum(abs(hft_position_exposure_usd)) / hft_account_equity > 3
        for: 1m
        labels:
          severity: warning
          component: risk
        annotations:
          summary: "High leverage detected"
          description: "Portfolio leverage ratio is {{$value}}x"

      - alert: ExcessiveLeverage
        expr: sum(abs(hft_position_exposure_usd)) / hft_account_equity > 5
        for: 0s
        labels:
          severity: critical
          component: risk
        annotations:
          summary: "CRITICAL: Excessive leverage"
          description: "Portfolio leverage {{$value}}x exceeds maximum 5x"

      # Margin Alerts
      - alert: LowMarginBuffer
        expr: (hft_margin_available - hft_margin_used) / hft_margin_available * 100 < 20
        for: 30s
        labels:
          severity: warning
          component: risk
        annotations:
          summary: "Low margin buffer"
          description: "Only {{$value}}% margin remaining on {{$labels.account_id}}"

      - alert: MarginCallRisk
        expr: hft_margin_used / hft_margin_available > 0.95
        for: 0s
        labels:
          severity: critical
          component: risk
        annotations:
          summary: "MARGIN CALL RISK"
          description: "Margin utilization {{$value}}% on {{$labels.account_id}}"

      # Greeks Alerts
      - alert: ExcessiveDelta
        expr: abs(hft_portfolio_delta) > 1000
        for: 1m
        labels:
          severity: warning
          component: risk
        annotations:
          summary: "Excessive portfolio delta"
          description: "Portfolio delta is {{$value}}"

      - alert: HighGammaRisk
        expr: abs(hft_portfolio_gamma) > 100
        for: 1m
        labels:
          severity: warning
          component: risk
        annotations:
          summary: "High gamma risk"
          description: "Portfolio gamma is {{$value}}"

================================================================================
END OF RISK MONITORING DASHBOARD CONFIGURATION
================================================================================
