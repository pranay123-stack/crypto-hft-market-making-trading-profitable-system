================================================================================
HFT SYSTEM TROUBLESHOOTING GUIDE
================================================================================

VERSION: 1.0
LAST UPDATED: 2025-11-25
OWNER: Platform Engineering Team
CLASSIFICATION: Internal Use Only

================================================================================
TABLE OF CONTENTS
================================================================================

1. TROUBLESHOOTING METHODOLOGY
2. STARTUP AND CONNECTIVITY ISSUES
3. MARKET DATA PROBLEMS
4. ORDER EXECUTION ISSUES
5. PERFORMANCE AND LATENCY PROBLEMS
6. MEMORY AND RESOURCE ISSUES
7. DATABASE ISSUES
8. EXCHANGE-SPECIFIC PROBLEMS
9. STRATEGY ISSUES
10. NETWORK AND CONNECTIVITY
11. MONITORING AND ALERTING ISSUES
12. COMMON ERROR MESSAGES

================================================================================
1. TROUBLESHOOTING METHODOLOGY
================================================================================

1.1 SYSTEMATIC APPROACH
-----------------------

Follow this decision tree for any issue:

1. IDENTIFY
   - What is the symptom?
   - When did it start?
   - What changed recently?
   - Is it affecting all components or specific ones?

2. ISOLATE
   - Is it system-wide or component-specific?
   - Is it affecting one exchange or all?
   - Is it reproducible?

3. DIAGNOSE
   - Check logs for errors
   - Review metrics and dashboards
   - Test individual components
   - Compare with known-good state

4. RESOLVE
   - Apply fix (start with least invasive)
   - Verify fix worked
   - Monitor for recurrence

5. DOCUMENT
   - Log the issue in incident tracker
   - Document root cause
   - Update runbooks if needed

1.2 ESSENTIAL COMMANDS
----------------------

Quick Health Check:
```bash
./scripts/health_check.sh
```

View Recent Errors:
```bash
tail -100 /var/log/hft_system/errors.log
```

Check System Status:
```bash
curl -s http://localhost:8080/api/v1/status | jq .
```

View Active Processes:
```bash
ps aux | grep hft_system
```

Check Network Connections:
```bash
netstat -an | grep ESTABLISHED | grep -E "(443|9443|8443)"
```

Monitor System Resources:
```bash
top -bn1 | head -20
free -h
df -h
```

1.3 LOG LOCATIONS
-----------------

Primary Logs:
- System: /var/log/hft_system/system.log
- Errors: /var/log/hft_system/errors.log
- Market Data: /var/log/hft_system/market_data.log
- Orders: /var/log/hft_system/orders.log
- Strategies: /var/log/hft_system/strategies.log
- Risk: /var/log/hft_system/risk.log
- Exchanges: /var/log/hft_system/exchanges.log

Monitoring:
- Grafana: http://localhost:3000
- Prometheus: http://localhost:9090
- System Metrics: http://localhost:8080/api/v1/metrics

================================================================================
2. STARTUP AND CONNECTIVITY ISSUES
================================================================================

2.1 SYSTEM FAILS TO START
--------------------------

SYMPTOM: Process exits immediately after start

DIAGNOSIS:
```bash
# Check last 100 lines of system log
tail -100 /var/log/hft_system/system.log

# Look for common errors:
# - "Failed to load configuration"
# - "Database connection failed"
# - "Failed to bind to port"
# - "Segmentation fault"
```

COMMON CAUSES & SOLUTIONS:

Cause 1: Configuration File Not Found
```bash
# Error: "Failed to load configuration from /path/to/config.json"

# Solution:
ls -l /opt/hft_system/config/production.json
# If missing, restore from git:
cd /opt/hft_system
git checkout config/production.json
```

Cause 2: Database Connection Failed
```bash
# Error: "Database connection failed: could not connect to server"

# Check database status:
sudo systemctl status timescaledb

# If not running:
sudo systemctl start timescaledb

# Test connection:
psql -h localhost -U hft_user -d hft_db -c "SELECT 1;"

# If password error, check .pgpass or environment variables
```

Cause 3: Port Already in Use
```bash
# Error: "Failed to bind to port 8080: Address already in use"

# Find process using port:
sudo lsof -i :8080

# Kill conflicting process:
sudo kill -9 <PID>

# Or change port in configuration
```

Cause 4: Insufficient Permissions
```bash
# Error: "Permission denied" when accessing files

# Fix ownership:
sudo chown -R hft_user:hft_group /opt/hft_system
sudo chown -R hft_user:hft_group /var/log/hft_system

# Fix permissions:
chmod 755 /opt/hft_system/bin/hft_system
```

Cause 5: Missing Shared Libraries
```bash
# Error: "error while loading shared libraries"

# Check dependencies:
ldd /opt/hft_system/bin/hft_system

# If missing libraries, reinstall:
cd /opt/hft_system
./scripts/install_dependencies.sh
```

2.2 EXCHANGE CONNECTION FAILURES
---------------------------------

SYMPTOM: "Failed to connect to <exchange>" in logs

DIAGNOSIS:
```bash
# Check exchange status in system:
curl -s http://localhost:8080/api/v1/status | jq '.exchanges'

# Check specific exchange logs:
grep "binance" /var/log/hft_system/exchanges.log | tail -50

# Test network connectivity:
ping -c 3 stream.binance.com
curl -I https://api.binance.com
```

DECISION TREE:

┌─ Exchange connection failed?
│
├─ YES → Is network reachable?
│        │
│        ├─ NO → Check firewall, DNS, routing
│        │       ```bash
│        │       # Check DNS:
│        │       nslookup stream.binance.com
│        │
│        │       # Check firewall:
│        │       sudo iptables -L -n | grep 443
│        │
│        │       # Test direct connection:
│        │       telnet stream.binance.com 9443
│        │       ```
│        │
│        └─ YES → Is exchange API working?
│                 │
│                 ├─ NO → Exchange outage
│                 │       Check exchange status page
│                 │       Wait for recovery
│                 │
│                 └─ YES → Is API key valid?
│                          │
│                          ├─ NO → Rotate API keys
│                          │       Update configuration
│                          │
│                          └─ YES → Check rate limiting
│                                   Review recent requests
│                                   Implement backoff
│
└─ NO → Continue with other diagnostics

SPECIFIC SOLUTIONS:

Network Issue:
```bash
# Check default route:
ip route show

# Check DNS resolution:
nslookup stream.binance.com

# If DNS fails, add to /etc/hosts:
echo "X.X.X.X stream.binance.com" | sudo tee -a /etc/hosts

# Check MTU:
ping -M do -s 1472 stream.binance.com
```

API Key Issue:
```bash
# Test API key manually:
./scripts/test_api_key.sh binance

# If invalid, generate new key on exchange
# Update configuration:
vi config/exchanges/binance.json

# Hot-reload configuration:
curl -X GET http://localhost:8080/api/v1/config/reload \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE"
```

Rate Limiting:
```bash
# Check rate limit errors in logs:
grep "rate limit" /var/log/hft_system/exchanges.log | tail -20

# Reduce request rate in configuration:
vi config/exchanges/binance.json
# Adjust rate_limits section

# Restart connector:
curl -X POST http://localhost:8080/api/v1/exchanges/binance/reconnect
```

SSL/TLS Issue:
```bash
# Test SSL connection:
openssl s_client -connect stream.binance.com:9443

# If certificate error, update CA certificates:
sudo update-ca-certificates

# Check system time (affects SSL):
date
# Should be accurate within 1 second
# If not, sync with NTP:
sudo ntpdate -s time.nist.gov
```

2.3 DATABASE CONNECTION ISSUES
-------------------------------

SYMPTOM: "Database connection lost" or "Query timeout"

DIAGNOSIS:
```bash
# Check database status:
sudo systemctl status timescaledb

# Check active connections:
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT count(*) FROM pg_stat_activity;
EOF

# Check for long-running queries:
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT pid, now() - pg_stat_activity.query_start AS duration, query
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY duration DESC;
EOF
```

SOLUTIONS:

Database Not Running:
```bash
sudo systemctl start timescaledb
sudo systemctl enable timescaledb

# Verify:
psql -h localhost -U hft_user -d hft_db -c "SELECT 1;"
```

Connection Pool Exhausted:
```bash
# Check current connections:
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT count(*) FROM pg_stat_activity WHERE datname = 'hft_db';
EOF

# If at limit, kill idle connections:
psql -h localhost -U postgres -d hft_db <<EOF
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname = 'hft_db' AND state = 'idle' AND state_change < now() - interval '5 minutes';
EOF

# Increase connection limit (if appropriate):
# Edit postgresql.conf:
# max_connections = 200
sudo systemctl restart timescaledb
```

Slow Queries:
```bash
# Identify slow queries:
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT pid, query, now() - query_start AS duration
FROM pg_stat_activity
WHERE state = 'active' AND query_start < now() - interval '10 seconds'
ORDER BY duration DESC;
EOF

# Kill slow query:
psql -h localhost -U postgres -d hft_db <<EOF
SELECT pg_terminate_backend(<PID>);
EOF

# Analyze and optimize slow queries
```

Disk Full:
```bash
# Check disk space:
df -h /var/lib/postgresql

# If full, clean up:
# 1. Drop old partitions:
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT drop_chunks('market_data_ticks', INTERVAL '90 days');
EOF

# 2. Vacuum:
psql -h localhost -U hft_user -d hft_db -c "VACUUM FULL;"

# 3. Clean WAL logs:
sudo -u postgres pg_archivecleanup /var/lib/postgresql/14/main/pg_wal $(sudo -u postgres pg_controldata /var/lib/postgresql/14/main | grep "Latest checkpoint's REDO WAL file" | awk '{print $6}')
```

================================================================================
3. MARKET DATA PROBLEMS
================================================================================

3.1 NO MARKET DATA RECEIVED
----------------------------

SYMPTOM: Market data event rate is zero or very low

DIAGNOSIS:
```bash
# Check market data event rate:
grep "market_data" /var/log/hft_system/market_data.log | grep "ticker" | wc -l

# Check WebSocket connections:
netstat -an | grep ESTABLISHED | grep 9443

# Check market data handler status:
curl -s http://localhost:8080/api/v1/status | jq '.exchanges[].status'
```

TROUBLESHOOTING STEPS:

Step 1: Verify Exchange Connection
```bash
# Check if WebSocket is connected:
./scripts/check_websocket.sh binance

# Expected: "WebSocket connected"
# If not connected, check network and API key
```

Step 2: Verify Subscription
```bash
# Check subscriptions in logs:
grep "subscribe" /var/log/hft_system/market_data.log | tail -20

# Should see:
# "Subscribed to binance:BTC-USDT:ticker"
# "Subscribed to binance:BTC-USDT:orderbook"

# If not subscribed, check configuration:
cat config/strategies/*.json | jq '.symbols'
```

Step 3: Check for Throttling
```bash
# Check for rate limit messages:
grep "throttle\|rate limit" /var/log/hft_system/exchanges.log

# If throttled, reduce subscription count or request rate
```

Step 4: Test Exchange Endpoint Directly
```bash
# Test with websocat:
websocat wss://stream.binance.com:9443/ws/btcusdt@ticker

# Should see continuous JSON messages
# If not, exchange may have issues
```

3.2 STALE MARKET DATA
---------------------

SYMPTOM: Market data timestamps are old (> 5 seconds)

DIAGNOSIS:
```bash
# Check market data latency:
./scripts/check_market_data_latency.sh

# Check system time:
date
# Compare with NTP server:
ntpdate -q time.nist.gov
```

SOLUTIONS:

System Clock Drift:
```bash
# Sync system time:
sudo ntpdate -s time.nist.gov

# Enable NTP daemon:
sudo systemctl enable ntp
sudo systemctl start ntp

# Verify time sync:
ntpq -p
```

Network Latency:
```bash
# Check RTT to exchange:
ping -c 10 stream.binance.com

# If high latency (> 100ms):
# - Consider colocation closer to exchange
# - Check for network congestion
# - Verify no VPN/proxy in path
```

Processing Backlog:
```bash
# Check queue depths:
curl -s http://localhost:8080/api/v1/metrics | grep queue_depth

# If queues are full:
# - Increase queue size in configuration
# - Add more processing threads
# - Reduce subscription count
```

3.3 INCORRECT ORDER BOOK DATA
------------------------------

SYMPTOM: Order book shows invalid prices or quantities

DIAGNOSIS:
```bash
# Get current order book:
curl -s http://localhost:8080/api/v1/marketdata/orderbook/binance/BTC-USDT | jq .

# Check for:
# - Negative prices
# - Zero quantities
# - Crossed book (bid > ask)
# - Huge price jumps

# Check order book logs:
grep "orderbook.*BTC-USDT" /var/log/hft_system/market_data.log | tail -50
```

SOLUTIONS:

Missed Updates:
```bash
# Force order book snapshot:
curl -X POST http://localhost:8080/api/v1/marketdata/snapshot/binance/BTC-USDT

# This will:
# 1. Request fresh snapshot from exchange
# 2. Rebuild order book
# 3. Resume incremental updates
```

Sequence Number Gap:
```bash
# Check for sequence gaps in logs:
grep "sequence gap" /var/log/hft_system/market_data.log

# If found, reconnect to exchange:
curl -X POST http://localhost:8080/api/v1/exchanges/binance/reconnect
```

Exchange Bug:
```bash
# Compare with exchange API directly:
curl -s "https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=10" | jq .

# If exchange data is wrong, report to exchange
# If our data is wrong, check parsing logic
```

================================================================================
4. ORDER EXECUTION ISSUES
================================================================================

4.1 ORDERS NOT BEING PLACED
----------------------------

SYMPTOM: Strategy generates signals but orders not sent to exchange

DIAGNOSIS:
```bash
# Check strategy status:
curl -s http://localhost:8080/api/v1/strategies | jq '.strategies[] | {id: .strategy_id, status: .status}'

# Check for risk violations:
grep "risk check failed" /var/log/hft_system/risk.log | tail -20

# Check order submission logs:
grep "submit order" /var/log/hft_system/orders.log | tail -20
```

TROUBLESHOOTING DECISION TREE:

┌─ Orders not being placed?
│
├─ Is trading enabled?
│  ```bash
│  curl -s http://localhost:8080/api/v1/status | jq .trading_enabled
│  # If false:
│  curl -X POST http://localhost:8080/api/v1/config -d '{"trading_enabled": true}'
│  ```
│
├─ Is strategy running?
│  ```bash
│  curl -s http://localhost:8080/api/v1/strategies | jq '.strategies[] | select(.strategy_id=="my_strategy") | .status'
│  # If stopped:
│  curl -X POST http://localhost:8080/api/v1/strategies/my_strategy/start
│  ```
│
├─ Are there risk violations?
│  ```bash
│  grep "risk" /var/log/hft_system/risk.log | tail -20
│  # Common violations:
│  # - Position limit exceeded
│  # - Daily loss limit reached
│  # - Insufficient balance
│  # - Order size too large
│  #
│  # Solution: Review and adjust risk limits or reduce order sizes
│  ```
│
├─ Is exchange connector working?
│  ```bash
│  curl -s http://localhost:8080/api/v1/status | jq '.exchanges.binance.status'
│  # If disconnected:
│  curl -X POST http://localhost:8080/api/v1/exchanges/binance/reconnect
│  ```
│
└─ Check strategy logic
   # Review strategy logs for signal generation
   grep "strategy_id: my_strategy" /var/log/hft_system/strategies.log | tail -50

SPECIFIC SOLUTIONS:

Position Limit Exceeded:
```bash
# Check current positions:
curl -s http://localhost:8080/api/v1/positions | jq .

# Check risk limits:
curl -s http://localhost:8080/api/v1/risk/summary | jq .

# Solution 1: Close some positions
# Solution 2: Increase limit (if appropriate):
curl -X POST http://localhost:8080/api/v1/risk/limits \
  -d '{"position_limit_usd": 150000.00}'
```

Insufficient Balance:
```bash
# Check exchange balances:
./scripts/check_balances.sh binance

# If insufficient:
# - Transfer funds to exchange
# - Reduce order sizes
# - Close positions to free up capital
```

Order Size Too Small:
```bash
# Exchange minimum order sizes:
# Binance BTC-USDT: 0.00001 BTC (notional > $10)
# Coinbase BTC-USD: $1 minimum

# Check order being submitted:
grep "order.*quantity" /var/log/hft_system/orders.log | tail -5

# Adjust strategy parameters to increase order size
```

4.2 ORDERS STUCK IN PENDING STATE
----------------------------------

SYMPTOM: Orders show status "pending" for extended time (> 30 seconds)

DIAGNOSIS:
```bash
# Find pending orders:
curl -s http://localhost:8080/api/v1/orders?status=pending | jq '.orders[] | {order_id, created_at}'

# Check order age:
# If > 30 seconds, investigate

# Check exchange response:
grep "order_id: <ORDER_ID>" /var/log/hft_system/orders.log
```

SOLUTIONS:

Exchange Not Responding:
```bash
# Check exchange API status:
curl -I https://api.binance.com

# If exchange slow/down:
# - Wait for recovery
# - Cancel pending orders:
curl -X DELETE http://localhost:8080/api/v1/orders/<ORDER_ID>
```

Network Issue:
```bash
# Check network connectivity:
ping -c 5 api.binance.com

# Check for packet loss:
mtr -c 100 api.binance.com

# If network issues:
# - Check firewall rules
# - Check ISP status
# - Consider failover to backup connection
```

Order Lost in Flight:
```bash
# Query exchange directly for order status:
./scripts/query_exchange_order.sh binance <EXCHANGE_ORDER_ID>

# If order exists on exchange:
# - Update local state from exchange
curl -X POST http://localhost:8080/api/v1/orders/<ORDER_ID>/reconcile

# If order doesn't exist:
# - Mark as rejected locally
# - Investigate why ACK wasn't received
```

4.3 ORDERS REJECTED BY EXCHANGE
--------------------------------

SYMPTOM: Order status shows "rejected" with error message

DIAGNOSIS:
```bash
# Find rejected orders:
curl -s http://localhost:8080/api/v1/orders?status=rejected | jq '.orders[] | {order_id, error_message}'

# Common rejection reasons:
# - "Insufficient balance"
# - "Invalid symbol"
# - "Price too high/low"
# - "Invalid quantity"
# - "Rate limit exceeded"
```

SOLUTIONS BY ERROR TYPE:

"Insufficient balance":
```bash
# Check exchange balance:
./scripts/check_balances.sh binance

# Solutions:
# 1. Transfer more funds
# 2. Reduce order sizes
# 3. Close positions
```

"Invalid symbol":
```bash
# Verify symbol exists on exchange:
./scripts/list_symbols.sh binance | grep BTC-USDT

# Check symbol format:
# Binance: BTCUSDT (no dash)
# Coinbase: BTC-USD (with dash)

# Update strategy configuration with correct symbol
```

"Price filter violation":
```bash
# Each exchange has price filters (tick size, min/max price)
# Example error: "Price filter: price > 0.00000100 and < 1000000.00000000"

# Solution: Round price to exchange tick size
# Binance BTC-USDT tick size: 0.01
./scripts/get_exchange_filters.sh binance BTC-USDT
```

"LOT_SIZE violation":
```bash
# Quantity doesn't meet exchange requirements
# Example: "LOT_SIZE: qty > 0.00001 and qty % 0.00001 == 0"

# Solution: Round quantity to lot size
# Check exchange info:
./scripts/get_exchange_filters.sh binance BTC-USDT | jq .filters.LOT_SIZE
```

"Rate limit exceeded":
```bash
# Too many orders in short time

# Solution:
# 1. Reduce order rate in strategy
# 2. Implement local rate limiting
# 3. Spread orders across time

# Check current rate:
grep "order submit" /var/log/hft_system/orders.log | \
  tail -1000 | \
  awk '{print $1" "$2}' | \
  uniq -c
```

4.4 FILLS NOT UPDATING POSITIONS
---------------------------------

SYMPTOM: Order filled but position not updated

DIAGNOSIS:
```bash
# Check order status:
curl -s http://localhost:8080/api/v1/orders/<ORDER_ID> | jq .

# Check position:
curl -s http://localhost:8080/api/v1/positions | jq '.positions[] | select(.symbol=="BTC-USDT")'

# Check fill logs:
grep "fill.*<ORDER_ID>" /var/log/hft_system/orders.log
```

SOLUTIONS:

Fill Event Not Received:
```bash
# Force position reconciliation:
./scripts/reconcile_positions.sh binance

# This will:
# 1. Query exchange for actual positions
# 2. Update local database
# 3. Generate reconciliation report
```

Database Write Failed:
```bash
# Check database errors:
grep "database.*error" /var/log/hft_system/errors.log | tail -20

# If database issue:
# - Fix database connection
# - Replay fill events from logs
./scripts/replay_fills.sh --from="2025-11-25 10:00:00" --to="2025-11-25 11:00:00"
```

Position Manager Bug:
```bash
# Restart position manager (hot reload):
curl -X POST http://localhost:8080/api/v1/components/position_manager/restart

# Monitor logs for errors:
tail -f /var/log/hft_system/system.log | grep position
```

================================================================================
5. PERFORMANCE AND LATENCY PROBLEMS
================================================================================

5.1 HIGH LATENCY
----------------

SYMPTOM: P99 latency > 1ms for critical operations

DIAGNOSIS:
```bash
# Check current latency:
./scripts/latency_report.sh

# Check system metrics:
./scripts/performance_summary.sh

# Look at latency breakdown:
curl -s http://localhost:8080/api/v1/metrics | \
  grep latency | \
  jq -r '. | "\(.name): P50=\(.p50)us P99=\(.p99)us P999=\(.p999)us"'
```

TROUBLESHOOTING BY COMPONENT:

Market Data Latency:
```bash
# Check market data latency:
grep "latency_us" /var/log/hft_system/market_data.log | \
  tail -1000 | \
  awk '{sum+=$NF; count++} END {print "Average: " sum/count " μs"}'

# If high (> 100μs):

# 1. Check network latency:
ping -c 100 stream.binance.com | tail -1
# Expected: avg < 20ms for collocated

# 2. Check CPU usage:
top -bn1 | grep "hft_system"
# If CPU high, consider:
# - Reduce subscriptions
# - Optimize parsing code
# - Add more threads

# 3. Check queue depth:
curl -s http://localhost:8080/api/v1/metrics | grep market_data_queue_depth
# If queues full, increase queue size or add threads
```

Order Latency:
```bash
# Check order submission latency:
grep "order.*latency" /var/log/hft_system/orders.log | \
  tail -1000 | \
  awk -F'latency_us: ' '{sum+=$2; count++} END {print "Average: " sum/count " μs"}'

# If high (> 500μs):

# 1. Check risk check latency:
grep "risk check" /var/log/hft_system/risk.log | tail -100

# 2. Check database write latency:
grep "database write" /var/log/hft_system/system.log | tail -100

# 3. Check exchange API latency:
./scripts/test_exchange_latency.sh binance
```

End-to-End Latency:
```bash
# Measure signal-to-order time:
./scripts/measure_e2e_latency.sh

# If high:
# 1. Profile critical path:
./scripts/profile_critical_path.sh

# 2. Check for contention:
grep "lock contention\|mutex" /var/log/hft_system/system.log

# 3. Check for blocking operations:
./scripts/check_blocking_calls.sh
```

5.2 HIGH CPU USAGE
------------------

SYMPTOM: CPU usage > 80% sustained

DIAGNOSIS:
```bash
# Check CPU usage by thread:
top -H -p $(cat /var/run/hft_system.pid)

# Profile CPU usage:
./scripts/profile_cpu.sh 30  # Profile for 30 seconds

# Check for hot functions:
./scripts/analyze_cpu_profile.sh
```

SOLUTIONS:

Inefficient Market Data Processing:
```bash
# Reduce subscription count:
# Edit strategy configs to subscribe to fewer symbols

# Increase batch size:
# Edit config: market_data.batch_size = 100

# Sample low-priority data:
# Edit config: market_data.sample_rate = 0.1  # 10% sampling
```

Too Many Strategies:
```bash
# Check strategy count:
curl -s http://localhost:8080/api/v1/strategies | jq '.strategies | length'

# If many strategies:
# - Stop unused strategies
# - Consolidate similar strategies
# - Run strategies on separate nodes
```

Lock Contention:
```bash
# Check for contention:
./scripts/check_lock_contention.sh

# If found:
# - Review lock-free data structures
# - Reduce critical section size
# - Use finer-grained locks
```

Context Switching:
```bash
# Check context switch rate:
pidstat -w -p $(cat /var/run/hft_system.pid) 1 10

# If high (> 10,000/sec):
# - Reduce thread count
# - Pin threads to cores
# - Adjust thread priorities
```

5.3 HIGH MEMORY USAGE
---------------------

SYMPTOM: Memory usage growing or > 80% of available

DIAGNOSIS:
```bash
# Check memory usage:
free -h

# Check process memory:
ps aux | grep hft_system | awk '{print $6}'

# Check for memory leaks:
./scripts/check_memory_leak.sh

# Generate heap dump:
kill -USR1 $(cat /var/run/hft_system.pid)
./scripts/analyze_heap.sh /tmp/hft_heap_*.dump
```

SOLUTIONS:

Market Data Accumulation:
```bash
# Check order book memory usage:
curl -s http://localhost:8080/api/v1/metrics | grep orderbook_memory_mb

# If high:
# - Reduce order book depth
# - Increase cleanup frequency
# - Limit number of symbols
```

Order History Buildup:
```bash
# Check in-memory order count:
curl -s http://localhost:8080/api/v1/metrics | grep order_count

# If high:
# - Archive old orders to database
# - Reduce retention period
curl -X POST http://localhost:8080/api/v1/orders/archive \
  -d '{"older_than_hours": 24}'
```

Memory Leak:
```bash
# If memory continuously grows:

# 1. Take heap dump:
kill -USR1 $(cat /var/run/hft_system.pid)

# 2. Analyze for leaks:
./scripts/find_memory_leaks.sh /tmp/hft_heap_*.dump

# 3. If leak confirmed:
# - Report to engineering team
# - Schedule restart
# - Monitor closely
```

Insufficient Memory:
```bash
# If system genuinely needs more memory:

# 1. Check actual usage:
./scripts/memory_breakdown.sh

# 2. Options:
# - Add more RAM to server
# - Reduce workload (fewer exchanges/strategies)
# - Optimize data structures
# - Use memory mapping for large datasets
```

================================================================================
6. MEMORY AND RESOURCE ISSUES
================================================================================

6.1 OUT OF MEMORY (OOM)
-----------------------

SYMPTOM: Process killed by OOM killer

DIAGNOSIS:
```bash
# Check system logs for OOM:
dmesg | grep -i "out of memory"
grep "oom" /var/log/syslog

# Check memory limits:
ulimit -a | grep memory

# Check memory usage before crash:
cat /var/log/hft_system/metrics_$(date -d "yesterday" +%Y%m%d).log | grep memory | tail -100
```

SOLUTIONS:

Prevent Future OOM:
```bash
# 1. Increase system memory
# 2. Set memory limit for process:
systemctl edit hft_system.service
# Add:
# [Service]
# MemoryMax=64G
# MemoryHigh=60G

# 3. Enable memory monitoring:
./scripts/enable_memory_monitoring.sh --threshold=80 --action=alert

# 4. Implement memory pressure handling:
# Edit config:
# memory_management:
#   enable_pressure_handling: true
#   high_pressure_threshold: 0.8
#   actions:
#     - reduce_order_book_depth
#     - archive_old_orders
#     - sample_market_data
```

Emergency Recovery:
```bash
# If OOM just occurred:

# 1. Restart system:
./scripts/startup.sh

# 2. Reduce memory footprint:
# - Temporarily disable some strategies
# - Reduce order book depth
# - Limit symbols

# 3. Monitor closely:
watch -n 5 'free -h; ps aux | grep hft_system | awk "{print \$6}"'
```

6.2 DISK SPACE ISSUES
---------------------

SYMPTOM: Disk usage > 90%

DIAGNOSIS:
```bash
# Check disk usage:
df -h

# Find large directories:
du -h /var/log/hft_system | sort -rh | head -20
du -h /var/lib/postgresql | sort -rh | head -20

# Find large files:
find /var -type f -size +1G -exec ls -lh {} \;
```

SOLUTIONS:

Log Cleanup:
```bash
# Archive and compress old logs:
./scripts/archive_logs.sh --days=30

# Delete very old logs:
find /var/log/hft_system -name "*.log.*" -mtime +90 -delete

# Verify:
df -h
```

Database Cleanup:
```bash
# Drop old partitions:
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT drop_chunks('market_data_ticks', INTERVAL '90 days');
SELECT drop_chunks('order_book_snapshots', INTERVAL '90 days');
EOF

# Vacuum to reclaim space:
psql -h localhost -U hft_user -d hft_db -c "VACUUM FULL;"

# Move old data to archive storage:
./scripts/archive_market_data.sh --older-than-days=90
```

Core Dumps:
```bash
# Find and delete core dumps:
find /tmp -name "core.*" -delete
find /var/crash -type f -delete

# Disable core dumps if not needed:
ulimit -c 0
echo "ulimit -c 0" >> ~/.bashrc
```

6.3 FILE DESCRIPTOR EXHAUSTION
-------------------------------

SYMPTOM: "Too many open files" error

DIAGNOSIS:
```bash
# Check current limit:
ulimit -n

# Check process usage:
lsof -p $(cat /var/run/hft_system.pid) | wc -l

# Check system-wide:
cat /proc/sys/fs/file-nr
# Format: allocated  unused  max
```

SOLUTIONS:

Increase Limit:
```bash
# Temporary (current session):
ulimit -n 65536

# Permanent (edit /etc/security/limits.conf):
hft_user soft nofile 65536
hft_user hard nofile 65536

# System-wide (edit /etc/sysctl.conf):
fs.file-max = 2097152

# Apply:
sudo sysctl -p

# Restart system for changes to take effect
```

Find FD Leaks:
```bash
# Monitor FD usage over time:
watch -n 5 'lsof -p $(cat /var/run/hft_system.pid) | wc -l'

# If continuously growing:
# - Check for unclosed files
# - Check for socket leaks
# - Review WebSocket connection management

# List all FDs:
ls -l /proc/$(cat /var/run/hft_system.pid)/fd/

# Find many connections to same endpoint (possible leak):
lsof -p $(cat /var/run/hft_system.pid) | grep ESTABLISHED | sort | uniq -c | sort -rn
```

================================================================================
7. DATABASE ISSUES
================================================================================

7.1 SLOW QUERIES
----------------

SYMPTOM: Database queries taking > 100ms

DIAGNOSIS:
```bash
# Find slow queries:
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT pid, now() - query_start as duration, query
FROM pg_stat_activity
WHERE state = 'active' AND now() - query_start > interval '100 milliseconds'
ORDER BY duration DESC;
EOF

# Check query performance:
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT query, calls, total_time, mean_time, max_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 20;
EOF
```

SOLUTIONS:

Missing Index:
```bash
# Analyze query plan:
psql -h localhost -U hft_user -d hft_db <<EOF
EXPLAIN ANALYZE SELECT * FROM orders WHERE symbol = 'BTC-USDT' AND created_at > now() - interval '1 hour';
EOF

# If Seq Scan found, add index:
psql -h localhost -U hft_user -d hft_db <<EOF
CREATE INDEX CONCURRENTLY idx_orders_symbol_created ON orders(symbol, created_at);
EOF
```

Table Bloat:
```bash
# Check table bloat:
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
EOF

# Vacuum to reduce bloat:
psql -h localhost -U hft_user -d hft_db -c "VACUUM FULL market_data_ticks;"
```

Outdated Statistics:
```bash
# Update statistics:
psql -h localhost -U hft_user -d hft_db -c "ANALYZE market_data_ticks;"

# Enable auto-vacuum:
psql -h localhost -U hft_user -d hft_db <<EOF
ALTER TABLE market_data_ticks SET (autovacuum_enabled = true);
EOF
```

7.2 CONNECTION POOL ISSUES
---------------------------

SYMPTOM: "Connection pool exhausted" errors

DIAGNOSIS:
```bash
# Check connection count:
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT count(*), state FROM pg_stat_activity GROUP BY state;
EOF

# Check connection pool config:
grep "connection_pool" config/production.json
```

SOLUTIONS:

```bash
# Increase pool size (config):
vi config/production.json
# Set: "database": {"connection_pool_size": 50}

# Kill idle connections:
psql -h localhost -U postgres -d hft_db <<EOF
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname = 'hft_db' AND state = 'idle' AND state_change < now() - interval '30 minutes';
EOF

# Check for connection leaks:
# Monitor active connections over time
# Should not continuously grow
```

7.3 REPLICATION LAG (if using replication)
-------------------------------------------

SYMPTOM: Standby database is behind primary

DIAGNOSIS:
```bash
# On primary:
psql -h localhost -U hft_user -d hft_db -c "SELECT pg_current_wal_lsn();"

# On standby:
psql -h standby-host -U hft_user -d hft_db -c "SELECT pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn();"

# Calculate lag:
./scripts/check_replication_lag.sh
```

SOLUTIONS:
```bash
# Check network between primary and standby
# Increase standby resources
# Check for long-running queries on standby blocking replay
```

================================================================================
8. EXCHANGE-SPECIFIC PROBLEMS
================================================================================

8.1 BINANCE ISSUES
------------------

Rate Limiting:
```bash
# Binance uses weight-based rate limiting
# Check X-MBX-USED-WEIGHT-1M header in responses

# If rate limited (HTTP 429):
# - Reduce request frequency
# - Use WebSocket where possible
# - Implement exponential backoff
```

Listen Key Expiration:
```bash
# User data stream requires listen key refresh every 60 minutes
# Check logs for "listen key expired"

# Solution: System automatically refreshes
# If failing, check API key permissions
```

Symbol Delisting:
```bash
# Error: "Invalid symbol"
# Binance periodically delists pairs

# Check if symbol still exists:
curl -s "https://api.binance.com/api/v3/exchangeInfo" | jq '.symbols[] | select(.symbol=="BTCUSDT")'

# If not found, remove from strategy configuration
```

8.2 COINBASE ISSUES
-------------------

Sandbox vs Production:
```bash
# Ensure using correct endpoint
# Sandbox: https://api-public.sandbox.pro.coinbase.com
# Production: https://api.pro.coinbase.com

# Check config:
grep "coinbase" config/exchanges/coinbase.json | grep endpoint
```

Passphrase Issues:
```bash
# Coinbase requires API passphrase in addition to key/secret
# Error: "Invalid passphrase"

# Verify passphrase in configuration
# Regenerate API key if forgotten
```

Minimum Order Size:
```bash
# Coinbase has strict minimum order sizes
# BTC-USD: $1 minimum
# ETH-USD: $1 minimum

# Check order rejection logs
# Increase order size in strategy
```

8.3 KRAKEN ISSUES
-----------------

Counter-Based Rate Limiting:
```bash
# Kraken uses decreasing counter (max 15)
# Each API call costs 0-2 points
# Counter increases by 0.33 every second

# If "rate limit exceeded":
# - Slow down requests
# - Wait for counter to replenish
# - Use batch endpoints where available
```

Nonce Issues:
```bash
# Error: "Invalid nonce"
# Nonce must be increasing

# Causes:
# - System clock not synchronized
# - Multiple systems using same API key
# - Nonce wraparound (rare)

# Solutions:
# - Sync system time: ntpdate -s time.nist.gov
# - Use unique API keys per system
# - Check for clock drift
```

8.4 GENERAL EXCHANGE ISSUES
----------------------------

Maintenance Mode:
```bash
# Exchanges occasionally enter maintenance
# Symptoms: Connection refused, specific error codes

# Check exchange status:
./scripts/check_exchange_status.sh

# If in maintenance:
# - Disable affected exchange
# - Wait for maintenance to complete
# - Automatically reconnects when available
```

API Version Changes:
```bash
# Exchanges may deprecate old API versions

# Check for deprecation warnings in logs:
grep -i "deprecat" /var/log/hft_system/exchanges.log

# Update to newer API version:
# - Review exchange changelog
# - Update connector code
# - Test thoroughly before production
```

Geographic Restrictions:
```bash
# Some exchanges restrict by IP location
# Error: "Access denied" or "IP not allowed"

# Solutions:
# - Verify server location
# - Use allowed IPs only
# - Contact exchange for whitelist
```

================================================================================
9. STRATEGY ISSUES
================================================================================

9.1 STRATEGY NOT GENERATING SIGNALS
------------------------------------

SYMPTOM: Strategy running but no orders placed

DIAGNOSIS:
```bash
# Check strategy logs:
grep "strategy_id: my_strategy" /var/log/hft_system/strategies.log | tail -100

# Check if receiving market data:
grep "onMarketData.*my_strategy" /var/log/hft_system/strategies.log

# Check strategy parameters:
curl -s http://localhost:8080/api/v1/strategies/my_strategy | jq .config.parameters
```

SOLUTIONS:

Market Conditions:
```bash
# Strategy may be waiting for specific conditions
# Example: Spread too tight for market making

# Check current market:
curl -s http://localhost:8080/api/v1/marketdata/ticker/binance/BTC-USDT | jq .

# Adjust strategy parameters if needed
```

Strategy Logic Error:
```bash
# Enable debug logging for strategy:
curl -X PUT http://localhost:8080/api/v1/strategies/my_strategy/config \
  -d '{"log_level": "DEBUG"}'

# Review debug logs:
grep "DEBUG.*my_strategy" /var/log/hft_system/strategies.log | tail -200

# Look for:
# - Calculation errors
# - Unexpected conditions
# - Missing data
```

9.2 STRATEGY LOSING MONEY
--------------------------

SYMPTOM: Strategy P&L consistently negative

DIAGNOSIS:
```bash
# Check strategy performance:
curl -s http://localhost:8080/api/v1/strategies/my_strategy | jq .performance

# Analyze trades:
./scripts/analyze_strategy_trades.sh my_strategy --days=7

# Common causes:
# - Adverse selection
# - Fees too high
# - Market regime change
# - Bug in strategy logic
```

ACTIONS:

Immediate:
```bash
# Stop strategy to prevent further losses:
curl -X POST http://localhost:8080/api/v1/strategies/my_strategy/stop

# Review recent trades:
curl -s http://localhost:8080/api/v1/orders?strategy_id=my_strategy&limit=100 | jq .
```

Analysis:
```bash
# Generate detailed report:
./scripts/strategy_post_mortem.sh my_strategy

# Review:
# - Win rate
# - Average win/loss
# - Largest losses
# - Trade distribution
# - Execution quality
```

9.3 STRATEGY VIOLATING RISK LIMITS
-----------------------------------

SYMPTOM: Frequent risk violations in logs

DIAGNOSIS:
```bash
# Check risk violations:
curl -s http://localhost:8080/api/v1/risk/violations | jq .

# Check strategy positions:
curl -s http://localhost:8080/api/v1/positions | jq '.positions[] | select(.strategy=="my_strategy")'
```

SOLUTIONS:

```bash
# Reduce strategy position limits:
curl -X PUT http://localhost:8080/api/v1/strategies/my_strategy/config \
  -d '{
    "risk_limits": {
      "max_position_usd": 25000,
      "max_order_size_usd": 5000
    }
  }'

# Or adjust system-wide risk limits if appropriate:
curl -X POST http://localhost:8080/api/v1/risk/limits \
  -d '{"position_limit_usd": 200000.00}'
```

================================================================================
10. NETWORK AND CONNECTIVITY
================================================================================

10.1 NETWORK LATENCY SPIKES
----------------------------

SYMPTOM: Intermittent high latency to exchanges

DIAGNOSIS:
```bash
# Continuous ping to exchange:
ping -i 0.2 stream.binance.com > /tmp/ping_binance.log &
PING_PID=$!

# Monitor for 5 minutes
sleep 300

# Analyze results:
kill $PING_PID
cat /tmp/ping_binance.log | grep "time=" | awk -F'time=' '{print $2}' | awk '{print $1}' | sort -n | tail -20

# Check for packet loss:
cat /tmp/ping_binance.log | grep "packet loss"
```

SOLUTIONS:

Network Congestion:
```bash
# Check interface statistics:
ifconfig eth0 | grep -E "(RX|TX) packets"

# Check for errors:
netstat -i

# If errors/drops seen:
# - Check physical connection
# - Check switch/router
# - Check MTU settings
```

Route Changes:
```bash
# Trace route to exchange:
mtr --report --report-cycles=100 stream.binance.com

# Look for:
# - High latency hops
# - Packet loss at specific hops
# - Route changes

# If poor route:
# - Contact ISP
# - Consider alternative connectivity
# - Use VPN to different route
```

10.2 CONNECTION DROPS
---------------------

SYMPTOM: Frequent disconnect/reconnect cycles

DIAGNOSIS:
```bash
# Count disconnections:
grep "disconnect" /var/log/hft_system/exchanges.log | wc -l

# Check reconnection pattern:
grep -E "(disconnect|reconnect)" /var/log/hft_system/exchanges.log | tail -50

# Check system uptime:
uptime
```

SOLUTIONS:

Firewall Timeout:
```bash
# Check conntrack timeout:
cat /proc/sys/net/netfilter/nf_conntrack_tcp_timeout_established

# Increase if low (< 7200 seconds):
echo 86400 | sudo tee /proc/sys/net/netfilter/nf_conntrack_tcp_timeout_established

# Make permanent in /etc/sysctl.conf:
net.netfilter.nf_conntrack_tcp_timeout_established = 86400
```

Keep-Alive Settings:
```bash
# Enable TCP keep-alive:
sudo sysctl -w net.ipv4.tcp_keepalive_time=60
sudo sysctl -w net.ipv4.tcp_keepalive_intvl=10
sudo sysctl -w net.ipv4.tcp_keepalive_probes=6

# Application-level ping/pong already implemented
# Verify in config:
grep "heartbeat" config/production.json
```

NAT Issues:
```bash
# If behind NAT, ensure NAT table entries don't expire
# Increase NAT timeout on firewall/router

# Use persistent connections (already implemented)
# WebSocket connections maintained with heartbeats
```

================================================================================
11. MONITORING AND ALERTING ISSUES
================================================================================

11.1 ALERTS NOT FIRING
----------------------

SYMPTOM: Expected alerts not received

DIAGNOSIS:
```bash
# Check Prometheus:
curl -s http://localhost:9090/api/v1/query?query=up | jq .

# Check alert rules:
curl -s http://localhost:9090/api/v1/rules | jq '.data.groups[].rules[] | select(.type=="alerting")'

# Check alertmanager:
curl -s http://localhost:9093/api/v2/alerts | jq .
```

SOLUTIONS:

```bash
# Verify alert rules loaded:
promtool check rules /etc/prometheus/alerts/*.yml

# Reload Prometheus config:
curl -X POST http://localhost:9090/-/reload

# Test alert:
./scripts/test_alert.sh high_latency

# Check alert routing:
cat /etc/alertmanager/alertmanager.yml

# Check notification endpoints:
# - PagerDuty API key valid
# - Slack webhook working
# - Email SMTP configured
```

11.2 DASHBOARD NOT SHOWING DATA
--------------------------------

SYMPTOM: Grafana dashboard empty or missing data

DIAGNOSIS:
```bash
# Check if metrics endpoint is working:
curl -s http://localhost:8080/api/v1/metrics | head -20

# Check Prometheus is scraping:
curl -s 'http://localhost:9090/api/v1/query?query=up{job="hft_system"}' | jq .

# Check Grafana datasource:
# Navigate to Grafana -> Configuration -> Data Sources
```

SOLUTIONS:

```bash
# Verify Prometheus scrape config:
grep "hft_system" /etc/prometheus/prometheus.yml

# Should have:
# - job_name: 'hft_system'
#   static_configs:
#     - targets: ['localhost:8080']

# Reload Prometheus:
curl -X POST http://localhost:9090/-/reload

# Check Grafana datasource connection:
# Grafana UI -> Data Sources -> Test

# Refresh dashboard:
# Grafana UI -> Dashboard -> Refresh
```

================================================================================
12. COMMON ERROR MESSAGES
================================================================================

12.1 ERROR MESSAGE REFERENCE
-----------------------------

"Failed to load configuration"
├─ Cause: Config file missing or invalid JSON
└─ Solution: Check file path and JSON syntax with jq

"Database connection failed"
├─ Cause: PostgreSQL not running or wrong credentials
└─ Solution: Start database, verify connection string

"Failed to bind to port"
├─ Cause: Port already in use
└─ Solution: Kill process on port or change port in config

"Exchange connection timeout"
├─ Cause: Network issue or exchange down
└─ Solution: Check network, verify exchange status page

"Invalid signature"
├─ Cause: Wrong API secret or timestamp issue
└─ Solution: Verify API credentials, sync system clock

"Rate limit exceeded"
├─ Cause: Too many requests to exchange
└─ Solution: Reduce request rate, implement backoff

"Insufficient balance"
├─ Cause: Not enough funds on exchange
└─ Solution: Transfer funds or reduce order sizes

"Position limit exceeded"
├─ Cause: Attempting to exceed configured limit
└─ Solution: Close positions or increase limit

"Risk check failed"
├─ Cause: Order violates risk rules
└─ Solution: Review risk violation, adjust parameters

"Market data sequence gap"
├─ Cause: Missed WebSocket messages
└─ Solution: Reconnect, request snapshot

"Order book snapshot timeout"
├─ Cause: Exchange slow to respond
└─ Solution: Retry, check exchange status

"Fill not found for order"
├─ Cause: Missed fill notification
└─ Solution: Reconcile with exchange

"Strategy initialization failed"
├─ Cause: Invalid strategy configuration
└─ Solution: Check config, review error logs

"Memory allocation failed"
├─ Cause: Out of memory
└─ Solution: Restart system, investigate memory leak

"Database query timeout"
├─ Cause: Slow query or database overload
└─ Solution: Optimize query, scale database

"Lock acquisition timeout"
├─ Cause: Deadlock or long-held lock
└─ Solution: Restart component, review lock usage

"Thread pool exhausted"
├─ Cause: All threads busy
└─ Solution: Increase thread pool size, reduce load

"Queue full"
├─ Cause: Processing can't keep up with input rate
└─ Solution: Increase queue size, add threads, reduce input rate

"WebSocket connection closed"
├─ Cause: Normal disconnect or network issue
└─ Solution: Automatic reconnection, check logs for cause

"Heartbeat timeout"
├─ Cause: No heartbeat received from exchange
└─ Solution: Reconnect, check network

"Symbol not found"
├─ Cause: Trading pair doesn't exist on exchange
└─ Solution: Verify symbol, check exchange support

"Order modification not supported"
├─ Cause: Exchange doesn't support modification
└─ Solution: Cancel and replace order

"Invalid order type"
├─ Cause: Unsupported order type for exchange
└─ Solution: Use supported type (limit/market)

================================================================================
CONTACT INFORMATION
================================================================================

Level 1 Support (Operations):
- Email: operations@company.com
- Slack: #hft-operations
- Phone: +1-555-0100 (24/7)

Level 2 Support (Engineering):
- Email: platform-eng@company.com
- Slack: #hft-engineering
- Phone: +1-555-0101 (on-call)

Level 3 Support (Architecture):
- Email: architecture@company.com
- Escalation only

Emergency:
- PagerDuty: +1-555-0199
- Emergency Hotline: +1-555-0100

Exchange Support:
- See exchange-specific documentation for support contacts

================================================================================
DOCUMENT REVISION HISTORY
================================================================================

Version    Date          Author              Changes
------------------------------------------------------------------------
1.0        2025-11-25    Platform Team       Initial troubleshooting guide

================================================================================
END OF DOCUMENT
================================================================================
