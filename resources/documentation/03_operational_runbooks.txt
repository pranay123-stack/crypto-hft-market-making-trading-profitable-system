================================================================================
HFT SYSTEM OPERATIONAL RUNBOOKS
================================================================================

VERSION: 1.0
LAST UPDATED: 2025-11-25
OWNER: Operations Team
CLASSIFICATION: Internal Use Only

================================================================================
TABLE OF CONTENTS
================================================================================

1. SYSTEM STARTUP PROCEDURES
2. SYSTEM SHUTDOWN PROCEDURES
3. DAILY OPERATIONS CHECKLIST
4. EXCHANGE CONNECTOR MANAGEMENT
5. STRATEGY MANAGEMENT
6. DATABASE MAINTENANCE
7. LOG MANAGEMENT
8. BACKUP AND RESTORE PROCEDURES
9. FAILOVER PROCEDURES
10. HEALTH CHECK PROCEDURES
11. PERFORMANCE TUNING
12. EMERGENCY PROCEDURES

================================================================================
1. SYSTEM STARTUP PROCEDURES
================================================================================

1.1 PRE-STARTUP CHECKLIST
--------------------------

□ Verify all prerequisites are met
□ Check system resources (CPU, memory, disk)
□ Verify network connectivity to exchanges
□ Confirm database is running and accessible
□ Verify API keys are current and valid
□ Check monitoring systems are operational
□ Review any recent alerts or incidents
□ Confirm no planned exchange maintenance

Timeline: 10-15 minutes
Performed by: Operations Engineer
Frequency: Every system start

1.2 COLD START PROCEDURE (Complete System Start)
-------------------------------------------------

Step 1: Pre-Flight Checks
```bash
# Check system resources
free -h
df -h
top -bn1 | head -20

# Expected:
# - Available memory: > 64GB
# - Free disk space: > 500GB on /data
# - CPU load average: < 2.0
```

Step 2: Start Database (if not running)
```bash
sudo systemctl status timescaledb
sudo systemctl start timescaledb
sudo systemctl status timescaledb

# Verify database is accepting connections
psql -h localhost -U hft_user -d hft_db -c "SELECT 1;"

# Expected output: 1 row with value "1"
```

Step 3: Start Monitoring Stack
```bash
# Start Prometheus
sudo systemctl start prometheus
sudo systemctl status prometheus

# Start Grafana
sudo systemctl start grafana-server
sudo systemctl status grafana-server

# Verify dashboards are accessible
curl -s http://localhost:3000/api/health | jq .

# Expected: {"commit":"...","database":"ok","version":"..."}
```

Step 4: Load Configuration
```bash
cd /opt/hft_system

# Verify configuration files exist
ls -l config/production.json
ls -l config/exchanges/*.json
ls -l config/strategies/*.json

# Validate configuration syntax
./bin/hft_system --validate-config --config=config/production.json

# Expected output: "Configuration validation: PASSED"
```

Step 5: Start HFT System
```bash
# Set environment
export HFT_ENV=production
export HFT_CONFIG=/opt/hft_system/config/production.json

# Start the system
./bin/hft_system --config=$HFT_CONFIG --log-level=INFO &

# Save PID for later
echo $! > /var/run/hft_system.pid

# Monitor startup logs
tail -f /var/log/hft_system/system.log
```

Expected startup sequence in logs:
```
[INFO] Loading configuration from /opt/hft_system/config/production.json
[INFO] Initializing database connection
[INFO] Database connection established
[INFO] Loading exchange connectors
[INFO] Connecting to Binance... OK
[INFO] Connecting to Coinbase... OK
[INFO] Connecting to Kraken... OK
[... 7 more exchanges]
[INFO] All exchange connections established
[INFO] Initializing market data handlers
[INFO] Initializing order manager
[INFO] Initializing risk manager
[INFO] Loading strategies
[INFO] Strategy loaded: market_maker_btc
[INFO] Strategy loaded: arbitrage_eth
[INFO] System startup complete
[INFO] Status: READY (trading disabled)
```

Typical startup time: 30-60 seconds

Step 6: Verify System Health
```bash
# Check system status via API
curl -s http://localhost:8080/api/v1/status | jq .

# Expected: All exchanges "connected", trading_enabled: false
```

Step 7: Verify Market Data Flow
```bash
# Monitor market data events
tail -f /var/log/hft_system/market_data.log | grep "ticker"

# Should see continuous stream of ticker updates
# Expected rate: 10-100 events per second per exchange
```

Step 8: Enable Trading (When Ready)
```bash
# Enable trading via API
curl -X POST http://localhost:8080/api/v1/config \
  -H "Content-Type: application/json" \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{"trading_enabled": true}'

# Verify trading is enabled
curl -s http://localhost:8080/api/v1/status | jq .trading_enabled

# Expected: true
```

Step 9: Start Strategies
```bash
# Start each strategy individually
curl -X POST http://localhost:8080/api/v1/strategies/market_maker_btc/start \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE"

# Monitor strategy logs
tail -f /var/log/hft_system/strategies.log

# Expected: "Strategy market_maker_btc started successfully"
```

Step 10: Post-Startup Verification
```bash
# Run health check script
./scripts/health_check.sh

# Expected output:
# ✓ System running
# ✓ Database connection OK
# ✓ All exchanges connected
# ✓ Market data flowing
# ✓ Trading enabled
# ✓ Strategies running: 2/2
# ✓ Monitoring active
```

Total Cold Start Time: 5-10 minutes

1.3 WARM START PROCEDURE (Restart After Shutdown)
--------------------------------------------------

Step 1: Verify prerequisites (same as cold start steps 1-3)

Step 2: Reconcile positions with exchanges
```bash
# Run position reconciliation script
./scripts/reconcile_positions.sh

# This will:
# 1. Query each exchange for current positions
# 2. Compare with database state
# 3. Report any discrepancies
# 4. Generate reconciliation report

# Review reconciliation report
cat /var/log/hft_system/reconciliation_$(date +%Y%m%d).log

# Expected: All positions match, or minor differences explained
```

Step 3: Start system (steps 4-7 from cold start)

Step 4: Verify position state
```bash
# Check positions via API
curl -s http://localhost:8080/api/v1/positions | jq .

# Verify positions match reconciliation report
# Verify unrealized P&L is reasonable
```

Step 5: Enable trading and strategies (steps 8-9 from cold start)

Total Warm Start Time: 2-5 minutes

1.4 STARTUP TROUBLESHOOTING
----------------------------

Problem: System fails to start
Symptoms: Process exits immediately after start
Diagnosis:
```bash
# Check logs for errors
tail -100 /var/log/hft_system/system.log | grep ERROR

# Common errors:
# - "Failed to connect to database"
# - "Configuration file not found"
# - "Failed to bind to port 8080"
```

Solutions:
- Database error: Verify database is running, check connection string
- Config error: Verify file path and permissions
- Port binding error: Check if another process is using the port

Problem: Exchange connection failures
Symptoms: "Failed to connect to <exchange>" in logs
Diagnosis:
```bash
# Test network connectivity
ping -c 3 stream.binance.com
curl -I https://api.binance.com

# Check firewall rules
sudo iptables -L -n | grep 443

# Verify API keys
./scripts/verify_api_keys.sh binance
```

Solutions:
- Network: Check firewall, routing, DNS
- API key: Verify key is valid, not expired, has correct permissions
- Exchange maintenance: Check exchange status page

Problem: Strategies fail to start
Symptoms: Strategy status shows "stopped" or "error"
Diagnosis:
```bash
# Check strategy logs
grep "strategy_id: market_maker_btc" /var/log/hft_system/strategies.log | tail -50

# Common errors:
# - "Insufficient balance"
# - "Symbol not found"
# - "Risk limits not set"
```

Solutions:
- Balance: Check account balances on exchange
- Symbol: Verify symbol exists and is tradeable
- Risk: Configure risk limits before starting strategy

================================================================================
2. SYSTEM SHUTDOWN PROCEDURES
================================================================================

2.1 GRACEFUL SHUTDOWN (Planned Maintenance)
--------------------------------------------

Timeline: 5-10 minutes
Notice Required: 1 hour advance notice to trading desk

Step 1: Notify Stakeholders
```bash
# Send notification via Slack/Email
./scripts/notify_shutdown.sh "Planned maintenance at $(date)"

# Post status update
./scripts/update_status_page.sh "System shutdown in progress"
```

Step 2: Disable New Strategy Signals
```bash
# Stop strategies from generating new signals
# But allow existing orders to complete
curl -X POST http://localhost:8080/api/v1/config \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{"new_signals_enabled": false}'

# Wait 30 seconds for signal processing to complete
sleep 30
```

Step 3: Cancel All Open Orders
```bash
# Get list of open orders
curl -s http://localhost:8080/api/v1/orders?status=open | jq -r '.orders[].order_id' > /tmp/open_orders.txt

# Cancel each order
while read order_id; do
  curl -X DELETE http://localhost:8080/api/v1/orders/$order_id \
    -H "X-API-KEY: $API_KEY" \
    -H "X-TIMESTAMP: $TIMESTAMP" \
    -H "X-SIGNATURE: $SIGNATURE"
  echo "Cancelled order: $order_id"
  sleep 0.1
done < /tmp/open_orders.txt

# Verify all orders cancelled
OPEN_COUNT=$(curl -s http://localhost:8080/api/v1/orders?status=open | jq '.orders | length')
echo "Remaining open orders: $OPEN_COUNT"

# Expected: 0
```

Step 4: Stop All Strategies
```bash
# Get list of running strategies
curl -s http://localhost:8080/api/v1/strategies | jq -r '.strategies[] | select(.status=="running") | .strategy_id' > /tmp/running_strategies.txt

# Stop each strategy
while read strategy_id; do
  curl -X POST http://localhost:8080/api/v1/strategies/$strategy_id/stop \
    -H "X-API-KEY: $API_KEY" \
    -H "X-TIMESTAMP: $TIMESTAMP" \
    -H "X-SIGNATURE: $SIGNATURE"
  echo "Stopped strategy: $strategy_id"
  sleep 1
done < /tmp/running_strategies.txt
```

Step 5: Disable Trading
```bash
curl -X POST http://localhost:8080/api/v1/config \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{"trading_enabled": false}'

# Wait for in-flight operations to complete
sleep 10
```

Step 6: Take Position Snapshot
```bash
# Save current positions to file
curl -s http://localhost:8080/api/v1/positions | jq . > /var/backup/positions_$(date +%Y%m%d_%H%M%S).json

# Verify positions are saved
ls -lh /var/backup/positions_*.json | tail -1
```

Step 7: Flush Logs and Metrics
```bash
# Force log flush
kill -USR1 $(cat /var/run/hft_system.pid)

# Wait for flush
sleep 5

# Verify logs are written
ls -lh /var/log/hft_system/*.log
```

Step 8: Stop HFT System
```bash
# Send graceful shutdown signal
kill -TERM $(cat /var/run/hft_system.pid)

# Monitor shutdown
tail -f /var/log/hft_system/system.log

# Expected log sequence:
# [INFO] Shutdown signal received
# [INFO] Stopping market data handlers
# [INFO] Closing exchange connections
# [INFO] Flushing database writes
# [INFO] Shutdown complete

# Wait for process to exit (max 30 seconds)
for i in {1..30}; do
  if ! ps -p $(cat /var/run/hft_system.pid) > /dev/null 2>&1; then
    echo "System stopped cleanly"
    break
  fi
  sleep 1
done
```

Step 9: Verify Clean Shutdown
```bash
# Check no HFT processes running
ps aux | grep hft_system | grep -v grep

# Expected: No output

# Check for any orphaned connections
netstat -an | grep ESTABLISHED | grep -E "(8080|8081|8443|8444)"

# Expected: No output

# Verify data integrity
./scripts/verify_data_integrity.sh

# Expected: "Data integrity check: PASSED"
```

Step 10: Post-Shutdown Tasks
```bash
# Update status page
./scripts/update_status_page.sh "System offline for maintenance"

# Send completion notification
./scripts/notify_shutdown.sh "Shutdown complete at $(date)"

# Archive logs
./scripts/archive_logs.sh $(date +%Y%m%d)
```

2.2 EMERGENCY SHUTDOWN (Critical Issue)
----------------------------------------

Timeline: 30-60 seconds
Used when: System malfunction, market anomaly, security breach

Step 1: Activate Kill Switch
```bash
# Immediate stop of all trading
curl -X POST http://localhost:8080/api/v1/killswitch \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{"reason": "Emergency stop - [REASON]"}'

# This will:
# - Cancel all open orders immediately
# - Stop all strategies
# - Disable trading
# - Close exchange connections
```

Step 2: Force Stop Process (if API unresponsive)
```bash
# Send SIGTERM
kill $(cat /var/run/hft_system.pid)

# Wait 5 seconds
sleep 5

# If still running, force kill
if ps -p $(cat /var/run/hft_system.pid) > /dev/null 2>&1; then
  kill -9 $(cat /var/run/hft_system.pid)
fi
```

Step 3: Isolate System (if security issue)
```bash
# Block all network traffic
sudo iptables -P INPUT DROP
sudo iptables -P OUTPUT DROP
sudo iptables -P FORWARD DROP

# Allow only SSH from trusted IPs
sudo iptables -A INPUT -p tcp --dport 22 -s TRUSTED_IP -j ACCEPT
```

Step 4: Notify All Stakeholders
```bash
# Emergency notification
./scripts/emergency_notification.sh "EMERGENCY SHUTDOWN: [REASON]"

# Page on-call engineer
./scripts/page_oncall.sh "EMERGENCY: System stopped - [REASON]"

# Update status page
./scripts/update_status_page.sh "EMERGENCY: System offline"
```

2.3 SHUTDOWN TROUBLESHOOTING
-----------------------------

Problem: System won't stop gracefully
Diagnosis:
```bash
# Check what threads are blocking
sudo gdb -p $(cat /var/run/hft_system.pid)
(gdb) thread apply all bt
(gdb) quit

# Check for network operations
sudo lsof -p $(cat /var/run/hft_system.pid) | grep ESTABLISHED
```

Solution:
- Wait up to 60 seconds for graceful shutdown
- If still running, use kill -9
- Investigate root cause after shutdown

Problem: Orders fail to cancel
Diagnosis:
```bash
# Check exchange API status
curl -I https://api.binance.com

# Check for error responses
tail -100 /var/log/hft_system/orders.log | grep "cancel.*failed"
```

Solution:
- Manually cancel via exchange web UI if needed
- Report issue to exchange support
- Document uncancelled orders for reconciliation

================================================================================
3. DAILY OPERATIONS CHECKLIST
================================================================================

3.1 MORNING CHECKLIST (9:00 AM UTC)
------------------------------------

□ Review overnight alerts and incidents
```bash
# Check alert history
./scripts/check_alerts.sh --since="24 hours ago"
```

□ Verify system health
```bash
./scripts/health_check.sh
```

□ Check exchange connectivity
```bash
curl -s http://localhost:8080/api/v1/status | jq '.exchanges'
```

□ Review position status
```bash
curl -s http://localhost:8080/api/v1/positions | jq .
```

□ Check overnight P&L
```bash
./scripts/daily_pnl_report.sh $(date -d "yesterday" +%Y-%m-%d)
```

□ Verify strategy performance
```bash
curl -s http://localhost:8080/api/v1/strategies | jq '.strategies[] | {id: .strategy_id, status: .status, pnl: .performance.daily_pnl_usd}'
```

□ Check disk space and resources
```bash
df -h | grep -E "(Filesystem|/data)"
free -h
```

□ Review system logs for errors
```bash
grep ERROR /var/log/hft_system/system.log | tail -50
```

□ Verify backups completed successfully
```bash
ls -lh /var/backup/daily/ | tail -5
./scripts/verify_backup.sh $(date -d "yesterday" +%Y%m%d)
```

□ Check for exchange maintenance announcements
```bash
./scripts/check_exchange_status.sh
```

Time Required: 15-20 minutes

3.2 MID-DAY CHECKLIST (1:00 PM UTC)
------------------------------------

□ Spot check system metrics
```bash
./scripts/check_metrics.sh
```

□ Review trading activity
```bash
# Orders in last hour
curl -s http://localhost:8080/api/v1/orders?limit=100 | jq '.orders | length'

# Fills in last hour
./scripts/fill_report.sh --hours=1
```

□ Check risk limits utilization
```bash
curl -s http://localhost:8080/api/v1/risk/summary | jq .
```

□ Verify no unusual latency
```bash
./scripts/latency_report.sh --minutes=60
```

Time Required: 5-10 minutes

3.3 END OF DAY CHECKLIST (11:00 PM UTC)
----------------------------------------

□ Generate daily trading report
```bash
./scripts/daily_trading_report.sh $(date +%Y-%m-%d)
```

□ Reconcile positions with exchanges
```bash
./scripts/reconcile_positions.sh
```

□ Review and acknowledge alerts
```bash
./scripts/acknowledge_alerts.sh --date=$(date +%Y-%m-%d)
```

□ Verify log rotation
```bash
ls -lh /var/log/hft_system/*.log
```

□ Check database size and growth
```bash
./scripts/database_stats.sh
```

□ Review performance metrics
```bash
./scripts/performance_summary.sh
```

□ Initiate daily backup
```bash
./scripts/backup_daily.sh
```

□ Update operations log
```bash
./scripts/update_ops_log.sh "$(date +%Y-%m-%d) - Normal operations, no incidents"
```

Time Required: 20-30 minutes

3.4 WEEKLY CHECKLIST (Sunday 2:00 AM UTC)
------------------------------------------

□ Generate weekly performance report
□ Review and archive old logs (>30 days)
□ Check database statistics and optimize
□ Review and rotate API keys (if due)
□ Update system documentation
□ Test failover procedures (if scheduled)
□ Review and update risk limits
□ Check for software updates
□ Conduct security scan
□ Review incident reports from week

Time Required: 2-3 hours

================================================================================
4. EXCHANGE CONNECTOR MANAGEMENT
================================================================================

4.1 ADDING A NEW EXCHANGE
--------------------------

Step 1: Configure Exchange Credentials
```bash
# Create exchange config file
cat > config/exchanges/new_exchange.json <<EOF
{
  "exchange_id": "new_exchange",
  "enabled": true,
  "api_key": "ENCRYPTED_KEY",
  "api_secret": "ENCRYPTED_SECRET",
  "endpoints": {
    "rest": "https://api.newexchange.com",
    "websocket": "wss://ws.newexchange.com"
  },
  "rate_limits": {
    "orders_per_second": 50,
    "requests_per_minute": 1200
  },
  "symbols": ["BTC-USDT", "ETH-USDT"]
}
EOF
```

Step 2: Test Exchange Connectivity
```bash
# Test REST API
./bin/test_exchange --exchange=new_exchange --test=rest

# Test WebSocket
./bin/test_exchange --exchange=new_exchange --test=websocket

# Expected: All tests pass
```

Step 3: Add to Main Configuration
```bash
# Edit production config
vi config/production.json

# Add to exchanges array:
{
  "exchanges": [
    ... existing exchanges ...,
    "new_exchange"
  ]
}
```

Step 4: Hot-Reload Configuration
```bash
# Reload without restart
curl -X GET http://localhost:8080/api/v1/config/reload \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE"
```

Step 5: Verify Exchange Connection
```bash
# Check status
curl -s http://localhost:8080/api/v1/status | jq '.exchanges.new_exchange'

# Expected: {"status": "connected", "latency_ms": <number>}
```

Step 6: Enable Trading on Exchange
```bash
# Start with paper trading mode for 24 hours
curl -X PUT http://localhost:8080/api/v1/config \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{
    "exchanges": {
      "new_exchange": {
        "trading": false,
        "market_data": true
      }
    }
  }'

# After 24h verification, enable trading
# ... (same command with "trading": true)
```

4.2 DISABLING AN EXCHANGE
--------------------------

Step 1: Stop Strategies on Exchange
```bash
# Find strategies using exchange
curl -s http://localhost:8080/api/v1/strategies | jq '.strategies[] | select(.exchanges[] == "binance") | .strategy_id'

# Stop each strategy
# ... (use strategy stop endpoint)
```

Step 2: Cancel Open Orders
```bash
# Cancel all orders on exchange
curl -s http://localhost:8080/api/v1/orders?exchange=binance&status=open | jq -r '.orders[].order_id' | while read order_id; do
  curl -X DELETE http://localhost:8080/api/v1/orders/$order_id \
    -H "X-API-KEY: $API_KEY" \
    -H "X-TIMESTAMP: $TIMESTAMP" \
    -H "X-SIGNATURE: $SIGNATURE"
done
```

Step 3: Disable Exchange
```bash
curl -X PUT http://localhost:8080/api/v1/config \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{
    "exchanges": {
      "binance": {
        "enabled": false
      }
    }
  }'
```

Step 4: Verify Exchange Disabled
```bash
curl -s http://localhost:8080/api/v1/status | jq '.exchanges.binance.status'

# Expected: "disabled"
```

4.3 RECONNECTING EXCHANGE
-------------------------

Automatic Reconnection:
- System automatically reconnects on connection loss
- Exponential backoff: 1s, 2s, 4s, 8s, max 60s
- No manual intervention required for temporary disconnects

Manual Reconnection:
```bash
# If exchange stuck in error state
curl -X POST http://localhost:8080/api/v1/exchanges/binance/reconnect \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE"

# Monitor reconnection
tail -f /var/log/hft_system/exchanges.log | grep binance
```

================================================================================
5. STRATEGY MANAGEMENT
================================================================================

5.1 DEPLOYING A NEW STRATEGY
-----------------------------

Step 1: Create Strategy Configuration
```bash
cat > config/strategies/my_new_strategy.json <<EOF
{
  "strategy_id": "my_new_strategy",
  "name": "My New Strategy",
  "type": "custom",
  "enabled": false,
  "exchanges": ["binance", "coinbase"],
  "symbols": ["BTC-USDT"],
  "parameters": {
    "param1": 10,
    "param2": 0.5
  },
  "risk_limits": {
    "max_position_usd": 50000,
    "max_order_size_usd": 10000
  }
}
EOF
```

Step 2: Validate Strategy Configuration
```bash
./bin/hft_system --validate-strategy config/strategies/my_new_strategy.json

# Expected: "Strategy validation: PASSED"
```

Step 3: Deploy Strategy Code (if new code)
```bash
# Build strategy library
cd /opt/hft_system/strategies
mkdir my_new_strategy
# ... copy strategy code ...
cmake --build build --target my_new_strategy

# Expected: Strategy library built successfully
```

Step 4: Load Strategy (hot reload)
```bash
curl -X POST http://localhost:8080/api/v1/strategies/load \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{
    "config_file": "config/strategies/my_new_strategy.json"
  }'
```

Step 5: Verify Strategy Loaded
```bash
curl -s http://localhost:8080/api/v1/strategies | jq '.strategies[] | select(.strategy_id=="my_new_strategy")'

# Expected: Strategy details, status: "stopped"
```

Step 6: Start Strategy in Paper Trading Mode
```bash
# First 24 hours in paper trading
curl -X PUT http://localhost:8080/api/v1/strategies/my_new_strategy/config \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{"paper_trading": true}'

curl -X POST http://localhost:8080/api/v1/strategies/my_new_strategy/start \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE"
```

Step 7: Monitor Strategy Performance
```bash
# Monitor logs
tail -f /var/log/hft_system/strategies.log | grep my_new_strategy

# Check metrics
./scripts/strategy_metrics.sh my_new_strategy

# Review after 24 hours paper trading
./scripts/strategy_report.sh my_new_strategy --days=1
```

Step 8: Enable Live Trading (after validation)
```bash
curl -X PUT http://localhost:8080/api/v1/strategies/my_new_strategy/config \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{"paper_trading": false}'
```

5.2 UPDATING STRATEGY PARAMETERS
---------------------------------

```bash
# Update parameters without restart
curl -X PUT http://localhost:8080/api/v1/strategies/my_strategy/config \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{
    "parameters": {
      "spread_bps": 15,
      "order_size": 0.2
    }
  }'

# Verify parameters updated
curl -s http://localhost:8080/api/v1/strategies/my_strategy | jq '.config.parameters'
```

5.3 STOPPING AND REMOVING A STRATEGY
-------------------------------------

```bash
# Stop strategy
curl -X POST http://localhost:8080/api/v1/strategies/my_strategy/stop \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{"cancel_orders": true}'

# Wait for clean stop
sleep 5

# Unload strategy
curl -X DELETE http://localhost:8080/api/v1/strategies/my_strategy \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE"
```

================================================================================
6. DATABASE MAINTENANCE
================================================================================

6.1 DAILY DATABASE TASKS
-------------------------

Check Database Size:
```bash
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;
EOF
```

Vacuum Large Tables:
```bash
psql -h localhost -U hft_user -d hft_db <<EOF
VACUUM ANALYZE market_data_ticks;
VACUUM ANALYZE orders;
VACUUM ANALYZE fills;
EOF
```

6.2 WEEKLY DATABASE TASKS
--------------------------

Reindex Tables:
```bash
psql -h localhost -U hft_user -d hft_db <<EOF
REINDEX TABLE market_data_ticks;
REINDEX TABLE orders;
REINDEX TABLE fills;
EOF
```

Update Statistics:
```bash
psql -h localhost -U hft_user -d hft_db -c "ANALYZE;"
```

6.3 MONTHLY DATABASE TASKS
---------------------------

Partition Management (TimescaleDB):
```bash
# Drop old partitions (older than 90 days)
psql -h localhost -U hft_user -d hft_db <<EOF
SELECT drop_chunks('market_data_ticks', INTERVAL '90 days');
SELECT drop_chunks('order_book_snapshots', INTERVAL '90 days');
EOF
```

Database Backup:
```bash
# Full backup
./scripts/backup_database.sh --type=full

# Verify backup
./scripts/verify_backup.sh
```

================================================================================
7. LOG MANAGEMENT
================================================================================

7.1 LOG LOCATIONS
-----------------

System Logs:
- /var/log/hft_system/system.log - Main system log
- /var/log/hft_system/market_data.log - Market data events
- /var/log/hft_system/orders.log - Order lifecycle
- /var/log/hft_system/strategies.log - Strategy execution
- /var/log/hft_system/risk.log - Risk events
- /var/log/hft_system/errors.log - Error-level messages only

7.2 LOG ROTATION
----------------

Automatic rotation configured via logrotate:
```bash
cat /etc/logrotate.d/hft_system
```

Contents:
```
/var/log/hft_system/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 hft_user hft_group
    postrotate
        kill -USR1 $(cat /var/run/hft_system.pid)
    endscript
}
```

Manual rotation:
```bash
sudo logrotate -f /etc/logrotate.d/hft_system
```

7.3 LOG ARCHIVAL
----------------

Archive old logs to S3:
```bash
./scripts/archive_logs.sh --days=30

# This will:
# 1. Compress logs older than 30 days
# 2. Upload to S3
# 3. Delete local copies after verification
```

7.4 LOG ANALYSIS
----------------

Search for errors in last hour:
```bash
grep -E "(ERROR|CRITICAL)" /var/log/hft_system/system.log | \
  awk -v d="$(date -d '1 hour ago' '+%Y-%m-%d %H:%M:%S')" '$0 > d'
```

Analyze order flow:
```bash
./scripts/analyze_orders.sh --start="2025-11-25 00:00:00" --end="2025-11-25 23:59:59"
```

Generate latency report from logs:
```bash
grep "latency_us" /var/log/hft_system/market_data.log | \
  awk '{sum+=$NF; count++} END {print "Average latency: " sum/count " μs"}'
```

================================================================================
8. BACKUP AND RESTORE PROCEDURES
================================================================================

8.1 BACKUP STRATEGY
-------------------

Daily Backups (Automated):
- Database: Full backup at 00:00 UTC
- Configuration: Incremental backup every hour
- Logs: Continuous shipping to S3
- Metrics: Retention in Prometheus (90 days)

Weekly Backups:
- Full system snapshot
- Archived to offsite storage

8.2 DATABASE BACKUP
-------------------

Full Backup:
```bash
./scripts/backup_database.sh --type=full

# Manual command:
pg_dump -h localhost -U hft_user -Fc hft_db > \
  /var/backup/hft_db_$(date +%Y%m%d_%H%M%S).dump

# Verify backup
pg_restore --list /var/backup/hft_db_$(date +%Y%m%d_%H%M%S).dump | wc -l

# Expected: Non-zero number of objects
```

Incremental Backup:
```bash
# TimescaleDB continuous aggregates are automatically maintained
# Point-in-time recovery enabled via WAL archiving
```

8.3 DATABASE RESTORE
--------------------

Full Restore:
```bash
# Stop HFT system
./scripts/shutdown.sh

# Drop existing database
psql -h localhost -U postgres <<EOF
DROP DATABASE hft_db;
CREATE DATABASE hft_db OWNER hft_user;
EOF

# Restore from backup
pg_restore -h localhost -U hft_user -d hft_db \
  /var/backup/hft_db_20251125_000000.dump

# Verify restore
psql -h localhost -U hft_user -d hft_db -c "\dt"

# Restart HFT system
./scripts/startup.sh
```

Point-in-Time Restore:
```bash
# Restore to specific timestamp
./scripts/restore_database.sh --timestamp="2025-11-25 10:30:00"

# This will:
# 1. Restore base backup
# 2. Replay WAL logs up to specified time
# 3. Verify data integrity
```

8.4 CONFIGURATION BACKUP
-------------------------

```bash
# Backup all configuration
./scripts/backup_config.sh

# Manual backup
tar -czf /var/backup/config_$(date +%Y%m%d_%H%M%S).tar.gz \
  /opt/hft_system/config/

# Configuration is also in Git
cd /opt/hft_system
git add config/
git commit -m "Config backup $(date)"
git push origin main
```

8.5 DISASTER RECOVERY DRILL
----------------------------

Monthly DR drill procedure:

1. Notify team of DR drill
2. Take snapshot of production system
3. Provision DR environment
4. Restore latest backups
5. Verify system functionality
6. Measure recovery time
7. Document lessons learned
8. Cleanup DR environment

Expected Recovery Time Objective (RTO): 1 hour
Expected Recovery Point Objective (RPO): 5 minutes

================================================================================
9. FAILOVER PROCEDURES
================================================================================

9.1 AUTOMATIC FAILOVER
-----------------------

Trigger Conditions:
- Primary heartbeat timeout (3 consecutive misses = 3 seconds)
- Primary health check failure
- CPU > 95% for 60 seconds
- Memory exhausted
- Critical error in logs

Failover Sequence (Automatic):
1. Standby detects primary failure
2. Standby verifies failure (double-check)
3. Standby acquires database lock
4. Standby loads positions from database
5. Standby connects to all exchanges
6. Standby resumes trading
7. Alert sent to on-call engineer

Total Failover Time: < 5 seconds

9.2 MANUAL FAILOVER
-------------------

Step 1: Verify Primary is Down/Unhealthy
```bash
# Check primary status
ssh hft-prod-01 './scripts/health_check.sh'

# If unresponsive or unhealthy, proceed with failover
```

Step 2: Stop Primary (if still running)
```bash
ssh hft-prod-01 './scripts/shutdown.sh --force'
```

Step 3: Promote Standby to Primary
```bash
ssh hft-prod-02 './scripts/promote_to_primary.sh'

# This will:
# 1. Update role to primary
# 2. Acquire database lock
# 3. Start trading
# 4. Update load balancer (if applicable)
```

Step 4: Verify Standby is Now Primary
```bash
ssh hft-prod-02 'curl -s http://localhost:8080/api/v1/status | jq .role'

# Expected: "primary"
```

Step 5: Notify Stakeholders
```bash
./scripts/notify_failover.sh "Manual failover to hft-prod-02 completed"
```

Step 6: Investigate Primary Failure
```bash
ssh hft-prod-01 'tail -1000 /var/log/hft_system/system.log'
# Analyze logs, system metrics, etc.
```

Step 7: Repair Primary (if needed)
```bash
# Fix issues on primary
# Restart as standby
ssh hft-prod-01 './scripts/startup.sh --role=standby'
```

9.3 FAILBACK PROCEDURE
----------------------

After primary is repaired, failback to original configuration:

Step 1: Verify Primary is Healthy
```bash
ssh hft-prod-01 './scripts/health_check.sh'

# Expected: All checks pass
```

Step 2: Synchronize State
```bash
# Ensure primary has latest positions
ssh hft-prod-01 './scripts/sync_from_database.sh'
```

Step 3: Schedule Failback Window
```bash
# Coordinate with trading desk for low-activity period
# Typically during market close or low volume hours
```

Step 4: Execute Failback
```bash
# Stop trading on current primary (prod-02)
ssh hft-prod-02 './scripts/graceful_shutdown.sh'

# Start primary (prod-01)
ssh hft-prod-01 './scripts/startup.sh --role=primary'

# Convert prod-02 back to standby
ssh hft-prod-02 './scripts/startup.sh --role=standby'
```

Step 5: Verify Failback
```bash
ssh hft-prod-01 'curl -s http://localhost:8080/api/v1/status | jq .role'
ssh hft-prod-02 'curl -s http://localhost:8080/api/v1/status | jq .role'

# Expected: prod-01 is "primary", prod-02 is "standby"
```

================================================================================
10. HEALTH CHECK PROCEDURES
================================================================================

10.1 AUTOMATED HEALTH CHECKS
-----------------------------

Runs every 60 seconds via cron:
```bash
*/1 * * * * /opt/hft_system/scripts/health_check.sh >> /var/log/hft_system/health.log 2>&1
```

Health Check Components:
- Process running (PID exists and responsive)
- API accessible (HTTP 200 from /health endpoint)
- Database connectivity
- Exchange connections (all connected)
- Market data flowing (events in last 60 seconds)
- Disk space (> 20% free)
- Memory available (> 10% free)
- CPU load (< 80%)

10.2 MANUAL HEALTH CHECK
-------------------------

```bash
./scripts/health_check.sh --verbose

# Output:
# ========================================
# HFT System Health Check
# ========================================
# [✓] Process Running: PID 12345
# [✓] API Responsive: 200 OK
# [✓] Database Connected: OK
# [✓] Exchanges Connected: 10/10
#     - Binance: OK (latency: 12ms)
#     - Coinbase: OK (latency: 18ms)
#     - Kraken: OK (latency: 22ms)
#     ...
# [✓] Market Data Flowing: 1234 events/sec
# [✓] Disk Space: 65% used (OK)
# [✓] Memory: 45% used (OK)
# [✓] CPU Load: 0.42 (OK)
# [✓] Strategies Running: 2/2
# ========================================
# Overall Status: HEALTHY
# ========================================
```

10.3 COMPONENT-SPECIFIC HEALTH CHECKS
--------------------------------------

Exchange Health:
```bash
./scripts/check_exchange_health.sh binance

# Checks:
# - WebSocket connection
# - REST API accessibility
# - Market data latency
# - Order submission working
```

Strategy Health:
```bash
./scripts/check_strategy_health.sh market_maker_btc

# Checks:
# - Strategy running
# - Orders being placed
# - P&L reasonable
# - No excessive risk violations
```

Database Health:
```bash
./scripts/check_database_health.sh

# Checks:
# - Connection pool status
# - Long-running queries
# - Table bloat
# - Replication lag (if applicable)
```

================================================================================
11. PERFORMANCE TUNING
================================================================================

11.1 CPU OPTIMIZATION
---------------------

Thread Pinning:
```bash
# Pin critical threads to specific cores
./scripts/pin_threads.sh

# This sets CPU affinity:
# - Market data threads: Cores 0-9
# - Order threads: Cores 10-13
# - Strategy threads: Cores 14-19
# - System threads: Cores 20-31
```

CPU Governor:
```bash
# Set to performance mode
echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# Verify
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
# Expected: performance
```

11.2 MEMORY OPTIMIZATION
-------------------------

Huge Pages:
```bash
# Configure huge pages (2MB)
echo 4096 | sudo tee /proc/sys/vm/nr_hugepages

# Verify
cat /proc/meminfo | grep HugePages_Free
# Expected: 4096 (or close to it)

# System uses huge pages automatically
```

Memory Locking:
```bash
# Ensure system has permission to lock memory
ulimit -l unlimited

# System locks critical data structures in RAM
```

11.3 NETWORK OPTIMIZATION
--------------------------

TCP Tuning:
```bash
# Apply optimal TCP settings
sudo sysctl -w net.ipv4.tcp_nodelay=1
sudo sysctl -w net.ipv4.tcp_low_latency=1
sudo sysctl -w net.core.rmem_max=134217728
sudo sysctl -w net.core.wmem_max=134217728
sudo sysctl -w net.ipv4.tcp_rmem="4096 87380 67108864"
sudo sysctl -w net.ipv4.tcp_wmem="4096 65536 67108864"

# Make permanent
sudo tee -a /etc/sysctl.conf <<EOF
net.ipv4.tcp_nodelay=1
net.ipv4.tcp_low_latency=1
net.core.rmem_max=134217728
net.core.wmem_max=134217728
net.ipv4.tcp_rmem=4096 87380 67108864
net.ipv4.tcp_wmem=4096 65536 67108864
EOF
```

11.4 DISK I/O OPTIMIZATION
---------------------------

Scheduler:
```bash
# Set to noop or none for SSDs
echo noop | sudo tee /sys/block/nvme0n1/queue/scheduler

# Verify
cat /sys/block/nvme0n1/queue/scheduler
# Expected: [noop]
```

Mount Options:
```bash
# Add noatime to reduce writes
# Edit /etc/fstab:
/dev/nvme0n1p1  /data  ext4  noatime,nodiratime  0  2

# Remount
sudo mount -o remount /data
```

================================================================================
12. EMERGENCY PROCEDURES
================================================================================

12.1 KILL SWITCH ACTIVATION
----------------------------

When to use:
- Unusual market conditions
- System behaving erratically
- Large unexpected losses
- Security breach detected
- Regulatory requirement

Procedure:
```bash
# Method 1: Via API
curl -X POST http://localhost:8080/api/v1/killswitch \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{"reason": "Emergency stop - [SPECIFIC REASON]"}'

# Method 2: Via command line
./scripts/killswitch.sh "[SPECIFIC REASON]"

# Method 3: Direct process signal
kill -USR2 $(cat /var/run/hft_system.pid)
```

Effects:
- All open orders cancelled immediately
- All strategies stopped
- Trading disabled
- Exchange connections maintained (for order status)
- System remains running for monitoring

Recovery:
```bash
# After issue resolved, re-enable trading
curl -X POST http://localhost:8080/api/v1/config \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{"trading_enabled": true}'
```

12.2 RUNAWAY STRATEGY
---------------------

Symptoms:
- Strategy placing excessive orders
- Position growing beyond limits
- Abnormal P&L movements

Procedure:
```bash
# Stop specific strategy immediately
curl -X POST http://localhost:8080/api/v1/strategies/STRATEGY_ID/stop \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE" \
  -d '{"cancel_orders": true, "force": true}'

# Verify strategy stopped
curl -s http://localhost:8080/api/v1/strategies | jq '.strategies[] | select(.strategy_id=="STRATEGY_ID") | .status'

# Expected: "stopped"

# Review logs for root cause
grep "STRATEGY_ID" /var/log/hft_system/strategies.log | tail -1000 > /tmp/strategy_debug.log
```

12.3 EXCHANGE OUTAGE
--------------------

Symptoms:
- Exchange connection lost
- Orders timing out
- Market data stopped

Procedure:
```bash
# Check exchange status
./scripts/check_exchange_status.sh EXCHANGE_NAME

# If exchange is down (confirmed via status page):
# 1. Stop strategies using that exchange
./scripts/stop_strategies_by_exchange.sh EXCHANGE_NAME

# 2. Wait for exchange to recover (monitor status page)

# 3. When exchange is back:
# Reconnect
curl -X POST http://localhost:8080/api/v1/exchanges/EXCHANGE_NAME/reconnect \
  -H "X-API-KEY: $API_KEY" \
  -H "X-TIMESTAMP: $TIMESTAMP" \
  -H "X-SIGNATURE: $SIGNATURE"

# 4. Reconcile positions
./scripts/reconcile_positions.sh EXCHANGE_NAME

# 5. Restart strategies
./scripts/start_strategies_by_exchange.sh EXCHANGE_NAME
```

12.4 DATABASE FAILURE
---------------------

Symptoms:
- "Database connection lost" errors
- Unable to persist data
- Queries timing out

Procedure:
```bash
# Activate kill switch (trading must stop without database)
./scripts/killswitch.sh "Database failure"

# Check database status
sudo systemctl status timescaledb

# If database is down, restart
sudo systemctl restart timescaledb

# Wait for database to start
sleep 10

# Verify database connectivity
psql -h localhost -U hft_user -d hft_db -c "SELECT 1;"

# If database cannot recover, initiate failover
./scripts/failover_database.sh

# Once database is recovered, restart system
./scripts/startup.sh
```

12.5 MEMORY LEAK DETECTED
--------------------------

Symptoms:
- Memory usage continuously growing
- OOM killer triggered
- System becoming sluggish

Immediate Action:
```bash
# Take heap dump for analysis
kill -USR1 $(cat /var/run/hft_system.pid)

# Heap dump saved to /tmp/hft_heap_TIMESTAMP.dump

# If memory critical (> 90%), restart system
./scripts/graceful_shutdown.sh
sleep 30
./scripts/startup.sh

# Notify engineering team for analysis
./scripts/notify_team.sh "Memory leak detected, heap dump available"
```

Post-Incident:
```bash
# Analyze heap dump
./scripts/analyze_heap_dump.sh /tmp/hft_heap_TIMESTAMP.dump

# Review for memory leaks, excessive allocations
```

12.6 SECURITY BREACH
--------------------

Symptoms:
- Unauthorized API access
- Unexpected orders
- Configuration changes not made by team
- Unusual network traffic

Immediate Action:
```bash
# 1. Activate kill switch
./scripts/killswitch.sh "Security breach detected"

# 2. Stop system
./scripts/shutdown.sh --force

# 3. Isolate system
sudo iptables -P INPUT DROP
sudo iptables -P OUTPUT DROP
sudo iptables -A INPUT -p tcp --dport 22 -s TRUSTED_IP -j ACCEPT

# 4. Notify security team
./scripts/emergency_notification.sh "SECURITY BREACH DETECTED"

# 5. Page incident response team
./scripts/page_oncall.sh "SECURITY BREACH"

# 6. Preserve logs and evidence
./scripts/preserve_evidence.sh /var/evidence/breach_$(date +%Y%m%d_%H%M%S)/
```

Do NOT restart system until security team completes investigation.

================================================================================
CONTACT INFORMATION
================================================================================

Operations Team:
- Primary: operations@company.com
- On-call: +1-555-0100
- Slack: #hft-operations

Engineering Team:
- Platform: platform-eng@company.com
- On-call: +1-555-0101
- Slack: #hft-engineering

Management:
- Trading Desk: trading@company.com (+1-555-0103)
- CTO: cto@company.com (+1-555-0104)

External:
- Exchange Support: (see exchange-specific contact list)
- Infrastructure Provider: support@provider.com (+1-555-0200)

================================================================================
DOCUMENT REVISION HISTORY
================================================================================

Version    Date          Author              Changes
------------------------------------------------------------------------
1.0        2025-11-25    Operations Team     Initial runbook

================================================================================
END OF DOCUMENT
================================================================================
