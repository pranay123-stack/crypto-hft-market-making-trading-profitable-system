================================================================================
                              BINANCE EXCHANGE
                     COMPREHENSIVE API INTEGRATION GUIDE
================================================================================

EXCHANGE OVERVIEW
================================================================================

Name: Binance
Website: https://www.binance.com
API Documentation: https://binance-docs.github.io/apidocs/spot/en/
Founded: 2017
Headquarters: Global (no fixed HQ)
Trading Volume: $76+ billion daily (2024)
Global Rank: #1 by trading volume

HISTORY AND BACKGROUND:
-----------------------
Founded by Changpeng Zhao (CZ) in July 2017, Binance quickly became the
world's largest cryptocurrency exchange by trading volume. The platform
started with an ICO of its native BNB token and expanded rapidly to offer
spot trading, futures, margin trading, staking, and numerous other services.

Key Milestones:
- 2017: Launched with spot trading
- 2018: Launched Binance Labs investment arm
- 2019: Binance DEX and Binance Chain launched
- 2020: Binance Smart Chain (now BNB Chain) launched
- 2021: Futures volume exceeded spot volume
- 2022-2023: Enhanced compliance and regulatory measures
- 2024: Continued global expansion with regional compliance

MARKET POSITION:
----------------
- Largest exchange by 24h trading volume
- 600+ cryptocurrencies available
- 1300+ trading pairs
- Supports spot, margin, futures, options trading
- Average daily users: 10+ million
- Available in 180+ countries

================================================================================
                            TRADING PAIRS AND MARKETS
================================================================================

SPOT TRADING:
-------------
Major Pairs:
- BTC/USDT, ETH/USDT, BNB/USDT, SOL/USDT
- BTC/BUSD, ETH/BUSD, BNB/BUSD
- BTC/EUR, ETH/EUR, BNB/EUR
- 1300+ total trading pairs

Base Assets:
- USDT (Tether) - Most liquid
- BUSD (Binance USD) - Native stablecoin
- BTC, ETH, BNB - Crypto base pairs
- EUR, GBP, AUD - Fiat pairs (limited availability)

FUTURES TRADING:
----------------
- USDⓈ-M Futures (USDT-margined)
- COIN-M Futures (Coin-margined)
- Perpetual contracts (no expiry)
- Quarterly futures (expiring contracts)
- Up to 125x leverage on select pairs

OPTIONS TRADING:
----------------
- European-style options
- BTC and ETH options available
- Multiple expiry dates

MARGIN TRADING:
---------------
- Cross margin (all assets as collateral)
- Isolated margin (pair-specific)
- Up to 10x leverage on spot

================================================================================
                              API ARCHITECTURE
================================================================================

API TYPES AVAILABLE:
--------------------

1. REST API (SPOT)
   Base URL: https://api.binance.com
   - Market Data endpoints
   - Account/Trading endpoints
   - User Data Stream
   - Wallet endpoints

2. WebSocket API (SPOT)
   Base URL: wss://stream.binance.com:9443
   - Real-time market data streams
   - User data streams (requires listen key)
   - Combined streams support

3. Futures API
   USDⓈ-M: https://fapi.binance.com
   COIN-M: https://dapi.binance.com
   WebSocket: wss://fstream.binance.com

4. FIX API (Institutional)
   - FIX 4.4 protocol
   - Requires special application
   - Ultra-low latency
   - Co-location available

API VERSIONS:
-------------
- API v3 (Current for Spot)
- API v1, v2 (Deprecated)
- Futures API v1, v2

================================================================================
                       API KEY AND SECRET KEY MANAGEMENT
================================================================================

CREATING API KEYS:
------------------
1. Log in to Binance account
2. Navigate to API Management
3. Create API Key
4. Complete 2FA verification
5. Label your API key (e.g., "HFT_Trading_System")
6. Save API Key and Secret Key securely

API KEY PERMISSIONS:
--------------------
You can configure permissions for each API key:

- Enable Reading (View account data)
- Enable Spot & Margin Trading
- Enable Futures Trading
- Enable Withdrawals (NOT recommended for trading systems)
- Restrict access to trusted IPs only (HIGHLY recommended)

SECURITY RECOMMENDATIONS:
-------------------------
1. Enable IP whitelist (up to 4 IPs per key)
2. Use separate keys for different purposes:
   - Market data only (read permission)
   - Trading (read + spot/futures trading)
   - Never enable withdrawal permissions for automated systems
3. Rotate API keys every 90 days
4. Store keys in encrypted configuration files
5. Never log API secrets in plain text

API KEY LIMITS:
---------------
- Maximum 30 API keys per account
- Each key can have different permissions
- Keys can be disabled/deleted at any time

================================================================================
                          AUTHENTICATION METHODS
================================================================================

SIGNATURE AUTHENTICATION:
-------------------------
Binance uses HMAC SHA256 signatures for authenticated requests.

Authentication Process:
1. Construct query string with all parameters
2. Add timestamp parameter (Unix milliseconds)
3. Create signature using HMAC SHA256
4. Append signature to request

SIGNATURE GENERATION (Step-by-step):
-------------------------------------

1. Parameters in query string format:
   symbol=BTCUSDT&side=BUY&type=LIMIT&quantity=1&price=50000&timestamp=1701234567890

2. Generate signature:
   signature = HMAC_SHA256(query_string, secret_key)

3. Append to request:
   ?symbol=BTCUSDT&side=BUY&type=LIMIT&quantity=1&price=50000&timestamp=1701234567890&signature=xxx

HEADERS REQUIRED:
-----------------
X-MBX-APIKEY: your_api_key

TIMESTAMP REQUIREMENTS:
-----------------------
- Must be in Unix milliseconds
- Server time sync is critical
- Request must be received within 5000ms (default recv_window)
- Use /api/v3/time endpoint to sync clocks

C++ AUTHENTICATION EXAMPLE:
---------------------------

#include <iostream>
#include <string>
#include <sstream>
#include <iomanip>
#include <openssl/hmac.h>
#include <openssl/sha.h>
#include <curl/curl.h>
#include <chrono>

std::string hmac_sha256(const std::string& key, const std::string& data) {
    unsigned char* digest;
    digest = HMAC(EVP_sha256(),
                  key.c_str(), key.length(),
                  (unsigned char*)data.c_str(), data.length(),
                  NULL, NULL);

    std::stringstream ss;
    for(int i = 0; i < SHA256_DIGEST_LENGTH; i++) {
        ss << std::hex << std::setw(2) << std::setfill('0')
           << (int)digest[i];
    }
    return ss.str();
}

long long get_timestamp() {
    auto now = std::chrono::system_clock::now();
    auto duration = now.time_since_epoch();
    return std::chrono::duration_cast<std::chrono::milliseconds>(duration).count();
}

std::string create_signed_request(const std::string& secret_key,
                                  const std::string& query_params) {
    long long timestamp = get_timestamp();
    std::string params_with_time = query_params + "&timestamp=" +
                                   std::to_string(timestamp);
    std::string signature = hmac_sha256(secret_key, params_with_time);
    return params_with_time + "&signature=" + signature;
}

================================================================================
                          RATE LIMITS AND RESTRICTIONS
================================================================================

REQUEST RATE LIMITS:
--------------------

1. Request Weight System:
   - Each endpoint has a weight value
   - Limit: 1200 weight per minute
   - Limit: 6000 weight per 5 minutes
   - Heavy endpoints (order book depth) have higher weights

2. Order Rate Limits:
   - 10 orders per second per account
   - 100,000 orders per 24 hours per account
   - Cancels count toward order rate limit

3. WebSocket Limits:
   - 5 connections per IP
   - 10 connections per API key
   - 1024 streams per connection

ENDPOINT WEIGHTS:
-----------------
GET /api/v3/ticker/price - Weight: 1 (single symbol) or 2 (all symbols)
GET /api/v3/depth - Weight: 1-50 (depending on limit parameter)
GET /api/v3/klines - Weight: 1
POST /api/v3/order - Weight: 1
POST /api/v3/order/test - Weight: 1

IP BAN:
-------
If rate limits are violated:
- HTTP 429 return code
- X-MBX-USED-WEIGHT header shows current usage
- Automatic IP ban for repeated violations
- Ban duration: 2 minutes to 3 days (escalating)

RATE LIMIT HEADERS:
-------------------
Response headers include:
- X-MBX-USED-WEIGHT-1M: Weight used in last minute
- X-MBX-ORDER-COUNT-10S: Orders in last 10 seconds
- X-MBX-ORDER-COUNT-1D: Orders in last 24 hours
- Retry-After: Seconds until ban is lifted (if 418/429)

BEST PRACTICES:
---------------
1. Cache market data when possible
2. Use WebSocket for real-time data instead of polling
3. Implement exponential backoff on errors
4. Monitor rate limit headers
5. Use order batch endpoints when available

================================================================================
                          MARKET DATA STRUCTURE
================================================================================

ORDER BOOK STRUCTURE:
---------------------
GET /api/v3/depth?symbol=BTCUSDT&limit=100

Response:
{
  "lastUpdateId": 1234567890,
  "bids": [
    ["50000.00", "1.5"],      // [price, quantity]
    ["49999.00", "2.3"],
    ["49998.00", "0.8"]
  ],
  "asks": [
    ["50001.00", "1.2"],
    ["50002.00", "3.1"],
    ["50003.00", "0.5"]
  ]
}

TICKER DATA:
------------
GET /api/v3/ticker/24hr?symbol=BTCUSDT

{
  "symbol": "BTCUSDT",
  "priceChange": "500.00",
  "priceChangePercent": "1.01",
  "weightedAvgPrice": "49500.00",
  "prevClosePrice": "49500.00",
  "lastPrice": "50000.00",
  "lastQty": "0.1",
  "bidPrice": "49999.00",
  "bidQty": "5.0",
  "askPrice": "50001.00",
  "askQty": "3.5",
  "openPrice": "49500.00",
  "highPrice": "50500.00",
  "lowPrice": "49000.00",
  "volume": "12345.67",
  "quoteVolume": "612345678.90",
  "openTime": 1701234567890,
  "closeTime": 1701320967890,
  "firstId": 123456789,
  "lastId": 123567890,
  "count": 111101
}

RECENT TRADES:
--------------
GET /api/v3/trades?symbol=BTCUSDT&limit=100

[
  {
    "id": 123456789,
    "price": "50000.00",
    "qty": "0.5",
    "quoteQty": "25000.00",
    "time": 1701234567890,
    "isBuyerMaker": false,
    "isBestMatch": true
  }
]

KLINE/CANDLESTICK DATA:
-----------------------
GET /api/v3/klines?symbol=BTCUSDT&interval=1m&limit=100

[
  [
    1701234567890,      // Open time
    "50000.00",         // Open price
    "50100.00",         // High price
    "49900.00",         // Low price
    "50050.00",         // Close price
    "123.45",           // Volume
    1701234627890,      // Close time
    "6172500.00",       // Quote asset volume
    1000,               // Number of trades
    "61.73",            // Taker buy base volume
    "3086250.00",       // Taker buy quote volume
    "0"                 // Ignore
  ]
]

Intervals: 1m, 3m, 5m, 15m, 30m, 1h, 2h, 4h, 6h, 8h, 12h, 1d, 3d, 1w, 1M

================================================================================
                          ORDER TYPES SUPPORTED
================================================================================

STANDARD ORDER TYPES:
----------------------

1. LIMIT Order:
   - Executed at specified price or better
   - Remains on order book until filled or cancelled
   - Parameters: symbol, side, type=LIMIT, quantity, price, timeInForce

2. MARKET Order:
   - Executed immediately at best available price
   - No price parameter required
   - Parameters: symbol, side, type=MARKET, quantity

3. STOP_LOSS Order:
   - Market order triggered when stop price is reached
   - Parameters: symbol, side, type=STOP_LOSS, quantity, stopPrice

4. STOP_LOSS_LIMIT Order:
   - Limit order triggered when stop price is reached
   - Parameters: symbol, side, type=STOP_LOSS_LIMIT, quantity, price, stopPrice

5. TAKE_PROFIT Order:
   - Market order to lock in profits
   - Parameters: symbol, side, type=TAKE_PROFIT, quantity, stopPrice

6. TAKE_PROFIT_LIMIT Order:
   - Limit order to lock in profits
   - Parameters: symbol, side, type=TAKE_PROFIT_LIMIT, quantity, price, stopPrice

7. LIMIT_MAKER Order:
   - Post-only limit order (maker only)
   - Rejected if would execute as taker
   - Parameters: symbol, side, type=LIMIT_MAKER, quantity, price

TIME IN FORCE OPTIONS:
----------------------
- GTC (Good Till Cancel): Order remains until filled or cancelled
- IOC (Immediate or Cancel): Fill immediately, cancel remainder
- FOK (Fill or Kill): Fill completely or cancel entirely

ORDER RESPONSE TYPES:
---------------------
- ACK: Acknowledgment only
- RESULT: Acknowledgment + order status
- FULL: Acknowledgment + order status + fills

ADVANCED ORDER FEATURES:
------------------------
- OCO (One-Cancels-Other): Pair of orders where execution of one cancels the other
- Iceberg Orders: Large orders split into smaller visible quantities
- Post-Only Orders: LIMIT_MAKER ensures maker fee

================================================================================
                              FEE STRUCTURE
================================================================================

SPOT TRADING FEES (Regular User):
----------------------------------
Maker Fee: 0.1000%
Taker Fee: 0.1000%

With BNB Fee Discount (25% off):
Maker Fee: 0.0750%
Taker Fee: 0.0750%

VIP TIER SYSTEM:
----------------
Based on 30-day trading volume and BNB balance:

VIP 0: <50 BTC volume
  Maker: 0.1000% / Taker: 0.1000%

VIP 1: ≥50 BTC volume OR ≥50 BNB
  Maker: 0.0900% / Taker: 0.1000%

VIP 2: ≥500 BTC volume OR ≥200 BNB
  Maker: 0.0800% / Taker: 0.1000%

VIP 3: ≥1,500 BTC volume OR ≥500 BNB
  Maker: 0.0700% / Taker: 0.0900%

VIP 4: ≥4,500 BTC volume OR ≥1,000 BNB
  Maker: 0.0700% / Taker: 0.0800%

VIP 5: ≥10,000 BTC volume OR ≥2,000 BNB
  Maker: 0.0600% / Taker: 0.0700%

VIP 6: ≥20,000 BTC volume OR ≥3,500 BNB
  Maker: 0.0500% / Taker: 0.0600%

VIP 7: ≥40,000 BTC volume OR ≥6,000 BNB
  Maker: 0.0400% / Taker: 0.0500%

VIP 8: ≥80,000 BTC volume OR ≥9,000 BNB
  Maker: 0.0300% / Taker: 0.0400%

VIP 9: ≥150,000 BTC volume OR ≥11,000 BNB
  Maker: 0.0200% / Taker: 0.0300%

FUTURES TRADING FEES:
---------------------
Regular User:
  Maker: 0.0200% / Taker: 0.0500%

With BNB discount (10% off):
  Maker: 0.0180% / Taker: 0.0450%

WITHDRAWAL FEES:
----------------
Variable by cryptocurrency:
- BTC: 0.0005 BTC
- ETH: 0.005 ETH
- USDT (ERC20): 10 USDT
- USDT (TRC20): 1 USDT
- USDT (BEP20): 0.8 USDT

DEPOSIT FEES:
-------------
No fees for cryptocurrency deposits

================================================================================
                          WEBSOCKET CHANNELS
================================================================================

CONNECTION ENDPOINTS:
---------------------
Spot WebSocket: wss://stream.binance.com:9443/ws
Combined Streams: wss://stream.binance.com:9443/stream?streams=

AVAILABLE STREAMS:
------------------

1. Trade Streams:
   <symbol>@trade
   Example: btcusdt@trade

2. Kline/Candlestick Streams:
   <symbol>@kline_<interval>
   Example: btcusdt@kline_1m

3. Individual Symbol Mini Ticker:
   <symbol>@miniTicker
   Example: btcusdt@miniTicker

4. All Market Mini Tickers:
   !miniTicker@arr

5. Individual Symbol Ticker:
   <symbol>@ticker
   Example: btcusdt@ticker

6. All Market Tickers:
   !ticker@arr

7. Individual Symbol Book Ticker:
   <symbol>@bookTicker
   Example: btcusdt@bookTicker

8. All Book Tickers:
   !bookTicker

9. Partial Book Depth Streams:
   <symbol>@depth<levels>@<speed>
   Example: btcusdt@depth20@100ms
   Levels: 5, 10, 20
   Speed: 1000ms, 100ms

10. Diff. Depth Stream:
    <symbol>@depth
    Example: btcusdt@depth

COMBINED STREAMS:
-----------------
Subscribe to multiple streams:
wss://stream.binance.com:9443/stream?streams=btcusdt@trade/ethusdt@trade/bnbusdt@ticker

USER DATA STREAMS:
------------------
Requires listen key from REST API:

1. Create listen key:
   POST /api/v3/userDataStream

2. Connect to stream:
   wss://stream.binance.com:9443/ws/<listenKey>

3. Keep alive (every 30 minutes):
   PUT /api/v3/userDataStream

Events pushed:
- Account updates (balance changes)
- Order updates (fills, cancellations)
- OCO order updates

================================================================================
                      C++ CODE EXAMPLES - REST API
================================================================================

EXAMPLE 1: GET SERVER TIME
---------------------------

#include <iostream>
#include <curl/curl.h>
#include <nlohmann/json.hpp>

using json = nlohmann::json;

// Callback function for curl
size_t WriteCallback(void* contents, size_t size, size_t nmemb, std::string* userp) {
    userp->append((char*)contents, size * nmemb);
    return size * nmemb;
}

std::string binance_request(const std::string& url) {
    CURL* curl = curl_easy_init();
    std::string response;

    if(curl) {
        curl_easy_setopt(curl, CURLOPT_URL, url.c_str());
        curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, WriteCallback);
        curl_easy_setopt(curl, CURLOPT_WRITEDATA, &response);
        curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 1L);

        CURLcode res = curl_easy_perform(curl);
        if(res != CURLE_OK) {
            std::cerr << "curl_easy_perform() failed: "
                     << curl_easy_strerror(res) << std::endl;
        }
        curl_easy_cleanup(curl);
    }
    return response;
}

void get_server_time() {
    std::string response = binance_request("https://api.binance.com/api/v3/time");
    json j = json::parse(response);
    std::cout << "Server time: " << j["serverTime"] << std::endl;
}


EXAMPLE 2: GET CURRENT PRICE
-----------------------------

void get_price(const std::string& symbol) {
    std::string url = "https://api.binance.com/api/v3/ticker/price?symbol=" + symbol;
    std::string response = binance_request(url);
    json j = json::parse(response);

    std::cout << "Symbol: " << j["symbol"] << std::endl;
    std::cout << "Price: " << j["price"] << std::endl;
}


EXAMPLE 3: GET ORDER BOOK
--------------------------

void get_order_book(const std::string& symbol, int limit = 10) {
    std::string url = "https://api.binance.com/api/v3/depth?symbol=" +
                     symbol + "&limit=" + std::to_string(limit);
    std::string response = binance_request(url);
    json j = json::parse(response);

    std::cout << "Top " << limit << " bids:" << std::endl;
    for(auto& bid : j["bids"]) {
        std::cout << "  Price: " << bid[0] << " Qty: " << bid[1] << std::endl;
    }

    std::cout << "Top " << limit << " asks:" << std::endl;
    for(auto& ask : j["asks"]) {
        std::cout << "  Price: " << ask[0] << " Qty: " << ask[1] << std::endl;
    }
}


EXAMPLE 4: PLACE LIMIT ORDER (AUTHENTICATED)
---------------------------------------------

#include <openssl/hmac.h>
#include <openssl/sha.h>
#include <iomanip>
#include <sstream>
#include <chrono>

class BinanceClient {
private:
    std::string api_key;
    std::string secret_key;
    std::string base_url = "https://api.binance.com";

    std::string hmac_sha256(const std::string& data) {
        unsigned char* digest;
        digest = HMAC(EVP_sha256(),
                      secret_key.c_str(), secret_key.length(),
                      (unsigned char*)data.c_str(), data.length(),
                      NULL, NULL);

        std::stringstream ss;
        for(int i = 0; i < SHA256_DIGEST_LENGTH; i++) {
            ss << std::hex << std::setw(2) << std::setfill('0')
               << (int)digest[i];
        }
        return ss.str();
    }

    long long get_timestamp() {
        auto now = std::chrono::system_clock::now();
        auto duration = now.time_since_epoch();
        return std::chrono::duration_cast<std::chrono::milliseconds>(duration).count();
    }

    std::string signed_request(const std::string& endpoint,
                               const std::string& params,
                               const std::string& method = "GET") {
        long long timestamp = get_timestamp();
        std::string query = params + "&timestamp=" + std::to_string(timestamp);
        std::string signature = hmac_sha256(query);
        std::string full_query = query + "&signature=" + signature;
        std::string url = base_url + endpoint + "?" + full_query;

        CURL* curl = curl_easy_init();
        std::string response;

        if(curl) {
            struct curl_slist* headers = NULL;
            std::string api_header = "X-MBX-APIKEY: " + api_key;
            headers = curl_slist_append(headers, api_header.c_str());

            curl_easy_setopt(curl, CURLOPT_URL, url.c_str());
            curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);
            curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, WriteCallback);
            curl_easy_setopt(curl, CURLOPT_WRITEDATA, &response);

            if(method == "POST") {
                curl_easy_setopt(curl, CURLOPT_POST, 1L);
            } else if(method == "DELETE") {
                curl_easy_setopt(curl, CURLOPT_CUSTOMREQUEST, "DELETE");
            }

            CURLcode res = curl_easy_perform(curl);
            if(res != CURLE_OK) {
                std::cerr << "Request failed: " << curl_easy_strerror(res) << std::endl;
            }

            curl_slist_free_all(headers);
            curl_easy_cleanup(curl);
        }
        return response;
    }

public:
    BinanceClient(const std::string& key, const std::string& secret)
        : api_key(key), secret_key(secret) {}

    json get_account_info() {
        std::string response = signed_request("/api/v3/account", "");
        return json::parse(response);
    }

    json place_limit_order(const std::string& symbol,
                          const std::string& side,
                          const std::string& quantity,
                          const std::string& price) {
        std::string params = "symbol=" + symbol +
                            "&side=" + side +
                            "&type=LIMIT" +
                            "&timeInForce=GTC" +
                            "&quantity=" + quantity +
                            "&price=" + price;

        std::string response = signed_request("/api/v3/order", params, "POST");
        return json::parse(response);
    }

    json place_market_order(const std::string& symbol,
                           const std::string& side,
                           const std::string& quantity) {
        std::string params = "symbol=" + symbol +
                            "&side=" + side +
                            "&type=MARKET" +
                            "&quantity=" + quantity;

        std::string response = signed_request("/api/v3/order", params, "POST");
        return json::parse(response);
    }

    json cancel_order(const std::string& symbol, long order_id) {
        std::string params = "symbol=" + symbol +
                            "&orderId=" + std::to_string(order_id);

        std::string response = signed_request("/api/v3/order", params, "DELETE");
        return json::parse(response);
    }

    json get_open_orders(const std::string& symbol = "") {
        std::string params = symbol.empty() ? "" : "symbol=" + symbol;
        std::string response = signed_request("/api/v3/openOrders", params);
        return json::parse(response);
    }
};

// Usage example:
int main() {
    BinanceClient client("your_api_key", "your_secret_key");

    // Get account information
    json account = client.get_account_info();
    std::cout << "Account balances:" << std::endl;
    for(auto& balance : account["balances"]) {
        if(std::stod(balance["free"].get<std::string>()) > 0 ||
           std::stod(balance["locked"].get<std::string>()) > 0) {
            std::cout << "  " << balance["asset"] << ": "
                     << balance["free"] << " (free), "
                     << balance["locked"] << " (locked)" << std::endl;
        }
    }

    // Place a limit buy order
    json order = client.place_limit_order("BTCUSDT", "BUY", "0.001", "45000.00");
    std::cout << "\nOrder placed:" << std::endl;
    std::cout << "  Order ID: " << order["orderId"] << std::endl;
    std::cout << "  Status: " << order["status"] << std::endl;

    return 0;
}


================================================================================
                    C++ CODE EXAMPLES - WEBSOCKET API
================================================================================

EXAMPLE 5: WEBSOCKET TRADE STREAM
----------------------------------

#include <websocketpp/config/asio_client.hpp>
#include <websocketpp/client.hpp>
#include <nlohmann/json.hpp>
#include <iostream>

typedef websocketpp::client<websocketpp::config::asio_tls_client> client;
typedef websocketpp::lib::shared_ptr<websocketpp::lib::asio::ssl::context> context_ptr;

using websocketpp::lib::placeholders::_1;
using websocketpp::lib::placeholders::_2;
using websocketpp::lib::bind;

class BinanceWebSocket {
private:
    client ws_client;
    websocketpp::connection_hdl hdl;

    context_ptr on_tls_init() {
        context_ptr ctx = websocketpp::lib::make_shared<asio::ssl::context>(
            asio::ssl::context::sslv23
        );

        try {
            ctx->set_options(asio::ssl::context::default_workarounds |
                           asio::ssl::context::no_sslv2 |
                           asio::ssl::context::no_sslv3 |
                           asio::ssl::context::single_dh_use);
        } catch (std::exception& e) {
            std::cout << "TLS init error: " << e.what() << std::endl;
        }
        return ctx;
    }

    void on_message(websocketpp::connection_hdl, client::message_ptr msg) {
        try {
            json j = json::parse(msg->get_payload());

            if(j.contains("e") && j["e"] == "trade") {
                std::cout << "Trade: " << std::endl;
                std::cout << "  Symbol: " << j["s"] << std::endl;
                std::cout << "  Price: " << j["p"] << std::endl;
                std::cout << "  Quantity: " << j["q"] << std::endl;
                std::cout << "  Time: " << j["T"] << std::endl;
                std::cout << "  Buyer is maker: " << j["m"] << std::endl;
                std::cout << "---" << std::endl;
            }
        } catch(json::exception& e) {
            std::cout << "JSON parse error: " << e.what() << std::endl;
        }
    }

    void on_open(websocketpp::connection_hdl hdl) {
        std::cout << "WebSocket connection opened" << std::endl;
        this->hdl = hdl;
    }

    void on_close(websocketpp::connection_hdl) {
        std::cout << "WebSocket connection closed" << std::endl;
    }

    void on_fail(websocketpp::connection_hdl) {
        std::cout << "WebSocket connection failed" << std::endl;
    }

public:
    BinanceWebSocket() {
        ws_client.init_asio();
        ws_client.set_tls_init_handler(bind(&BinanceWebSocket::on_tls_init, this));
        ws_client.set_message_handler(bind(&BinanceWebSocket::on_message, this, ::_1, ::_2));
        ws_client.set_open_handler(bind(&BinanceWebSocket::on_open, this, ::_1));
        ws_client.set_close_handler(bind(&BinanceWebSocket::on_close, this, ::_1));
        ws_client.set_fail_handler(bind(&BinanceWebSocket::on_fail, this, ::_1));
    }

    void connect(const std::string& uri) {
        websocketpp::lib::error_code ec;
        client::connection_ptr con = ws_client.get_connection(uri, ec);

        if(ec) {
            std::cout << "Connection error: " << ec.message() << std::endl;
            return;
        }

        ws_client.connect(con);
        ws_client.run();
    }

    void subscribe_trades(const std::string& symbol) {
        std::string uri = "wss://stream.binance.com:9443/ws/" +
                         symbol + "@trade";
        connect(uri);
    }
};

// Usage:
int main() {
    BinanceWebSocket ws;
    ws.subscribe_trades("btcusdt");
    return 0;
}


================================================================================
                            BEST PRACTICES
================================================================================

1. ERROR HANDLING:
------------------
- Always check HTTP status codes
- Parse error messages from API responses
- Implement retry logic with exponential backoff
- Handle rate limiting (429 errors) gracefully
- Log all errors with timestamps

2. PERFORMANCE OPTIMIZATION:
----------------------------
- Use WebSocket for real-time data (lower latency)
- Maintain local order book instead of polling
- Use connection pooling for REST requests
- Batch requests when possible
- Enable HTTP/2 if supported

3. SECURITY:
------------
- Never hardcode API keys
- Use environment variables or encrypted config files
- Enable IP whitelisting
- Rotate API keys regularly
- Monitor for unauthorized access
- Use read-only keys for market data

4. RELIABILITY:
---------------
- Implement automatic reconnection for WebSocket
- Handle server maintenance windows
- Sync system time with server time
- Validate all input data
- Keep backup connections ready

5. MONITORING:
--------------
- Track API response times
- Monitor rate limit usage
- Log all order placements
- Set up alerts for failures
- Track fill rates and execution quality

================================================================================
                        GEOGRAPHIC RESTRICTIONS
================================================================================

RESTRICTED COUNTRIES:
---------------------
Binance does not serve users from:
- United States (use Binance.US instead)
- Singapore (phased out)
- Ontario, Canada
- United Kingdom (restricted features)

REGIONAL PLATFORMS:
-------------------
- Binance.US: For US residents
- Binance.com: International platform
- Regional compliance varies

VPN USAGE:
----------
- Generally prohibited in Terms of Service
- May result in account restrictions
- Risk of fund freezing

================================================================================
                          KYC REQUIREMENTS
================================================================================

VERIFICATION LEVELS:
--------------------

Level 1 (Basic):
- Email and phone verification
- Basic identity information
- Withdrawal limit: 0.06 BTC/day

Level 2 (Intermediate):
- Government-issued ID (passport, driver's license)
- Facial verification
- Withdrawal limit: 100 BTC/day

Level 3 (Advanced - Optional):
- Proof of address
- Enhanced due diligence
- Higher withdrawal limits

INSTITUTIONAL KYC:
------------------
- Corporate documentation
- Ultimate beneficial owner (UBO) information
- Source of funds documentation
- Enhanced due diligence
- Dedicated account manager

API ACCESS:
-----------
- Requires at least Level 1 verification
- Trading requires Level 2 verification
- API access may be restricted without full KYC

================================================================================
                          SUPPORT RESOURCES
================================================================================

OFFICIAL DOCUMENTATION:
-----------------------
- Main API Docs: https://binance-docs.github.io/apidocs/spot/en/
- Futures API: https://binance-docs.github.io/apidocs/futures/en/
- GitHub: https://github.com/binance
- Postman Collections: Available on GitHub

API STATUS:
-----------
- Status Page: https://www.binance.com/en/support/announcement
- System Status: Check for scheduled maintenance

SUPPORT CHANNELS:
-----------------
- Customer Support: https://www.binance.com/en/support
- API Support: Submit ticket through website
- Telegram: Official Binance API group
- Twitter: @binance for announcements

TESTNET:
--------
- Spot Testnet: https://testnet.binance.vision/
- Futures Testnet: https://testnet.binancefuture.com/
- Free test funds available
- Same API structure as production

COMMUNITY:
----------
- Stack Overflow: [binance] tag
- Reddit: r/BinanceExchange
- GitHub Issues: For API-specific questions

================================================================================
                              APPENDIX
================================================================================

ERROR CODES:
------------
-1000: UNKNOWN - An unknown error occurred
-1001: DISCONNECTED - Internal error; unable to process
-1002: UNAUTHORIZED - Invalid API key
-1003: TOO_MANY_REQUESTS - Rate limit exceeded
-1007: TIMEOUT - Request timeout
-1015: TOO_MANY_ORDERS - Too many orders
-2010: NEW_ORDER_REJECTED - Order rejected
-2011: CANCEL_REJECTED - Cancel rejected

HTTP STATUS CODES:
------------------
200: Success
400: Bad Request - Invalid parameters
401: Unauthorized - Invalid API key
403: Forbidden - Violation (e.g., rate limit, IP ban)
404: Not Found
418: IP banned
429: Rate limit exceeded
5xx: Server errors

SYMBOL FILTERS:
---------------
Each symbol has filters that define trading rules:
- PRICE_FILTER: Min/max price, tick size
- LOT_SIZE: Min/max quantity, step size
- MIN_NOTIONAL: Minimum order value
- MAX_NUM_ORDERS: Max open orders per symbol
- MAX_NUM_ALGO_ORDERS: Max algo orders

CO-LOCATION:
------------
- Available in select data centers
- Contact Binance for institutional access
- Ultra-low latency (sub-millisecond)
- Premium pricing

================================================================================
                              END OF DOCUMENT
================================================================================

File: binance.txt
Version: 1.0
Last Updated: 2025-11-25
Size: ~25KB

For latest updates, always refer to official Binance API documentation.
