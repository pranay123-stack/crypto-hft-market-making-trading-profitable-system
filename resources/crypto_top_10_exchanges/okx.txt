================================================================================
                                OKX EXCHANGE
                     COMPREHENSIVE API INTEGRATION GUIDE
================================================================================

EXCHANGE OVERVIEW
================================================================================

Name: OKX (formerly OKEx)
Website: https://www.okx.com
API Documentation: https://www.okx.com/docs-v5/en/
Founded: 2017
Headquarters: Seychelles
Trading Volume: $10-15 billion daily (2024)
Global Rank: #2-3 by trading volume

HISTORY AND BACKGROUND:
-----------------------
OKX (rebranded from OKEx in 2022) is a major cryptocurrency exchange and
derivatives platform. Known for its advanced trading products and deep
liquidity, OKX is particularly strong in Asian markets and derivatives trading.

Key Milestones:
- 2017: OKEx launched by OK Coin
- 2018: Futures trading introduced
- 2019: Options trading launched
- 2020: DeFi Hub introduced
- 2022: Rebranded to OKX
- 2023: Web3 Wallet integration
- 2024: Expanded global presence

REGULATORY STATUS:
------------------
- Registered in Seychelles
- Licensed in multiple jurisdictions
- Compliance with local regulations
- Enhanced KYC/AML procedures

MARKET POSITION:
----------------
- Top 3 by derivatives volume
- 300+ cryptocurrencies
- 400+ spot pairs
- Industry-leading derivatives platform
- Strong liquidity across all products

================================================================================
                            TRADING PAIRS AND MARKETS
================================================================================

SPOT TRADING:
-------------
Major Pairs:
- BTC/USDT, ETH/USDT, SOL/USDT, XRP/USDT
- BTC/USDC, ETH/USDC
- Extensive altcoin selection

DERIVATIVES:
------------
- Perpetual Swaps (USDT and Coin-margined)
- Futures (Weekly, Bi-weekly, Quarterly)
- Options (BTC, ETH)
- Up to 125x leverage

MARGIN TRADING:
---------------
- Cross margin and isolated margin
- Multi-currency margin
- Up to 10x leverage on spot

ADDITIONAL PRODUCTS:
--------------------
- Structured products (Snowball, Shark Fin)
- Savings (flexible and fixed)
- Staking
- Copy trading

================================================================================
                              API ARCHITECTURE
================================================================================

API TYPES:
----------

1. REST API
   Base URL: https://www.okx.com
   - Market data
   - Trading
   - Account management
   - Sub-account management

2. WebSocket API
   Public: wss://ws.okx.com:8443/ws/v5/public
   Private: wss://ws.okx.com:8443/ws/v5/private
   Business: wss://ws.okx.com:8443/ws/v5/business

3. AWS Support
   US region: https://aws.okx.com (lower latency for US)

API VERSION:
------------
- V5 API (Current) - Unified API for all trading types
- V3 API (Deprecated) - Legacy endpoints

DEMO TRADING:
-------------
Demo Base URL: https://www.okx.com
Demo WebSocket: wss://wspap.okx.com:8443/ws/v5/public?brokerId=9999

================================================================================
                       API KEY AND SECRET KEY MANAGEMENT
================================================================================

CREATING API KEYS:
------------------
1. Log in to OKX account
2. Navigate to Profile > API
3. Click "Create API Key"
4. Configure permissions:
   - Read: View account data
   - Trade: Place/cancel orders
   - Withdraw: Withdrawal permissions (not recommended)
5. Set API key name
6. Add IP whitelist (up to 20 IPs)
7. Complete 2FA verification
8. Save API Key, Secret Key, and Passphrase

API KEY COMPONENTS:
-------------------
- API Key: Alphanumeric string
- Secret Key: Base64 encoded string
- Passphrase: User-defined password (created during key generation)

SECURITY BEST PRACTICES:
------------------------
1. Enable IP whitelist (mandatory for withdrawals)
2. Use separate keys for different functions
3. Never enable withdrawal for trading bots
4. Rotate keys every 90 days
5. Store credentials encrypted
6. Monitor API usage through dashboard
7. Set permission controls appropriately

API KEY LIMITS:
---------------
- Maximum 20 API keys per account
- Up to 20 IPs per whitelist
- Different keys can have different permissions

================================================================================
                          AUTHENTICATION METHODS
================================================================================

AUTHENTICATION PROCESS:
-----------------------
OKX uses API Key + Secret Key + Passphrase + Signature authentication.

Required Headers:
- OK-ACCESS-KEY: Your API key
- OK-ACCESS-SIGN: Base64 encoded signature
- OK-ACCESS-TIMESTAMP: ISO 8601 timestamp
- OK-ACCESS-PASSPHRASE: Your passphrase
- Content-Type: application/json

SIGNATURE GENERATION:
---------------------
1. Create prehash string: timestamp + method + requestPath + body
2. Sign with HMAC SHA256 using secret key
3. Base64 encode the signature

C++ AUTHENTICATION IMPLEMENTATION:
----------------------------------

#include <iostream>
#include <string>
#include <sstream>
#include <iomanip>
#include <chrono>
#include <openssl/hmac.h>
#include <openssl/sha.h>
#include <openssl/bio.h>
#include <openssl/buffer.h>
#include <curl/curl.h>
#include <nlohmann/json.hpp>

using json = nlohmann::json;

class OKXAuth {
private:
    std::string api_key;
    std::string secret_key;
    std::string passphrase;

    std::string base64_encode(const unsigned char* buffer, size_t length) {
        BIO *bio, *b64;
        BUF_MEM *buffer_ptr;

        b64 = BIO_new(BIO_f_base64());
        bio = BIO_new(BIO_s_mem());
        bio = BIO_push(b64, bio);
        BIO_set_flags(bio, BIO_FLAGS_BASE64_NO_NL);
        BIO_write(bio, buffer, length);
        BIO_flush(bio);
        BIO_get_mem_ptr(bio, &buffer_ptr);

        std::string result(buffer_ptr->data, buffer_ptr->length);
        BIO_free_all(bio);
        return result;
    }

    std::string hmac_sha256(const std::string& data, const std::string& key) {
        unsigned char* digest;
        unsigned int digest_len;

        digest = HMAC(EVP_sha256(),
                      key.c_str(), key.length(),
                      (unsigned char*)data.c_str(), data.length(),
                      NULL, &digest_len);

        return base64_encode(digest, digest_len);
    }

    std::string get_iso_timestamp() {
        auto now = std::chrono::system_clock::now();
        auto ms = std::chrono::duration_cast<std::chrono::milliseconds>(
            now.time_since_epoch()
        ) % 1000;

        std::time_t now_c = std::chrono::system_clock::to_time_t(now);
        std::tm* now_tm = std::gmtime(&now_c);

        std::stringstream ss;
        ss << std::put_time(now_tm, "%Y-%m-%dT%H:%M:%S")
           << '.' << std::setfill('0') << std::setw(3) << ms.count() << 'Z';

        return ss.str();
    }

public:
    OKXAuth(const std::string& key, const std::string& secret, const std::string& pass)
        : api_key(key), secret_key(secret), passphrase(pass) {}

    struct AuthHeaders {
        std::string api_key;
        std::string timestamp;
        std::string signature;
        std::string passphrase;
    };

    AuthHeaders generate_headers(const std::string& method,
                                 const std::string& request_path,
                                 const std::string& body = "") {
        AuthHeaders headers;
        headers.api_key = api_key;
        headers.timestamp = get_iso_timestamp();
        headers.passphrase = passphrase;

        // Create prehash string
        std::string prehash = headers.timestamp + method + request_path + body;

        // Generate signature
        headers.signature = hmac_sha256(prehash, secret_key);

        return headers;
    }
};

class OKXClient {
private:
    std::string api_key;
    std::string secret_key;
    std::string passphrase;
    std::string base_url = "https://www.okx.com";
    bool simulated = false;

    OKXAuth auth;

    static size_t WriteCallback(void* contents, size_t size,
                               size_t nmemb, std::string* userp) {
        userp->append((char*)contents, size * nmemb);
        return size * nmemb;
    }

    std::string make_request(const std::string& endpoint,
                            const std::string& method = "GET",
                            const json& body = {}) {
        CURL* curl = curl_easy_init();
        std::string response;

        if(curl) {
            std::string url = base_url + endpoint;
            std::string body_str = body.empty() ? "" : body.dump();

            auto headers_data = auth.generate_headers(method, endpoint, body_str);

            struct curl_slist* headers = NULL;
            headers = curl_slist_append(headers,
                ("OK-ACCESS-KEY: " + headers_data.api_key).c_str());
            headers = curl_slist_append(headers,
                ("OK-ACCESS-SIGN: " + headers_data.signature).c_str());
            headers = curl_slist_append(headers,
                ("OK-ACCESS-TIMESTAMP: " + headers_data.timestamp).c_str());
            headers = curl_slist_append(headers,
                ("OK-ACCESS-PASSPHRASE: " + headers_data.passphrase).c_str());
            headers = curl_slist_append(headers, "Content-Type: application/json");

            if(simulated) {
                headers = curl_slist_append(headers, "x-simulated-trading: 1");
            }

            curl_easy_setopt(curl, CURLOPT_URL, url.c_str());
            curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);
            curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, WriteCallback);
            curl_easy_setopt(curl, CURLOPT_WRITEDATA, &response);

            if(method == "POST") {
                curl_easy_setopt(curl, CURLOPT_POSTFIELDS, body_str.c_str());
            } else if(method == "DELETE") {
                curl_easy_setopt(curl, CURLOPT_CUSTOMREQUEST, "DELETE");
            }

            CURLcode res = curl_easy_perform(curl);
            if(res != CURLE_OK) {
                std::cerr << "Request failed: " << curl_easy_strerror(res) << std::endl;
            }

            curl_slist_free_all(headers);
            curl_easy_cleanup(curl);
        }
        return response;
    }

public:
    OKXClient(const std::string& key, const std::string& secret,
             const std::string& pass, bool is_simulated = false)
        : api_key(key), secret_key(secret), passphrase(pass),
          simulated(is_simulated), auth(key, secret, pass) {}

    // Market Data
    json get_tickers(const std::string& inst_type = "SPOT") {
        std::string endpoint = "/api/v5/market/tickers?instType=" + inst_type;
        std::string response = make_request(endpoint);
        return json::parse(response);
    }

    json get_ticker(const std::string& inst_id) {
        std::string endpoint = "/api/v5/market/ticker?instId=" + inst_id;
        std::string response = make_request(endpoint);
        return json::parse(response);
    }

    json get_order_book(const std::string& inst_id, int sz = 20) {
        std::string endpoint = "/api/v5/market/books?instId=" + inst_id +
                              "&sz=" + std::to_string(sz);
        std::string response = make_request(endpoint);
        return json::parse(response);
    }

    json get_trades(const std::string& inst_id, int limit = 100) {
        std::string endpoint = "/api/v5/market/trades?instId=" + inst_id +
                              "&limit=" + std::to_string(limit);
        std::string response = make_request(endpoint);
        return json::parse(response);
    }

    json get_candles(const std::string& inst_id, const std::string& bar = "1m") {
        std::string endpoint = "/api/v5/market/candles?instId=" + inst_id +
                              "&bar=" + bar;
        std::string response = make_request(endpoint);
        return json::parse(response);
    }

    // Trading
    json place_order(const json& order_params) {
        std::string response = make_request("/api/v5/trade/order", "POST", order_params);
        return json::parse(response);
    }

    json cancel_order(const std::string& inst_id, const std::string& ord_id) {
        json params = {{"instId", inst_id}, {"ordId", ord_id}};
        std::string response = make_request("/api/v5/trade/cancel-order", "POST", params);
        return json::parse(response);
    }

    json get_order_details(const std::string& inst_id, const std::string& ord_id) {
        std::string endpoint = "/api/v5/trade/order?instId=" + inst_id +
                              "&ordId=" + ord_id;
        std::string response = make_request(endpoint);
        return json::parse(response);
    }

    json get_pending_orders(const std::string& inst_type = "SPOT") {
        std::string endpoint = "/api/v5/trade/orders-pending?instType=" + inst_type;
        std::string response = make_request(endpoint);
        return json::parse(response);
    }

    // Account
    json get_balance(const std::string& ccy = "") {
        std::string endpoint = "/api/v5/account/balance";
        if(!ccy.empty()) {
            endpoint += "?ccy=" + ccy;
        }
        std::string response = make_request(endpoint);
        return json::parse(response);
    }

    json get_positions(const std::string& inst_type = "") {
        std::string endpoint = "/api/v5/account/positions";
        if(!inst_type.empty()) {
            endpoint += "?instType=" + inst_type;
        }
        std::string response = make_request(endpoint);
        return json::parse(response);
    }
};

// Usage Example:
int main() {
    OKXClient client("your_api_key", "your_secret_key", "your_passphrase");

    // Get ticker
    json ticker = client.get_ticker("BTC-USDT");
    std::cout << "Ticker: " << ticker.dump(2) << std::endl;

    // Place limit order
    json order = {
        {"instId", "BTC-USDT"},
        {"tdMode", "cash"},
        {"side", "buy"},
        {"ordType", "limit"},
        {"sz", "0.01"},
        {"px", "45000"}
    };

    json order_result = client.place_order(order);
    std::cout << "Order: " << order_result.dump(2) << std::endl;

    return 0;
}

================================================================================
                          RATE LIMITS AND RESTRICTIONS
================================================================================

RATE LIMIT STRUCTURE:
---------------------
OKX implements a sophisticated rate limit system with different tiers.

PUBLIC ENDPOINTS:
- 20 requests per 2 seconds per IP

PRIVATE ENDPOINTS:
Trading:
- 60 requests per 2 seconds per API key
- Order placement: 60/2s for spot, 120/2s for futures

Account:
- 10 requests per 2 seconds

WEBSOCKET:
- 1 login per second
- 480 subscriptions per hour

RATE LIMIT RESPONSE:
--------------------
HTTP 429: Rate limit exceeded
{
  "code": "50011",
  "msg": "Rate limit reached"
}

BEST PRACTICES:
---------------
1. Implement exponential backoff
2. Use WebSocket for market data
3. Batch operations when possible
4. Monitor response headers
5. Maintain connection pools

================================================================================
                          MARKET DATA STRUCTURE
================================================================================

TICKER:
-------
{
  "code": "0",
  "msg": "",
  "data": [{
    "instType": "SPOT",
    "instId": "BTC-USDT",
    "last": "50000",
    "lastSz": "0.1",
    "askPx": "50001",
    "askSz": "5.2",
    "bidPx": "49999",
    "bidSz": "3.8",
    "open24h": "49500",
    "high24h": "50500",
    "low24h": "49000",
    "volCcy24h": "123456789",
    "vol24h": "2500",
    "ts": "1701234567890"
  }]
}

ORDER BOOK:
-----------
{
  "code": "0",
  "msg": "",
  "data": [{
    "asks": [
      ["50001", "1.5", "0", "2"],
      ["50002", "2.3", "0", "1"]
    ],
    "bids": [
      ["49999", "1.2", "0", "3"],
      ["49998", "3.1", "0", "1"]
    ],
    "ts": "1701234567890"
  }]
}
Format: [price, quantity, liquidated orders, number of orders]

CANDLESTICK:
------------
{
  "code": "0",
  "data": [
    ["1701234000000", "49500", "50100", "49900", "50000", "123.45", "6172500"]
  ]
}
Format: [timestamp, open, high, low, close, volume, volume in currency]

Bar intervals: 1m, 3m, 5m, 15m, 30m, 1H, 2H, 4H, 6H, 12H, 1D, 1W, 1M, 3M

================================================================================
                          ORDER TYPES SUPPORTED
================================================================================

ORDER TYPES:
------------
1. market: Market order
2. limit: Limit order
3. post_only: Post-only limit order
4. fok: Fill-or-kill
5. ioc: Immediate-or-cancel
6. optimal_limit_ioc: Market order with price limit

CONDITIONAL ORDERS:
-------------------
1. conditional: Trigger order
2. oco: One-cancels-other
3. trigger: Stop order
4. move_order_stop: Trailing stop
5. iceberg: Iceberg order
6. twap: Time-weighted average price

ORDER MODES (tdMode):
---------------------
- cash: Spot mode
- cross: Cross margin
- isolated: Isolated margin

EXAMPLE ORDERS:
---------------

Market Order:
{
  "instId": "BTC-USDT",
  "tdMode": "cash",
  "side": "buy",
  "ordType": "market",
  "sz": "100",  // 100 USDT worth
  "tgtCcy": "quote_ccy"
}

Limit Order:
{
  "instId": "BTC-USDT",
  "tdMode": "cash",
  "side": "buy",
  "ordType": "limit",
  "sz": "0.01",
  "px": "45000"
}

Stop Loss:
{
  "instId": "BTC-USDT",
  "tdMode": "cash",
  "side": "sell",
  "ordType": "conditional",
  "sz": "0.01",
  "triggerPx": "49000",
  "orderPx": "-1"  // Market price
}

Take Profit:
{
  "instId": "BTC-USDT",
  "tdMode": "cash",
  "side": "sell",
  "ordType": "conditional",
  "sz": "0.01",
  "triggerPx": "51000",
  "orderPx": "51000"
}

================================================================================
                              FEE STRUCTURE
================================================================================

SPOT TRADING (Regular):
-----------------------
Tier 1 (< $1M 30-day volume):
  Maker: 0.08% / Taker: 0.10%

Tier 2 ($1M - $10M):
  Maker: 0.07% / Taker: 0.10%

Tier 3 ($10M - $50M):
  Maker: 0.06% / Taker: 0.09%

Tier 4 ($50M - $100M):
  Maker: 0.05% / Taker: 0.08%

Tier 5 ($100M+):
  Maker: 0.04% / Taker: 0.07%

VIP tiers available with higher volumes and OKB holdings.

FUTURES TRADING:
----------------
Tier 1:
  Maker: 0.02% / Taker: 0.05%

Higher tiers available with volume discounts.

WITHDRAWAL FEES:
----------------
Variable by cryptocurrency and network:
- BTC: 0.0003 - 0.0006 BTC (network dependent)
- ETH: 0.003 - 0.01 ETH
- USDT (TRC20): 1 USDT
- USDT (ERC20): 5 USDT

================================================================================
                          WEBSOCKET CHANNELS
================================================================================

CONNECTION:
-----------
Public: wss://ws.okx.com:8443/ws/v5/public
Private: wss://ws.okx.com:8443/ws/v5/private

AUTHENTICATION (Private):
-------------------------
{
  "op": "login",
  "args": [{
    "apiKey": "your_api_key",
    "passphrase": "your_passphrase",
    "timestamp": "1701234567",
    "sign": "signature_here"
  }]
}

PUBLIC CHANNELS:
----------------
- instruments: Instrument information
- tickers: Ticker data
- open-interest: Open interest
- candle1m: 1-minute candlesticks (also 3m, 5m, 15m, 30m, 1H, etc.)
- trades: Real-time trades
- books: Order book (books5, books10, books50, books-l2-tbt)

PRIVATE CHANNELS:
-----------------
- account: Account balance changes
- positions: Position updates
- orders: Order updates
- algo-orders: Algo order updates

SUBSCRIPTION FORMAT:
--------------------
{
  "op": "subscribe",
  "args": [{
    "channel": "tickers",
    "instId": "BTC-USDT"
  }]
}

================================================================================
                            BEST PRACTICES
================================================================================

1. SECURITY:
------------
- Always use IP whitelist
- Separate keys for different functions
- Never enable withdrawal for automated systems
- Implement 2FA
- Monitor API activity

2. ERROR HANDLING:
------------------
- Check "code" field in responses (0 = success)
- Implement retry with backoff
- Handle rate limits (code 50011)
- Log errors with full context

3. PERFORMANCE:
---------------
- Use WebSocket for real-time data
- Enable compression for WebSocket
- Implement local order book management
- Use AWS endpoints for US traders
- Connection pooling for REST

4. TESTING:
-----------
- Use demo trading environment
- Header: x-simulated-trading: 1
- Test all failure scenarios
- Validate order parameters

================================================================================
                        GEOGRAPHIC RESTRICTIONS
================================================================================

RESTRICTED REGIONS:
-------------------
- Mainland China
- United States (limited access)
- Regions under international sanctions

SUPPORTED REGIONS:
------------------
- Most countries outside restricted list
- Check local regulations
- KYC required for full features

================================================================================
                          KYC REQUIREMENTS
================================================================================

LEVEL 1 (Basic):
----------------
- Email verification
- Withdrawal limit: 10 BTC/day
- Spot trading enabled

LEVEL 2 (Intermediate):
-----------------------
- ID verification
- Facial recognition
- Withdrawal limit: 500 BTC/day
- Margin and derivatives enabled

LEVEL 3 (Advanced):
-------------------
- Address verification
- Enhanced due diligence
- Unlimited withdrawals
- Institutional features

================================================================================
                          SUPPORT RESOURCES
================================================================================

DOCUMENTATION:
--------------
- API Docs: https://www.okx.com/docs-v5/en/
- WebSocket Docs: https://www.okx.com/docs-v5/en/#websocket-api
- GitHub: https://github.com/okx
- Postman: Available on OKX GitHub

SUPPORT:
--------
- Help Center: https://www.okx.com/support-center
- Live Chat: Available 24/7
- Email: support@okx.com
- Telegram: Official OKX API group

STATUS PAGE:
------------
- https://www.okx.com/system/status

DEMO ENVIRONMENT:
-----------------
Use x-simulated-trading: 1 header for paper trading

================================================================================
                              END OF DOCUMENT
================================================================================
