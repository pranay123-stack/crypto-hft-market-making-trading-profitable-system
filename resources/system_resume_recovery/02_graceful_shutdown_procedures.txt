================================================================================
GRACEFUL SHUTDOWN PROCEDURES
================================================================================

Procedures for safely shutting down HFT systems for maintenance, updates,
or end-of-day operations. Proper shutdown enables clean restart.

================================================================================
SHUTDOWN TYPES
================================================================================

**1. Planned Shutdown (Maintenance)**
- Time: End of trading day or scheduled maintenance window
- Notice: Hours to days advance notice
- Process: Full graceful shutdown
- Position handling: Flatten positions (optional) or keep overnight
- Duration: 5-30 minutes

**2. Emergency Shutdown**
- Time: Immediately
- Reason: Major issue detected, need to stop trading NOW
- Process: Fast shutdown (skip some steps)
- Position handling: Keep positions (flatten manually later)
- Duration: <30 seconds

**3. Rolling Restart (Zero-Downtime)**
- Time: During trading hours
- Process: Failover to backup, restart primary, failover back
- Position handling: Maintained on backup system
- Duration: No trading interruption

================================================================================
PLANNED SHUTDOWN - FULL PROCEDURE
================================================================================

**Pre-Shutdown Phase (15-30 minutes before)**

```
Step 1: Announce Shutdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Notify all stakeholders (traders, risk, ops)
✓ Post announcement in Slack/Teams
✓ Send email notifications
✓ Update status dashboard
✓ Set system status to "SHUTTING_DOWN_SOON"

Script:
$ ./scripts/announce_shutdown.sh --time "15:45" --reason "Maintenance"
```

```
Step 2: Disable New Strategy Deployment
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Lock CI/CD pipeline
✓ Prevent configuration changes
✓ Document current system state

Script:
$ ./scripts/lock_deployments.sh
```

```
Step 3: Reduce Position Sizes (Optional)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Gradually reduce position limits
✓ Allow strategies to wind down naturally
✓ Monitor P&L impact

Script:
$ ./scripts/reduce_position_limits.sh --percentage 50
```

**Shutdown Phase (5-10 minutes)**

```
Step 4: Stop New Order Generation
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Disable all trading strategies (stop generating signals)
✓ Let existing orders complete
✓ Monitor open orders

Script:
$ ./scripts/disable_strategies.sh --all

Verification:
$ ./scripts/check_strategy_status.sh
Output:
Strategy                Status      Last Signal
--------------------------------------------------
market_making_btc       DISABLED    10s ago
stat_arb_eth           DISABLED    15s ago
momentum_ltc           DISABLED    5s ago
```

```
Step 5: Cancel Open Orders (If Applicable)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Decision: Flatten positions or keep overnight?

Option A: Flatten Positions (End-of-Day)
- Cancel all open orders
- Market-close remaining positions
- Aim for zero positions

$ ./scripts/flatten_all_positions.sh --confirm

Option B: Keep Positions (Maintenance During Off-Hours)
- Cancel aggressive orders
- Keep passive orders (if providing liquidity)
- Maintain positions

$ ./scripts/cancel_aggressive_orders.sh
```

```
Step 6: Wait for Order Completion
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Monitor order status
✓ Wait for all pending fills
✓ Timeout: 60 seconds (then force proceed)

Script:
$ ./scripts/wait_for_orders.sh --timeout 60

While waiting:
- Monitor: Open orders count
- Monitor: Pending fills
- Monitor: Order status updates
```

```
Step 7: Final Position Reconciliation
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Query all exchange positions
✓ Compare with internal positions
✓ Investigate any discrepancies
✓ Document final positions

Script:
$ ./scripts/reconcile_positions.sh --exchanges all

Output:
Symbol    Internal    Binance    Coinbase    Status
────────────────────────────────────────────────────
BTC/USD   1.234       1.234      0.000       ✓ OK
ETH/USD   10.50       10.50      0.000       ✓ OK
LTC/USD   0.000       0.000      0.000       ✓ OK
```

```
Step 8: Save Complete State Checkpoint
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Save trading state (positions, orders, balances)
✓ Save configuration state
✓ Save strategy state
✓ Save recent market data (optional)
✓ Save logs (last hour)
✓ Calculate and save checksum
✓ Verify checkpoint integrity

Script:
$ ./scripts/checkpoint_state.sh --level complete --verify

Output:
[INFO] Checkpointing trading state... Done (2.1 MB)
[INFO] Checkpointing configuration... Done (45 KB)
[INFO] Checkpointing strategies... Done (128 KB)
[INFO] Checkpointing market data... Done (15.3 MB)
[INFO] Calculating checksum... Done (CRC64: 0x1a2b3c4d5e6f7890)
[INFO] Verifying checkpoint... OK
[INFO] Checkpoint saved: /data/checkpoints/shutdown_2024-11-25_15:45:23.ckpt
```

```
Step 9: Stop Market Data Feeds
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Unsubscribe from market data feeds
✓ Close WebSocket connections
✓ Stop market data processing threads

Script:
$ ./scripts/stop_market_data.sh --all

Verification:
$ ./scripts/check_connections.sh
Output:
Exchange    Market Data    Order Entry    Status
──────────────────────────────────────────────────
Binance     CLOSED         CONNECTED      OK
Coinbase    CLOSED         CONNECTED      OK
Kraken      CLOSED         CONNECTED      OK
```

```
Step 10: Close Exchange Connections
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Logout from exchanges (if applicable)
✓ Close order entry connections
✓ Cancel exchange sessions

Script:
$ ./scripts/disconnect_exchanges.sh --all --graceful

Output:
[INFO] Disconnecting from Binance... Done
[INFO] Disconnecting from Coinbase... Done
[INFO] Disconnecting from Kraken... Done
```

```
Step 11: Stop Services
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Stop trading engine
✓ Stop risk manager
✓ Stop order management system
✓ Stop strategies
✓ Wait for clean exit (threads joined)

Script:
$ ./scripts/stop_services.sh --graceful --timeout 30

Order:
1. Trading strategies (stop signal generation)
2. Trading engine (stop order processing)
3. Risk manager (stop risk checks)
4. Order management system
5. Market data handlers
6. Monitoring agents (keep alive a bit longer)
```

```
Step 12: Final Health Check
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Verify no processes still running
✓ Check for orphaned threads
✓ Verify checkpoint files exist
✓ Document shutdown completion time

Script:
$ ./scripts/verify_shutdown.sh

Checks:
- No trading processes running
- All sockets closed
- Checkpoint files present and valid
- Logs flushed to disk
- No errors in last 5 minutes
```

```
Step 13: Post-Shutdown Actions
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Send shutdown complete notification
✓ Update monitoring dashboard
✓ Document final state (positions, P&L)
✓ Archive logs
✓ Update runbook with any issues encountered

Script:
$ ./scripts/post_shutdown.sh

Notifications:
- Slack: "System shutdown complete at 15:52 UTC"
- Email: Detailed shutdown report
- Dashboard: Status = "OFFLINE"
```

================================================================================
EMERGENCY SHUTDOWN - FAST PROCEDURE
================================================================================

**When to Use:**
- Major bug detected causing losses
- Exchange API misbehaving
- Data quality issues
- Security incident
- Regulatory requirement

**Procedure (Target: <30 seconds):**

```bash
#!/bin/bash
# emergency_shutdown.sh

echo "=== EMERGENCY SHUTDOWN INITIATED ==="
date

# 1. STOP ALL TRADING IMMEDIATELY (0-5 seconds)
echo "Disabling all strategies..."
kill -STOP $(pgrep -f trading_engine)  # Pause process immediately

# 2. ACTIVATE KILL SWITCH (5-10 seconds)
echo "Activating kill switch..."
curl -X POST http://localhost:8080/api/killswitch/activate

# 3. CANCEL ALL OPEN ORDERS (10-20 seconds)
echo "Canceling all open orders..."
./scripts/cancel_all_orders.sh --force --no-confirm

# 4. QUICK STATE SAVE (20-25 seconds)
echo "Saving emergency checkpoint..."
./scripts/checkpoint_state.sh --level quick --no-verify

# 5. FORCE STOP PROCESSES (25-30 seconds)
echo "Force stopping all services..."
pkill -TERM -f trading_engine
sleep 2
pkill -KILL -f trading_engine  # Force kill if not stopped

echo "=== EMERGENCY SHUTDOWN COMPLETE ==="
date
```

**Post-Emergency Actions (Manual):**
1. Investigate root cause
2. Reconcile positions with exchanges
3. Manual flatten positions (if needed)
4. Fix issue
5. Test fix
6. Plan restart

================================================================================
SHUTDOWN CHECKLIST
================================================================================

**Pre-Shutdown** ✓
□ Shutdown announced (all stakeholders notified)
□ Reason documented
□ Expected downtime communicated
□ No critical orders pending
□ Risk manager approval obtained

**During Shutdown** ✓
□ Strategies disabled
□ New orders stopped
□ Open orders handled (canceled or completed)
□ Position reconciliation done
□ State checkpoint saved and verified
□ Market data feeds stopped
□ Exchange connections closed gracefully
□ All services stopped cleanly
□ No orphaned processes

**Post-Shutdown** ✓
□ Shutdown completion notified
□ Final positions documented
□ P&L calculated and recorded
□ Logs archived
□ Monitoring updated (status = OFFLINE)
□ Any issues documented in runbook

**Verification** ✓
□ Checkpoint file exists
□ Checkpoint file valid (checksum OK)
□ No trading processes running
□ All sockets closed
□ No errors in logs (last 5 min)

================================================================================
SHUTDOWN SCRIPT EXAMPLE (PRODUCTION)
================================================================================

```bash
#!/bin/bash
# graceful_shutdown.sh - Production shutdown script

set -e  # Exit on error

SHUTDOWN_REASON="${1:-Maintenance}"
FLATTEN_POSITIONS="${2:-yes}"  # yes or no
LOG_FILE="/var/log/trading/shutdown_$(date +%Y%m%d_%H%M%S).log"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "==================================================================="
log "GRACEFUL SHUTDOWN INITIATED"
log "Reason: $SHUTDOWN_REASON"
log "Flatten Positions: $FLATTEN_POSITIONS"
log "==================================================================="

# Step 1: Announce
log "Step 1: Announcing shutdown..."
./scripts/announce_shutdown.sh --reason "$SHUTDOWN_REASON" || true
sleep 2

# Step 2: Disable strategies
log "Step 2: Disabling all strategies..."
./scripts/disable_strategies.sh --all
if [ $? -ne 0 ]; then
    log "ERROR: Failed to disable strategies"
    exit 1
fi
sleep 5

# Step 3: Handle positions
if [ "$FLATTEN_POSITIONS" = "yes" ]; then
    log "Step 3: Flattening all positions..."
    ./scripts/flatten_all_positions.sh --confirm
    FLATTEN_STATUS=$?
    if [ $FLATTEN_STATUS -ne 0 ]; then
        log "WARNING: Position flattening incomplete (status: $FLATTEN_STATUS)"
    fi
else
    log "Step 3: Canceling aggressive orders only..."
    ./scripts/cancel_aggressive_orders.sh
fi
sleep 10

# Step 4: Wait for orders to complete
log "Step 4: Waiting for order completion..."
./scripts/wait_for_orders.sh --timeout 60
sleep 2

# Step 5: Reconcile positions
log "Step 5: Reconciling positions..."
./scripts/reconcile_positions.sh --exchanges all > /tmp/positions_final.txt
cat /tmp/positions_final.txt | tee -a "$LOG_FILE"

# Step 6: Save state
log "Step 6: Checkpointing state..."
CHECKPOINT_FILE=$(./scripts/checkpoint_state.sh --level complete --verify)
if [ $? -ne 0 ]; then
    log "ERROR: Checkpoint failed!"
    exit 1
fi
log "Checkpoint saved: $CHECKPOINT_FILE"

# Step 7: Stop market data
log "Step 7: Stopping market data feeds..."
./scripts/stop_market_data.sh --all
sleep 2

# Step 8: Disconnect exchanges
log "Step 8: Disconnecting from exchanges..."
./scripts/disconnect_exchanges.sh --all --graceful
sleep 2

# Step 9: Stop services
log "Step 9: Stopping all services..."
./scripts/stop_services.sh --graceful --timeout 30
if [ $? -ne 0 ]; then
    log "WARNING: Some services did not stop gracefully, force killing..."
    ./scripts/stop_services.sh --force
fi

# Step 10: Verify shutdown
log "Step 10: Verifying shutdown..."
./scripts/verify_shutdown.sh
if [ $? -ne 0 ]; then
    log "ERROR: Shutdown verification failed!"
    exit 1
fi

# Step 11: Post-shutdown
log "Step 11: Post-shutdown actions..."
./scripts/post_shutdown.sh --log "$LOG_FILE"

log "==================================================================="
log "GRACEFUL SHUTDOWN COMPLETE"
log "Duration: $SECONDS seconds"
log "==================================================================="

exit 0
```

================================================================================
POSITION FLATTENING STRATEGY
================================================================================

**Aggressive Flattening (Market Orders):**
```bash
# Fastest way to exit positions
# Use when: Need to close ASAP, accepting slippage
for symbol in $(get_all_positions); do
    quantity=$(get_position_quantity $symbol)
    if [ "$quantity" != "0" ]; then
        side=$(if [ "$quantity" > 0 ]; then echo "sell"; else echo "buy"; fi)
        ./scripts/submit_order.sh \
            --symbol "$symbol" \
            --side "$side" \
            --type market \
            --quantity "$(abs $quantity)"
    fi
done
```

**Conservative Flattening (Limit Orders):**
```bash
# Slower but better execution
# Use when: Have time, want to minimize slippage
for symbol in $(get_all_positions); do
    quantity=$(get_position_quantity $symbol)
    if [ "$quantity" != "0" ]; then
        mid_price=$(get_mid_price $symbol)
        side=$(if [ "$quantity" > 0 ]; then echo "sell"; else echo "buy"; fi)

        # Place limit order at mid-market
        ./scripts/submit_order.sh \
            --symbol "$symbol" \
            --side "$side" \
            --type limit \
            --price "$mid_price" \
            --quantity "$(abs $quantity)" \
            --time-in-force IOC  # Immediate or cancel
    fi
done

# Wait 5 seconds for fills
sleep 5

# Any remaining positions: Market order
for symbol in $(get_remaining_positions); do
    # ... market order logic ...
done
```

================================================================================
MONITORING DURING SHUTDOWN
================================================================================

**Key Metrics to Watch:**

1. **Open Orders Count**
   - Should decrease to zero
   - Alert if stuck above zero for >60 seconds

2. **Position Sizes**
   - Should decrease (if flattening)
   - Monitor for unexpected increases

3. **P&L**
   - Track slippage cost during flatten
   - Alert if loss exceeds threshold

4. **Order Reject Rate**
   - Should be low (<5%)
   - High rate indicates exchange issues

5. **Process Status**
   - All processes should stop cleanly
   - No crashed/zombie processes

**Dashboard View During Shutdown:**
```
═══════════════════════════════════════════════════════════
SHUTDOWN IN PROGRESS
═══════════════════════════════════════════════════════════
Status: SHUTTING_DOWN
Started: 2024-11-25 15:45:00 UTC
Elapsed: 3m 27s

Open Orders:        12  → Target: 0
Positions:          3   → Target: 0 (if flattening)
Active Strategies:  0   ✓
Market Data:        STOPPED ✓
Exchange Connections: 2 connected (closing...)

Recent Actions:
[15:47:23] Disabled all strategies ✓
[15:47:45] Canceling open orders (12 pending)
[15:48:02] Flattening position BTC/USD (-0.5 BTC)
[15:48:15] Flattening position ETH/USD (+5.2 ETH)
[15:48:27] Waiting for order completion...
═══════════════════════════════════════════════════════════
```

================================================================================
TROUBLESHOOTING SHUTDOWN ISSUES
================================================================================

**Issue 1: Orders Not Canceling**
Symptom: Orders stuck in "CANCELING" state
Cause: Exchange not responding
Solution:
```bash
# Force local state update (mark as canceled locally)
./scripts/force_cancel_local.sh --order-id <ID>

# Investigate exchange connectivity
./scripts/check_exchange_health.sh --exchange <NAME>

# Contact exchange support if needed
```

**Issue 2: Positions Not Flattening**
Symptom: Positions remain after flatten attempt
Cause: Orders not filling, low liquidity
Solution:
```bash
# Check order status
./scripts/check_order_status.sh --all

# Use more aggressive pricing (market orders)
./scripts/flatten_all_positions.sh --aggressive

# Manual intervention if automated fails
```

**Issue 3: Process Not Stopping**
Symptom: Service doesn't respond to SIGTERM
Cause: Deadlock, infinite loop, hanging I/O
Solution:
```bash
# Try graceful stop first (30 sec timeout)
timeout 30 ./scripts/stop_service.sh --name trading_engine

# If fails, force kill
pkill -KILL -f trading_engine

# Investigate later: check core dump
gdb ./trading_engine core
```

**Issue 4: Checkpoint Fails**
Symptom: State checkpoint errors
Cause: Disk full, I/O error, corruption
Solution:
```bash
# Check disk space
df -h /data

# Try alternative checkpoint location
./scripts/checkpoint_state.sh --path /tmp/checkpoint_emergency.ckpt

# Manual state extraction
./scripts/extract_state_from_logs.sh > /tmp/state_manual.json
```

================================================================================
POST-SHUTDOWN VALIDATION
================================================================================

After shutdown, verify:

```bash
# No trading processes
$ ps aux | grep trading_engine
# Should return empty

# Checkpoint file exists and valid
$ ls -lh /data/checkpoints/latest.ckpt
$ ./scripts/validate_checkpoint.sh /data/checkpoints/latest.ckpt
# Should output: "Checkpoint valid ✓"

# Final positions documented
$ cat /tmp/positions_final.txt

# No open sockets
$ netstat -an | grep ESTABLISHED | grep -E '8080|9000'
# Should return empty (no exchange connections)

# Logs clean (no errors in last 5 min)
$ ./scripts/check_logs.sh --last 5m --level ERROR
# Should return: "No errors found"
```

================================================================================
