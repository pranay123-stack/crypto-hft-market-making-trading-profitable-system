================================================================================
ORDER FLOW ANALYSIS FOR HFT
High-Frequency Trading System Documentation
================================================================================

Order flow analysis tracks buying and selling pressure through executed trades.
Critical for HFT strategies to detect:
- Large institutional orders
- Aggressive vs. passive flow
- Order flow toxicity
- Imbalances predicting price moves

KEY CONCEPTS:
Trade Classification: Buy vs. Sell initiated
- Tick Rule: Trade above/below last trade
- Quote Rule: At bid (sell) or ask (buy)
- Lee-Ready Algorithm: Combines both

Aggregate Order Flow = ΣBuy Volume - ΣSell Volume

class OrderFlowAnalyzer {
private:
    int64_t cumulative_buy_volume_ = 0;
    int64_t cumulative_sell_volume_ = 0;
    
public:
    void add_trade(int64_t volume, bool is_buy) {
        if (is_buy) cumulative_buy_volume_ += volume;
        else cumulative_sell_volume_ += volume;
    }
    
    int64_t net_flow() const {
        return cumulative_buy_volume_ - cumulative_sell_volume_;
    }
    
    double flow_ratio() const {
        int64_t total = cumulative_buy_volume_ + cumulative_sell_volume_;
        if (total == 0) return 0.0;
        return (double)net_flow() / total;
    }
    
    bool is_bullish(double threshold = 0.2) const {
        return flow_ratio() > threshold;
    }
    
    bool is_bearish(double threshold = -0.2) const {
        return flow_ratio() < threshold;
    }
};

TRADE CLASSIFICATION ALGORITHMS:

1. Tick Rule:
   if (trade_price > last_trade_price) → BUY
   else if (trade_price < last_trade_price) → SELL
   else → Use previous classification

2. Quote Rule:
   if (trade_price == ask) → BUY
   else if (trade_price == bid) → SELL
   else if (trade_price > mid) → BUY
   else → SELL

3. Lee-Ready Algorithm:
   - Use quote rule if trade not at mid
   - Use tick rule if at mid
   - Look back 5 seconds for quotes

VOLUME DELTA:
Delta = Buy Volume - Sell Volume at each price

Cumulative Volume Delta (CVD):
CVD_t = CVD_{t-1} + Delta_t

class CumulativeVolumeDelta {
private:
    int64_t cvd_ = 0;
    std::vector<int64_t> cvd_history_;
    
public:
    void add_trade(int64_t volume, bool is_buy) {
        if (is_buy) cvd_ += volume;
        else cvd_ -= volume;
        cvd_history_.push_back(cvd_);
    }
    
    int64_t current_cvd() const { return cvd_; }
    
    bool is_divergence(const std::vector<double>& price_history) const {
        if (cvd_history_.size() < 2 || price_history.size() < 2) 
            return false;
        
        // Bullish divergence: Price makes lower low, CVD makes higher low
        // Bearish divergence: Price makes higher high, CVD makes lower high
        // (Simplified logic)
        
        return false;  // Implementation specific
    }
};

ORDER FLOW IMBALANCE:
OFI = (Buy Volume @ Ask - Sell Volume @ Bid) / Total Volume

Predicts short-term price movements (1-10 seconds ahead).

class OrderFlowImbalance {
private:
    struct FlowData {
        int64_t buy_at_ask;
        int64_t sell_at_bid;
        uint64_t timestamp_us;
    };
    
    std::deque<FlowData> flow_window_;
    uint64_t window_duration_us_ = 1000000;  // 1 second
    
public:
    void add_trade(int64_t volume, bool is_buy, bool at_touch, 
                   uint64_t timestamp) {
        FlowData data{0, 0, timestamp};
        
        if (is_buy && at_touch) data.buy_at_ask = volume;
        if (!is_buy && at_touch) data.sell_at_bid = volume;
        
        flow_window_.push_back(data);
        
        // Remove old data
        while (!flow_window_.empty() && 
               timestamp - flow_window_.front().timestamp_us > window_duration_us_) {
            flow_window_.pop_front();
        }
    }
    
    double calculate_ofi() const {
        int64_t total_buy_at_ask = 0;
        int64_t total_sell_at_bid = 0;
        
        for (const auto& data : flow_window_) {
            total_buy_at_ask += data.buy_at_ask;
            total_sell_at_bid += data.sell_at_bid;
        }
        
        int64_t total = total_buy_at_ask + total_sell_at_bid;
        if (total == 0) return 0.0;
        
        return (double)(total_buy_at_ask - total_sell_at_bid) / total;
    }
};

TRADING APPLICATIONS:

1. Order Flow Momentum Strategy:
   - Strong positive flow → Go long
   - Strong negative flow → Go short
   - Mean reversion when flow exhausted

2. Divergence Strategy:
   - Price up, flow down → Potential reversal
   - Price down, flow up → Potential reversal

3. Flow-Based Execution:
   - Execute with flow to reduce impact
   - Avoid executing against toxic flow

PERFORMANCE METRICS:
- Flow Toxicity: Adverse selection probability
- Flow Persistence: How long flow imbalance lasts
- Flow Impact: Price movement per unit flow

================================================================================
Version: 1.0 | Size: ~20 KB
================================================================================
