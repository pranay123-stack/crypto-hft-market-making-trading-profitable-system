================================================================================
RISK MANAGEMENT GUIDANCE FOR HFT SYSTEMS
================================================================================

Compiled from risk managers at leading HFT firms, regulatory guidance, and
lessons learned from trading disasters. Risk management is not optional - it's
what keeps you in business.

⚠️ CRITICAL: These are guidelines. Every firm must develop risk management
tailored to their strategies, capital, and risk appetite.

================================================================================
PRE-TRADE RISK CONTROLS - SARAH MILLER (Jump Trading Risk)
================================================================================

"Pre-trade checks are your first line of defense. They must be fast and comprehensive."

1. **Position Limits**
   ```
   Per-Symbol Limits:
   - Max long position per symbol
   - Max short position per symbol
   - Max absolute position per symbol
   - Max notional exposure per symbol

   Portfolio Limits:
   - Max gross exposure (sum of all positions)
   - Max net exposure (net long or short)
   - Concentration limits (single position < X% of portfolio)
   - Sector/asset class limits
   ```

2. **Order Size Limits**
   ```
   - Max order size per order
   - Max order size as % of daily volume
   - Max order size relative to order book depth
   - Total orders per second (prevent runaway)
   ```

3. **Fat Finger Detection**
   ```
   Check for:
   - Order size > X standard deviations from mean
   - Order price > Y% away from mid-market
   - Order notional > Z dollars
   - Unusual symbol (typo in ticker)

   Example: Order size > 10x average order size → Reject
   ```

4. **Duplicate Order Prevention**
   ```
   - Track recent orders (last 1 second)
   - Reject if identical order within time window
   - Use order fingerprint: (symbol, side, price, size)
   - Protects against buggy code, retry logic gone wrong
   ```

5. **Self-Trade Prevention**
   ```
   - Track own orders in book
   - Prevent crossing your own orders
   - Reduces fees, avoids wash trades
   - Exchange-specific implementations vary
   ```

6. **Credit/Margin Checks**
   ```
   - Available buying power
   - Margin requirements per position
   - Account for pending orders
   - Real-time balance tracking
   ```

**Performance Requirement**: < 5 microseconds for all pre-trade checks

**Implementation:**
```cpp
enum class RiskCheckResult {
    APPROVED,
    REJECTED_POSITION_LIMIT,
    REJECTED_ORDER_SIZE,
    REJECTED_FAT_FINGER,
    REJECTED_DUPLICATE,
    REJECTED_CREDIT,
    REJECTED_SELF_TRADE
};

struct RiskLimits {
    double max_position_per_symbol;
    double max_total_exposure;
    double max_order_size;
    double max_notional_per_order;
    int max_orders_per_second;
};

class PreTradeRiskManager {
public:
    RiskCheckResult CheckOrder(const Order& order, const Portfolio& portfolio);
    // Implementation must be lock-free for low latency
};
```

**Quote**: "Every rejected order is a potential disaster prevented. Better to miss a trade than blow up."

================================================================================
REAL-TIME MONITORING - MICHAEL RODRIGUEZ (Citadel Risk)
================================================================================

"If you're not monitoring in real-time, you're flying blind."

1. **P&L Tracking**
   ```
   Track at Multiple Levels:
   - Per trade (realized P&L)
   - Per position (unrealized P&L mark-to-market)
   - Per strategy
   - Per symbol
   - Per exchange
   - Portfolio total

   Frequency: Real-time (every market data update)
   Latency: < 100 microseconds
   ```

2. **Position Reconciliation**
   ```
   Compare:
   - Internal position tracker
   - Exchange reported positions
   - Clearing house positions

   Frequency: Every 1-5 seconds
   Discrepancies: Investigate immediately, halt trading if large

   Common causes:
   - Missed fill notification
   - Duplicate fill processing
   - Partial fill handling bug
   - Exchange error (rare)
   ```

3. **Loss Limits**
   ```
   Hierarchical Limits:

   Per-Trade Loss:
   - Stop-loss on every position
   - Automatic exit if loss > limit
   - Example: -$5,000 per trade

   Intraday Loss (Mark-to-Market):
   - Track unrealized losses
   - Reduce positions if nearing limit
   - Example: -$50,000 intraday drawdown

   Daily Loss (Realized):
   - Cumulative P&L for the day
   - Kill switch if exceeded
   - Example: -$100,000 daily loss

   Weekly/Monthly Loss:
   - Longer-term risk management
   - May trigger strategy review
   - Example: -$500,000 monthly loss
   ```

4. **Exposure Monitoring**
   ```
   Metrics:
   - Gross exposure: |Long| + |Short|
   - Net exposure: Long - Short
   - Leverage: Gross exposure / Capital
   - Beta-adjusted exposure (if applicable)
   - Delta exposure (for options)

   Alerts:
   - Exposure > X% of normal
   - Concentration in single symbol > Y%
   - Correlation risk: Positions moving together
   ```

5. **VaR (Value at Risk)**
   ```
   Calculate Daily VaR:
   - 99% confidence: Loss won't exceed $X on 99% of days
   - Historical method: Past returns distribution
   - Parametric method: Assume normal distribution
   - Monte Carlo: Simulate future scenarios

   Update frequency: End of day (slow) or real-time (better)

   Example: $200K VaR (99%) means expected to lose > $200K on 1% of days
   ```

**Quote**: "Know your risks before they blow up your account. Real-time visibility is non-negotiable."

================================================================================
CIRCUIT BREAKERS - DAVID CHEN (Virtu Risk)
================================================================================

"Automated kill switches save you when things go wrong."

1. **Daily Loss Kill Switch**
   ```
   Trigger: Daily realized loss > $X
   Action:
   - Immediately stop all new orders
   - Flatten all open positions (market orders)
   - Disable all strategies
   - Alert risk manager + trader
   - Require manual approval to resume

   Example Threshold: $100,000 (for $10M portfolio = 1%)

   Test Frequency: Monthly
   ```

2. **Rapid Drawdown Circuit Breaker**
   ```
   Trigger: Loss of $Y within Z minutes
   Action:
   - Pause trading for cooldown period
   - Reduce position sizes by 50%
   - Alert risk manager
   - Automatic resume after 15 minutes if below threshold

   Example: $20,000 loss within 5 minutes
   ```

3. **Position Limit Breach**
   ```
   Trigger: Position exceeds limit (shouldn't happen if pre-trade works)
   Action:
   - No new orders in that direction
   - Force reduce position to limit
   - Investigate how limit was breached (bug?)
   ```

4. **Order Flood Protection**
   ```
   Trigger: > N orders per second
   Action:
   - Throttle order rate
   - If sustained, halt strategy
   - Prevents runaway loops

   Example: > 100 orders/second for 10 seconds
   ```

5. **Data Quality Circuit Breaker**
   ```
   Trigger: Market data anomalies
   - Stale data (no updates for X seconds)
   - Invalid prices (negative, zero, absurdly high)
   - Sequence gaps (missing messages)
   - Timestamp problems

   Action:
   - Halt strategies relying on that data
   - Switch to backup data feed
   - Alert immediately
   ```

6. **Exchange Connectivity Circuit Breaker**
   ```
   Trigger: Connection issues
   - Disconnection from exchange
   - High latency (> 100ms)
   - Order ack timeout

   Action:
   - Stop sending new orders to that exchange
   - Monitor existing positions
   - Attempt reconnection
   - Failover to backup connection
   ```

7. **System Anomaly Detection**
   ```
   Trigger: Abnormal system behavior
   - CPU usage > 95% sustained
   - Memory usage > 90%
   - Network saturation
   - Disk full

   Action:
   - Reduce load (pause non-critical strategies)
   - Alert DevOps
   - Failover to backup system if available
   ```

**Quote**: "Hope is not a strategy. Automate your kill switches and test them religiously."

**Testing Requirements:**
- Monthly kill switch drill
- Simulate each trigger condition
- Measure time to halt (target: <1 second)
- Verify notifications work
- Document every test

================================================================================
POSITION MANAGEMENT - ANNA KIM (Tower Research Risk)
================================================================================

"Managing positions is about balancing profit potential with risk exposure."

1. **Dynamic Position Sizing**
   ```
   Kelly Criterion (Theoretical Optimal):
   f = (p * b - q) / b
   where:
   - f = fraction of capital to bet
   - p = probability of win
   - q = probability of loss = 1 - p
   - b = win/loss ratio

   In Practice: Use 25-50% of Kelly (more conservative)

   Volatility Adjusted:
   Position Size = Base Size * (Historical Vol / Current Vol)
   → Larger size in low volatility, smaller in high volatility
   ```

2. **Inventory Management (Market Making)**
   ```
   Target: Zero inventory (neutral)

   Quote Skewing:
   Inventory_skew = (Current_Position / Max_Position) * Skew_Coefficient

   If long (have inventory):
   - Bid_offset = Inventory_skew (widen bid)
   - Ask_offset = -Inventory_skew (tighten ask)
   → Encourages selling

   If short (need inventory):
   - Bid_offset = -Inventory_skew (tighten bid)
   - Ask_offset = Inventory_skew (widen ask)
   → Encourages buying
   ```

3. **Multi-Exchange Netting**
   ```
   Total position across all exchanges:
   BTC_position = BTC_binance + BTC_coinbase + BTC_kraken + ...

   Apply limits to total, not per-exchange

   Complexity: Transfers take time
   - Can't instantly move position between exchanges
   - Must account for pending transfers
   - Risk: Position on exchange A, market moves, can't offset immediately
   ```

4. **Hedging**
   ```
   Delta Hedging (for options):
   - Option delta = change in option price / change in underlying
   - Hedge by trading opposite delta in underlying
   - Re-hedge as delta changes (gamma risk)

   Cross-Asset Hedging:
   - Long BTC, short ETH (if correlated)
   - Reduces directional risk
   - Keeps correlation risk

   Futures Hedging:
   - Long spot, short futures
   - Basis risk: Spot and futures prices diverge
   ```

5. **Position Aging**
   ```
   Monitor how long positions are held:
   - Market making: Seconds to minutes (target)
   - Stat arb: Minutes to hours
   - Momentum: Hours to days

   If position held too long:
   - Strategy may not be working
   - Consider forced exit
   - Review strategy logic
   ```

**Quote**: "Position management is risk management in action. Size appropriately and adjust dynamically."

================================================================================
STRESS TESTING - ROBERT JACKSON (Two Sigma Risk)
================================================================================

"Test your strategies under extreme conditions before reality does."

1. **Historical Stress Tests**
   ```
   Replay Historical Crises:
   - 2008 Financial Crisis
   - 2010 Flash Crash
   - 2020 COVID Crash
   - 2022 Luna/FTX Collapse

   Questions:
   - Would strategy have survived?
   - Max drawdown during crisis?
   - Recovery time?
   - Liquidity available to exit?
   ```

2. **Scenario Analysis**
   ```
   Extreme Scenarios:
   - Volatility spikes 10x
   - Exchange halts trading
   - Internet connection lost
   - Competitor changes strategy (impacts your edge)
   - Regulatory change (ban on certain strategies)

   For each scenario:
   - What's the impact?
   - How to mitigate?
   - Recovery plan?
   ```

3. **Liquidity Stress Test**
   ```
   Assume:
   - Bid-ask spread widens 5x
   - Order book depth drops 80%
   - Slippage 10x normal

   Can you:
   - Exit positions within acceptable loss?
   - Meet margin calls?
   - Survive until liquidity returns?
   ```

4. **Operational Stress Tests**
   ```
   Failure Scenarios:
   - Primary system crashes
   - Network partition
   - Data feed corrupted
   - Key personnel unavailable
   - Exchange API changes

   Test:
   - Failover to backup system
   - Manual intervention procedures
   - Communication protocols
   ```

5. **Correlation Breakdown**
   ```
   Assumption: Positions are uncorrelated
   Reality: Correlation → 1 during crises

   Test:
   - All positions move against you simultaneously
   - Max loss if all hit stop-loss at once
   - Diversification benefit disappears
   ```

**Stress Test Schedule:**
- Monthly: Standard scenarios
- Quarterly: Comprehensive stress tests
- Annually: Third-party audit of risk systems

**Quote**: "If you haven't stress-tested it, it's not ready for production."

================================================================================
RISK CULTURE - TOM HAYES (Goldman Sachs)
================================================================================

"Risk management is everyone's responsibility, not just the risk team."

1. **Organizational Structure**
   ```
   Independent Risk Team:
   - Reports to CRO, not head of trading
   - Power to halt trading
   - Access to all systems and data
   - Regular risk committee meetings
   ```

2. **Trader Incentives**
   ```
   Align incentives with risk-adjusted returns:
   - Bonus based on Sharpe ratio, not just P&L
   - Clawback for losses exceeding limits
   - Penalize limit breaches
   - Reward risk management discipline
   ```

3. **Risk Reporting**
   ```
   Daily Risk Report:
   - P&L by strategy
   - Current positions and exposure
   - VaR and stress test results
   - Limit utilization
   - Any limit breaches or exceptions

   Weekly Risk Review:
   - Strategy performance review
   - Risk incidents and resolutions
   - Forward-looking risks
   ```

4. **Escalation Procedures**
   ```
   Level 1: Approaching limit (80%) → Alert trader
   Level 2: Limit breach → Alert risk manager + pause strategy
   Level 3: Significant loss → Alert CRO + halt all trading

   24/7 on-call rotation for critical alerts
   ```

5. **Post-Mortem Culture**
   ```
   After any incident:
   - Blameless post-mortem
   - Root cause analysis
   - What went wrong?
   - How to prevent recurrence?
   - Update procedures
   - Share learnings across team
   ```

**Quote**: "A strong risk culture is your best defense against catastrophic losses."

================================================================================
REGULATORY RISK - COMPLIANCE PERSPECTIVE
================================================================================

"Risk management includes staying on the right side of regulators."

1. **Regulatory Requirements**
   ```
   Must Have:
   - Pre-trade risk controls (mandated by most jurisdictions)
   - Kill switches (required by many exchanges)
   - Audit trail of all orders and trades
   - Risk limits documentation
   - Disaster recovery plan
   - Periodic compliance reviews
   ```

2. **Market Manipulation Risks**
   ```
   Forbidden:
   - Spoofing: Placing orders with intent to cancel
   - Layering: Multiple orders to deceive
   - Quote stuffing: Excessive orders to slow others
   - Front-running: Trading ahead of customer orders
   - Wash trading: Self-trading to fake volume

   Ensure strategies don't inadvertently violate
   ```

3. **Audit Requirements**
   ```
   Must Log:
   - Every order (with timestamp, user, strategy)
   - Every cancellation
   - Every trade
   - Every risk limit breach
   - Every manual override
   - Every system event

   Retention: 7 years typically
   Immutable: Logs cannot be edited
   ```

4. **Testing and Certification**
   ```
   Before Production:
   - Comprehensive testing in sandbox environment
   - Certification by compliance team
   - Risk approval
   - Exchange approval (if required)

   Document everything
   ```

**Quote**: "Regulators are not optional. Compliance is risk management."

================================================================================
DISASTER SCENARIOS - LESSONS FROM FAILURES
================================================================================

Famous disasters and what we learned:

**Knight Capital (2012): $440M loss in 45 minutes**
- Cause: Buggy code deployed, generated millions of unintended orders
- Lesson: Test thoroughly, deploy gradually (canary), kill switch mandatory
- Prevention: Code review, staging environment, automated tests

**Long-Term Capital Management (1998): $4.6B loss**
- Cause: Highly leveraged, correlated positions, liquidity dried up
- Lesson: Leverage is dangerous, stress test correlations, manage liquidity
- Prevention: Lower leverage, diversification, liquidity reserves

**Flash Crash (2010): Market dropped 9% in minutes**
- Cause: Algorithm interactions, positive feedback loops
- Lesson: Markets can move extremely fast, need circuit breakers
- Prevention: Position limits, order throttling, market-wide circuit breakers

**FTX (2022): Entire exchange collapse**
- Cause: Counterparty risk, exchange insolvency
- Lesson: Exchange risk is real, don't keep all funds on exchanges
- Prevention: Diversify across exchanges, withdraw excess funds, monitor exchange solvency

================================================================================
RISK MANAGEMENT CHECKLIST
================================================================================

Before going live, ensure:

**Pre-Trade Controls** ✓
□ Position limits enforced
□ Order size limits enforced
□ Fat finger detection active
□ Duplicate prevention active
□ Self-trade prevention active
□ Latency < 5 microseconds

**Real-Time Monitoring** ✓
□ P&L tracked per strategy, symbol, portfolio
□ Position reconciliation every 5 seconds
□ Loss limits monitored
□ VaR calculated
□ Exposure tracked

**Circuit Breakers** ✓
□ Daily loss kill switch configured and tested
□ Rapid drawdown breaker active
□ Order flood protection active
□ Data quality breaker active
□ Connectivity breaker active

**Operational** ✓
□ Disaster recovery plan documented
□ Failover tested
□ On-call rotation established
□ Escalation procedures defined
□ Post-mortem process defined

**Compliance** ✓
□ Audit logging complete
□ Regulatory requirements met
□ Compliance sign-off obtained
□ Testing documented

**Testing** ✓
□ Stress tests completed
□ Historical crisis replay tested
□ Extreme scenarios tested
□ Operational failures tested
□ Monthly kill switch drill scheduled

================================================================================

**FINAL WORD**: Risk management is not a one-time setup. It's continuous monitoring, testing, and improvement. Markets change, strategies evolve, risks emerge. Stay vigilant.

================================================================================
