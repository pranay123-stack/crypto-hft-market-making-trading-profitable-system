================================================================================
C++ DEPENDENCIES FOR HIGH-FREQUENCY TRADING SYSTEM
================================================================================

OVERVIEW
--------
This guide covers installation of all C++ libraries and tools required for
building a production HFT system. Focus is on:
- Ultra-low latency libraries
- Lock-free data structures
- High-performance networking
- Zero-copy serialization
- Comprehensive testing frameworks

PREREQUISITES
-------------
- Completed: 01_package_managers.txt
- vcpkg installed and working
- GCC 13+ or Clang 17+ installed
- CMake 3.28+ installed

CORE C++ LIBRARIES
==================

1. BOOST LIBRARIES (1.84+)
--------------------------
Boost is essential for HFT systems. We need specific modules optimized for
low-latency operations.

Installation via vcpkg (Recommended):
------------------------------------
# Install full Boost with HFT optimizations
vcpkg install boost:x64-linux-hft

# Or install specific modules to save space/time:
vcpkg install boost-asio:x64-linux-hft          # Async I/O
vcpkg install boost-lockfree:x64-linux-hft      # Lock-free queues
vcpkg install boost-circular-buffer:x64-linux-hft
vcpkg install boost-pool:x64-linux-hft          # Memory pools
vcpkg install boost-smart-ptr:x64-linux-hft
vcpkg install boost-thread:x64-linux-hft
vcpkg install boost-chrono:x64-linux-hft
vcpkg install boost-program-options:x64-linux-hft
vcpkg install boost-beast:x64-linux-hft         # HTTP/WebSocket

Installation from Source (For Custom Patches):
----------------------------------------------
cd /tmp
wget https://boostorg.jfrog.io/artifactory/main/release/1.84.0/source/boost_1_84_0.tar.gz
tar -xzf boost_1_84_0.tar.gz
cd boost_1_84_0

# Bootstrap with optimal settings
./bootstrap.sh \
    --prefix=/usr/local \
    --with-toolset=gcc \
    --with-libraries=all

# Build with maximum optimization
./b2 \
    --prefix=/usr/local \
    --build-type=complete \
    variant=release \
    link=static,shared \
    threading=multi \
    cxxflags="-O3 -march=native -mtune=native -std=c++23" \
    linkflags="-flto" \
    -j $(nproc) \
    install

# Verify installation
ls /usr/local/lib/libboost_*
ls /usr/local/include/boost/

CMake Integration:
-----------------
# In CMakeLists.txt:
find_package(Boost 1.84 REQUIRED COMPONENTS
    system
    thread
    chrono
    program_options
    asio
)

target_link_libraries(your_target
    Boost::system
    Boost::thread
    Boost::asio
)

HFT-Specific Boost Configuration:
---------------------------------
# Create boost_config.hpp for your project
cat > include/boost_config.hpp << 'EOF'
#ifndef BOOST_CONFIG_HPP
#define BOOST_CONFIG_HPP

// Disable debug checks in production
#define BOOST_DISABLE_ASSERTS
#define BOOST_ASIO_DISABLE_BUFFER_DEBUGGING

// Enable move semantics
#define BOOST_ASIO_ENABLE_HANDLER_TRACKING 0

// Use spinlocks instead of mutexes where possible
#define BOOST_THREAD_USE_SPINLOCKS

// Pool allocator optimizations
#define BOOST_POOL_NO_MT

#endif
EOF


2. SPDLOG (FAST LOGGING)
-------------------------
Ultra-fast, header-only logging library critical for HFT.

Installation via vcpkg:
----------------------
vcpkg install spdlog:x64-linux-hft
vcpkg install fmt:x64-linux-hft  # spdlog dependency

Installation from Source:
-------------------------
cd /tmp
git clone https://github.com/gabime/spdlog.git
cd spdlog
mkdir build && cd build

cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CXX_FLAGS="-O3 -march=native -std=c++23" \
    -DSPDLOG_BUILD_SHARED=OFF \
    -DSPDLOG_FMT_EXTERNAL=ON \
    -GNinja

ninja
sudo ninja install

CMake Integration:
-----------------
find_package(spdlog REQUIRED)
target_link_libraries(your_target spdlog::spdlog)

HFT Logging Configuration:
-------------------------
// In your code:
#include <spdlog/spdlog.h>
#include <spdlog/sinks/basic_file_sink.h>
#include <spdlog/async.h>

// Create async logger for minimum latency impact
auto logger = spdlog::basic_logger_mt<spdlog::async_factory>(
    "hft_logger",
    "/var/log/hft/trading.log"
);

// Set to warning level in production (info/debug in dev)
logger->set_level(spdlog::level::warn);

// Use compile-time format string checking
SPDLOG_LOGGER_INFO(logger, "Order placed: id={}, price={}", order_id, price);


3. GOOGLE TEST & GOOGLE BENCHMARK
----------------------------------
Essential for unit testing and performance validation.

Installation via vcpkg:
----------------------
vcpkg install gtest:x64-linux-hft
vcpkg install benchmark:x64-linux-hft
vcpkg install gmock:x64-linux-hft

Installation from Source:
-------------------------
# Google Test
cd /tmp
git clone https://github.com/google/googletest.git
cd googletest
mkdir build && cd build

cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DBUILD_SHARED_LIBS=OFF \
    -GNinja

ninja
sudo ninja install

# Google Benchmark
cd /tmp
git clone https://github.com/google/benchmark.git
cd benchmark
mkdir build && cd build

cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DBENCHMARK_ENABLE_GTEST_TESTS=OFF \
    -DBENCHMARK_ENABLE_LTO=ON \
    -GNinja

ninja
sudo ninja install

CMake Integration:
-----------------
# For tests
find_package(GTest REQUIRED)
enable_testing()

add_executable(unit_tests test_main.cpp)
target_link_libraries(unit_tests GTest::GTest GTest::Main)
add_test(NAME unit_tests COMMAND unit_tests)

# For benchmarks
find_package(benchmark REQUIRED)

add_executable(perf_benchmark benchmark_main.cpp)
target_link_libraries(perf_benchmark benchmark::benchmark)

Example Test:
------------
#include <gtest/gtest.h>

TEST(OrderBookTest, AddOrder) {
    OrderBook book;
    Order order{100, 50.25, Side::BUY};
    EXPECT_TRUE(book.add(order));
    EXPECT_EQ(book.size(), 1);
}

Example Benchmark:
-----------------
#include <benchmark/benchmark.h>

static void BM_OrderMatching(benchmark::State& state) {
    OrderBook book;
    for (auto _ : state) {
        book.match_orders();
        benchmark::DoNotOptimize(book);
    }
}
BENCHMARK(BM_OrderMatching);


4. ABSEIL (GOOGLE'S C++ LIBRARY)
---------------------------------
Modern C++ utilities, containers, and algorithms.

Installation via vcpkg:
----------------------
vcpkg install abseil:x64-linux-hft

Installation from Source:
-------------------------
cd /tmp
git clone https://github.com/abseil/abseil-cpp.git
cd abseil-cpp
mkdir build && cd build

cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CXX_STANDARD=23 \
    -DABSL_PROPAGATE_CXX_STD=ON \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DBUILD_SHARED_LIBS=OFF \
    -GNinja

ninja
sudo ninja install

Useful Abseil Components for HFT:
---------------------------------
#include <absl/container/flat_hash_map.h>  // Faster than std::unordered_map
#include <absl/container/flat_hash_set.h>
#include <absl/time/time.h>                 // Time utilities
#include <absl/time/clock.h>
#include <absl/strings/str_format.h>        // Fast string formatting

// Example: Use flat_hash_map for order tracking
absl::flat_hash_map<uint64_t, Order> order_map;
order_map.reserve(10000);  // Pre-allocate


5. FMT (FORMATTING LIBRARY)
----------------------------
Fast formatting library (C++20 std::format backport).

Installation via vcpkg:
----------------------
vcpkg install fmt:x64-linux-hft

Installation from Source:
-------------------------
cd /tmp
git clone https://github.com/fmtlib/fmt.git
cd fmt
mkdir build && cd build

cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DFMT_DOC=OFF \
    -DFMT_TEST=OFF \
    -GNinja

ninja
sudo ninja install

Usage in HFT:
------------
#include <fmt/format.h>
#include <fmt/chrono.h>

// Zero-allocation formatting
fmt::memory_buffer buf;
fmt::format_to(std::back_inserter(buf), "Price: {:.2f}", price);

// Compile-time format string checking
constexpr auto s = fmt::format(FMT_STRING("Order: {}"), order_id);


6. INTEL TBB (THREADING BUILDING BLOCKS)
-----------------------------------------
High-performance parallel programming library.

Installation via vcpkg:
----------------------
vcpkg install tbb:x64-linux-hft

Installation via System Package Manager:
----------------------------------------
# Ubuntu/Debian
sudo apt install -y libtbb-dev

# RHEL/CentOS
sudo dnf install -y tbb-devel

Installation from Source:
-------------------------
cd /tmp
git clone https://github.com/oneapi-src/oneTBB.git
cd oneTBB
mkdir build && cd build

cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DTBB_TEST=OFF \
    -GNinja

ninja
sudo ninja install

HFT Usage:
---------
#include <tbb/concurrent_queue.h>
#include <tbb/concurrent_hash_map.h>

// Lock-free queue for order processing
tbb::concurrent_bounded_queue<Order> order_queue;
order_queue.set_capacity(10000);

// Thread-safe hash map for positions
tbb::concurrent_hash_map<std::string, Position> positions;


7. JEMALLOC (MEMORY ALLOCATOR)
-------------------------------
High-performance memory allocator, better than default malloc.

Installation:
------------
# Ubuntu/Debian
sudo apt install -y libjemalloc-dev

# RHEL/CentOS
sudo dnf install -y jemalloc-devel

# From source (for latest version)
cd /tmp
wget https://github.com/jemalloc/jemalloc/releases/download/5.3.0/jemalloc-5.3.0.tar.bz2
tar -xjf jemalloc-5.3.0.tar.bz2
cd jemalloc-5.3.0

./configure \
    --prefix=/usr/local \
    --enable-prof \
    --enable-stats

make -j $(nproc)
sudo make install

Usage:
-----
# Link with jemalloc
target_link_libraries(your_target jemalloc)

# Or preload for entire application
export LD_PRELOAD=/usr/local/lib/libjemalloc.so
./your_hft_binary

Configuration for HFT:
---------------------
# Set jemalloc environment variables
export MALLOC_CONF="background_thread:true,metadata_thp:auto,dirty_decay_ms:0,muzzy_decay_ms:0"


8. XXHASH (FAST HASHING)
------------------------
Extremely fast non-cryptographic hash function.

Installation via vcpkg:
----------------------
vcpkg install xxhash:x64-linux-hft

Installation from Source:
-------------------------
cd /tmp
git clone https://github.com/Cyan4973/xxHash.git
cd xxHash
make -j $(nproc)
sudo make install

Usage in HFT:
------------
#include <xxhash.h>

// Fast hashing for message deduplication
XXH64_hash_t hash = XXH64(data, length, seed);

// Streaming hash for large data
XXH64_state_t* state = XXH64_createState();
XXH64_reset(state, seed);
XXH64_update(state, chunk1, len1);
XXH64_update(state, chunk2, len2);
XXH64_hash_t hash = XXH64_digest(state);


9. LIBDIVIDE (FAST DIVISION)
-----------------------------
Replaces expensive division with multiplication.

Installation:
------------
cd /tmp
git clone https://github.com/ridiculousfish/libdivide.git
sudo cp libdivide/libdivide.h /usr/local/include/

Usage:
-----
#include <libdivide.h>

// Pre-compute divider
libdivide::divider<int64_t> fast_div(1000000);

// Fast division (much faster than n / 1000000)
int64_t result = n / fast_div;


10. FOLLY (FACEBOOK'S C++ LIBRARY)
----------------------------------
High-performance components from Facebook.

Installation from Source:
-------------------------
# Install dependencies first
sudo apt install -y \
    libboost-all-dev \
    libevent-dev \
    libdouble-conversion-dev \
    libgoogle-glog-dev \
    libgflags-dev \
    libiberty-dev \
    liblz4-dev \
    liblzma-dev \
    libsnappy-dev \
    libzstd-dev \
    libsodium-dev \
    libssl-dev

cd /tmp
git clone https://github.com/facebook/folly.git
cd folly
mkdir build && cd build

cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_CXX_FLAGS="-O3 -march=native" \
    -DBUILD_SHARED_LIBS=OFF \
    -GNinja

ninja
sudo ninja install

Useful Folly Components:
-----------------------
#include <folly/MPMCQueue.h>           // Multi-producer multi-consumer queue
#include <folly/ProducerConsumerQueue.h>
#include <folly/small_vector.h>        // Stack-allocated vector
#include <folly/FBString.h>            // Optimized string

// Example: SPSC queue for order flow
folly::ProducerConsumerQueue<Order> order_queue(10000);


DEPENDENCY VERIFICATION
=======================

Create Verification Program:
----------------------------
cat > /tmp/verify_deps.cpp << 'EOF'
#include <iostream>
#include <boost/version.hpp>
#include <spdlog/version.h>
#include <fmt/core.h>
#include <gtest/gtest.h>

int main() {
    std::cout << "=== C++ Dependencies Verification ===\n";
    std::cout << "Boost version: " << BOOST_VERSION / 100000 << "."
              << BOOST_VERSION / 100 % 1000 << "."
              << BOOST_VERSION % 100 << "\n";
    std::cout << "spdlog version: " << SPDLOG_VER_MAJOR << "."
              << SPDLOG_VER_MINOR << "." << SPDLOG_VER_PATCH << "\n";
    std::cout << "fmt version: " << FMT_VERSION << "\n";
    std::cout << "GTest version: " << GTEST_VERSION_MAJOR << "."
              << GTEST_VERSION_MINOR << "\n";
    std::cout << "All dependencies verified!\n";
    return 0;
}
EOF

# Compile
g++ -std=c++23 /tmp/verify_deps.cpp \
    -o /tmp/verify_deps \
    -lboost_system -lspdlog -lfmt -lgtest

# Run
/tmp/verify_deps


COMPLETE INSTALLATION SCRIPT
=============================

cat > /tmp/install_cpp_deps.sh << 'EOF'
#!/bin/bash
set -euo pipefail

echo "Installing C++ dependencies for HFT system..."

# Ensure vcpkg is available
if [ ! -d "/opt/vcpkg" ]; then
    echo "Error: vcpkg not found. Run 01_package_managers.txt first"
    exit 1
fi

export VCPKG_ROOT=/opt/vcpkg
export PATH=$VCPKG_ROOT:$PATH

# Install all dependencies via vcpkg
echo "Installing via vcpkg (this will take 1-3 hours)..."

vcpkg install \
    boost:x64-linux-hft \
    spdlog:x64-linux-hft \
    fmt:x64-linux-hft \
    gtest:x64-linux-hft \
    benchmark:x64-linux-hft \
    abseil:x64-linux-hft \
    tbb:x64-linux-hft \
    xxhash:x64-linux-hft

# Install system packages
if command -v apt &> /dev/null; then
    sudo apt install -y libjemalloc-dev
elif command -v dnf &> /dev/null; then
    sudo dnf install -y jemalloc-devel
fi

echo "C++ dependencies installation complete!"
echo "Run verification: g++ -std=c++23 /tmp/verify_deps.cpp -lboost_system -lspdlog"
EOF

chmod +x /tmp/install_cpp_deps.sh


TROUBLESHOOTING
===============

1. Boost installation fails:
   - Check disk space: df -h
   - Increase build timeout: vcpkg install boost --x-buildtrees-root=/tmp/build
   - Install from system packages as fallback: sudo apt install libboost-all-dev

2. Linking errors:
   - Ensure CMake finds libraries: cmake .. -DCMAKE_PREFIX_PATH=/usr/local
   - Check library paths: ldconfig -p | grep boost
   - Add to LD_LIBRARY_PATH: export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

3. Version conflicts:
   - Use vcpkg manifest mode to lock versions
   - Create vcpkg.json with exact versions
   - Avoid mixing system packages with vcpkg

4. Performance issues after installation:
   - Verify optimization flags: strings libboost_system.a | grep -- -O
   - Run benchmarks to compare performance
   - Consider building from source with custom flags

================================================================================
Next: 03_database_installation.txt
================================================================================
