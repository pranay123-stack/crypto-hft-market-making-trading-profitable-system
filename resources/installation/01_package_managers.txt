================================================================================
PACKAGE MANAGERS FOR HFT C++ DEVELOPMENT
================================================================================

OVERVIEW
--------
This guide covers installation and configuration of all package managers needed
for HFT system development. We use multiple package managers because:

- apt/yum/dnf: System-level packages and tools
- vcpkg: C++ libraries (Microsoft's package manager)
- conan: Alternative C++ package manager (for some libraries)
- pip: Python tools for build automation

SYSTEM PACKAGE MANAGERS
========================

1. APT (UBUNTU/DEBIAN)
-----------------------

Update Package Lists:
---------------------
sudo apt update
sudo apt upgrade -y

# Add universe and multiverse repositories
sudo add-apt-repository universe
sudo add-apt-repository multiverse
sudo apt update

Install Essential Build Tools:
------------------------------
sudo apt install -y \
    build-essential \
    g++-13 \
    gcc-13 \
    clang-17 \
    clang++-17 \
    cmake \
    ninja-build \
    git \
    wget \
    curl \
    vim \
    htop \
    net-tools \
    openssh-server \
    ca-certificates \
    gnupg \
    lsb-release

# Set GCC 13 as default
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100

# Set Clang 17 as alternative
sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-17 100
sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-17 100

Configure APT for Performance:
------------------------------
# Enable parallel downloads
sudo tee -a /etc/apt/apt.conf.d/99parallel << EOF
APT::Acquire::Queue-Mode "host";
APT::Acquire::Retries "3";
Acquire::http::Pipeline-Depth "5";
EOF

# Configure local package cache
sudo apt install -y apt-cacher-ng

# Point APT to local cache (optional, for multiple machines)
echo 'Acquire::http::Proxy "http://127.0.0.1:3142";' | \
    sudo tee /etc/apt/apt.conf.d/02proxy

Add Third-Party Repositories:
-----------------------------
# Kitware (latest CMake)
wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | \
    gpg --dearmor - | \
    sudo tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null

echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] \
    https://apt.kitware.com/ubuntu/ jammy main' | \
    sudo tee /etc/apt/sources.list.d/kitware.list

sudo apt update
sudo apt install -y cmake

# LLVM (latest Clang)
wget https://apt.llvm.org/llvm.sh
chmod +x llvm.sh
sudo ./llvm.sh 17

Verify Installation:
-------------------
gcc --version          # Should show 13.x
g++ --version          # Should show 13.x
clang --version        # Should show 17.x
cmake --version        # Should show 3.28+
ninja --version        # Should show 1.11+


2. YUM/DNF (RHEL/CENTOS/FEDORA)
--------------------------------

Update System:
-------------
sudo dnf update -y

# Enable EPEL repository
sudo dnf install -y epel-release

# Enable PowerTools/CRB repository (RHEL 8/9)
sudo dnf config-manager --set-enabled powertools  # RHEL 8
sudo dnf config-manager --set-enabled crb         # RHEL 9

Install Development Tools:
-------------------------
sudo dnf groupinstall -y "Development Tools"

sudo dnf install -y \
    gcc \
    gcc-c++ \
    clang \
    cmake \
    ninja-build \
    git \
    wget \
    curl \
    vim \
    htop \
    net-tools \
    openssh-server

# Install GCC 13 from SCL (Software Collections)
sudo dnf install -y gcc-toolset-13
scl enable gcc-toolset-13 bash

# Make GCC 13 permanent
echo 'source /opt/rh/gcc-toolset-13/enable' >> ~/.bashrc

Configure DNF for Performance:
------------------------------
# Edit /etc/dnf/dnf.conf
sudo tee -a /etc/dnf/dnf.conf << EOF
max_parallel_downloads=10
fastestmirror=True
deltarpm=True
EOF

Verify Installation:
-------------------
gcc --version
g++ --version
clang --version
cmake --version


3. PACMAN (ARCH LINUX)
-----------------------
Note: Not recommended for production HFT systems, but included for completeness.

Update System:
-------------
sudo pacman -Syu

Install Development Tools:
-------------------------
sudo pacman -S --needed base-devel
sudo pacman -S gcc clang cmake ninja git wget curl vim htop

Install AUR Helper (yay):
------------------------
git clone https://aur.archlinux.org/yay.git
cd yay
makepkg -si

Verify Installation:
-------------------
gcc --version
clang --version
cmake --version


C++ PACKAGE MANAGERS
====================

4. VCPKG (MICROSOFT C++ PACKAGE MANAGER)
-----------------------------------------
vcpkg is our primary C++ package manager for HFT development.

Installation:
------------
# Clone vcpkg repository
cd /opt
sudo git clone https://github.com/Microsoft/vcpkg.git
sudo chown -R $USER:$USER vcpkg
cd vcpkg

# Bootstrap vcpkg
./bootstrap-vcpkg.sh -disableMetrics

# Add to PATH
echo 'export VCPKG_ROOT=/opt/vcpkg' >> ~/.bashrc
echo 'export PATH=$VCPKG_ROOT:$PATH' >> ~/.bashrc
source ~/.bashrc

# Enable binary caching for faster builds
export VCPKG_BINARY_SOURCES="clear;files,$HOME/.vcpkg-cache,readwrite"
mkdir -p $HOME/.vcpkg-cache

# Add to .bashrc for persistence
echo 'export VCPKG_BINARY_SOURCES="clear;files,$HOME/.vcpkg-cache,readwrite"' >> ~/.bashrc

Configure vcpkg:
---------------
# Set default triplet for optimal performance
echo 'set(VCPKG_TARGET_TRIPLET "x64-linux-release" CACHE STRING "")' > \
    $VCPKG_ROOT/triplets/community/x64-linux-release.cmake

# Custom triplet for HFT (maximum optimization)
cat > $VCPKG_ROOT/triplets/community/x64-linux-hft.cmake << 'EOF'
set(VCPKG_TARGET_ARCHITECTURE x64)
set(VCPKG_CRT_LINKAGE dynamic)
set(VCPKG_LIBRARY_LINKAGE static)
set(VCPKG_CMAKE_SYSTEM_NAME Linux)

set(VCPKG_C_FLAGS "-O3 -march=native -mtune=native -flto")
set(VCPKG_CXX_FLAGS "-O3 -march=native -mtune=native -flto -std=c++23")
set(VCPKG_LINKER_FLAGS "-flto")
EOF

Install Essential C++ Libraries via vcpkg:
------------------------------------------
# Core libraries
vcpkg install boost:x64-linux-hft
vcpkg install spdlog:x64-linux-hft
vcpkg install fmt:x64-linux-hft
vcpkg install gtest:x64-linux-hft
vcpkg install benchmark:x64-linux-hft

# Networking
vcpkg install curl:x64-linux-hft
vcpkg install openssl:x64-linux-hft
vcpkg install websocketpp:x64-linux-hft

# Serialization
vcpkg install nlohmann-json:x64-linux-hft
vcpkg install protobuf:x64-linux-hft
vcpkg install flatbuffers:x64-linux-hft

# This will take 1-3 hours on first run, but creates binary cache

Integrate with CMake:
--------------------
# Global integration (recommended for development)
sudo $VCPKG_ROOT/vcpkg integrate install

# Or use in CMakeLists.txt:
# cmake -DCMAKE_TOOLCHAIN_FILE=/opt/vcpkg/scripts/buildsystems/vcpkg.cmake ..

Verify vcpkg Installation:
-------------------------
vcpkg list                    # List installed packages
vcpkg search boost            # Search for packages
vcpkg update                  # Check for updates


5. CONAN (ALTERNATIVE C++ PACKAGE MANAGER)
-------------------------------------------
Conan is useful for some libraries not available in vcpkg.

Installation:
------------
# Install Python 3 if not already installed
sudo apt install -y python3 python3-pip python3-venv

# Create virtual environment for Conan
python3 -m venv ~/.conan-venv
source ~/.conan-venv/bin/activate

# Install Conan
pip install conan

# Add to .bashrc for auto-activation
echo 'source ~/.conan-venv/bin/activate' >> ~/.bashrc

Configure Conan:
---------------
# Set up default profile
conan profile detect --force

# Edit profile for optimization
conan profile path default
# This shows path, typically: ~/.conan2/profiles/default

# Edit the profile:
cat > ~/.conan2/profiles/default << 'EOF'
[settings]
arch=x86_64
build_type=Release
compiler=gcc
compiler.cppstd=23
compiler.libcxx=libstdc++11
compiler.version=13
os=Linux

[buildenv]
CC=gcc-13
CXX=g++-13

[conf]
tools.build:compiler_executables={"c": "gcc-13", "cpp": "g++-13"}
tools.cmake.cmaketoolchain:generator=Ninja
EOF

# Create HFT-optimized profile
conan profile detect --force --name hft
cat > ~/.conan2/profiles/hft << 'EOF'
[settings]
arch=x86_64
build_type=Release
compiler=gcc
compiler.cppstd=23
compiler.libcxx=libstdc++11
compiler.version=13
os=Linux

[options]

[buildenv]
CFLAGS=-O3 -march=native -mtune=native -flto
CXXFLAGS=-O3 -march=native -mtune=native -flto -std=c++23
LDFLAGS=-flto

[conf]
tools.build:compiler_executables={"c": "gcc-13", "cpp": "g++-13"}
tools.cmake.cmaketoolchain:generator=Ninja
EOF

Add Conan Remotes:
-----------------
# Default remote is conancenter
conan remote list

# Add additional remotes if needed
conan remote add bincrafters https://bincrafters.jfrog.io/artifactory/api/conan/public-conan

Install Libraries via Conan:
----------------------------
# Example: Install a library
conan install <library>/[version]@ --profile=hft

# Example conanfile.txt for project:
cat > conanfile.txt << 'EOF'
[requires]
spdlog/1.12.0
fmt/10.1.1
gtest/1.14.0

[generators]
CMakeDeps
CMakeToolchain

[options]
spdlog:shared=False
fmt:shared=False
gtest:shared=False
EOF

# Install dependencies
conan install . --build=missing --profile=hft

Verify Conan Installation:
-------------------------
conan --version               # Should be 2.x
conan profile show default    # Show profile
conan search '*'              # Search available packages


PACKAGE MANAGER COMPARISON
==========================

When to Use Each:
----------------
vcpkg:
  - Primary choice for C++ libraries
  - Better CMake integration
  - More consistent builds
  - Easier binary caching
  - Used for: Boost, spdlog, gtest, networking libs

conan:
  - When library not in vcpkg
  - Better dependency resolution for complex projects
  - More flexible profiles
  - Used for: Specialized HFT libraries

apt/yum:
  - System tools and utilities
  - Development tools (gcc, clang, cmake)
  - Database servers
  - Monitoring tools

Performance Comparison:
----------------------
Build Time (first install):
  vcpkg: ~2-3 hours (with binary cache: 10-20 min)
  conan: ~1-2 hours (with cache: 5-10 min)
  apt/yum: 10-30 minutes

Disk Space:
  vcpkg: ~15-20GB (with all HFT libraries)
  conan: ~5-10GB
  apt/yum: ~2-5GB


CACHING AND OPTIMIZATION
========================

vcpkg Binary Caching:
--------------------
# Local filesystem cache (already configured above)
export VCPKG_BINARY_SOURCES="clear;files,$HOME/.vcpkg-cache,readwrite"

# Network cache (for team use)
export VCPKG_BINARY_SOURCES="clear;http,http://cache-server:8080/{sha},readwrite"

# NuGet cache (Azure DevOps)
export VCPKG_BINARY_SOURCES="clear;nuget,https://pkgs.dev.azure.com/...;readwrite"

Conan Binary Cache:
------------------
# Configure cache directory
conan config home

# Enable revisions (Conan 2.x default)
# Already enabled in Conan 2.x

# Upload to Artifactory (team use)
conan upload '*' -r=artifactory --all


TROUBLESHOOTING
===============

Common Issues:
-------------

1. vcpkg bootstrap fails:
   Problem: Missing dependencies
   Solution:
   sudo apt install -y curl zip unzip tar pkg-config
   ./bootstrap-vcpkg.sh

2. Compiler not found:
   Problem: vcpkg can't find gcc/clang
   Solution:
   export CC=/usr/bin/gcc-13
   export CXX=/usr/bin/g++-13
   ./bootstrap-vcpkg.sh

3. Conan profile errors:
   Problem: Wrong compiler version
   Solution:
   conan profile detect --force
   # Edit ~/.conan2/profiles/default manually

4. Package installation fails:
   Problem: Network issues or missing dependencies
   Solution:
   # For vcpkg:
   vcpkg install <package> --debug
   # For conan:
   conan install . --build=missing -vv

5. Binary cache not working:
   Problem: Permissions or path issues
   Solution:
   mkdir -p $HOME/.vcpkg-cache
   chmod -R 755 $HOME/.vcpkg-cache

Performance Issues:
------------------

1. Slow package installation:
   - Enable binary caching (shown above)
   - Use parallel builds: vcpkg install --x-buildtrees-root=/tmp/vcpkg-build
   - Use faster mirror if available

2. Disk space issues:
   - Clean old builds: vcpkg remove --outdated
   - Use shared cache across projects
   - Mount /tmp on tmpfs for build directories

3. CMake integration slow:
   - Use manifest mode (vcpkg.json)
   - Enable binary caching
   - Use Ninja instead of Make


AUTOMATION SCRIPTS
==================

Automated Setup Script:
----------------------
cat > /tmp/setup_package_managers.sh << 'EOF'
#!/bin/bash
set -euo pipefail

echo "Setting up package managers for HFT system..."

# Install system packages
if command -v apt &> /dev/null; then
    sudo apt update
    sudo apt install -y build-essential cmake ninja-build git curl wget
elif command -v dnf &> /dev/null; then
    sudo dnf groupinstall -y "Development Tools"
    sudo dnf install -y cmake ninja-build git curl wget
fi

# Install vcpkg
if [ ! -d "/opt/vcpkg" ]; then
    cd /opt
    sudo git clone https://github.com/Microsoft/vcpkg.git
    sudo chown -R $USER:$USER vcpkg
    cd vcpkg
    ./bootstrap-vcpkg.sh -disableMetrics
    echo 'export VCPKG_ROOT=/opt/vcpkg' >> ~/.bashrc
    echo 'export PATH=$VCPKG_ROOT:$PATH' >> ~/.bashrc
fi

# Install Conan
if ! command -v conan &> /dev/null; then
    python3 -m venv ~/.conan-venv
    source ~/.conan-venv/bin/activate
    pip install conan
    conan profile detect --force
fi

echo "Package managers setup complete!"
EOF

chmod +x /tmp/setup_package_managers.sh
/tmp/setup_package_managers.sh


VERIFICATION
============

Final Checks:
------------
# System package manager
apt --version || dnf --version

# vcpkg
vcpkg version

# Conan
conan --version

# Compiler versions
gcc --version
g++ --version
clang --version
clang++ --version

# Build tools
cmake --version
ninja --version

# Test vcpkg installation
vcpkg install fmt:x64-linux
vcpkg list | grep fmt

# Test Conan installation
conan search fmt --remote=conancenter

If all commands succeed, your package managers are properly configured!

================================================================================
Next: 02_cpp_dependencies.txt
================================================================================
