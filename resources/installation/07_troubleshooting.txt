================================================================================
INSTALLATION TROUBLESHOOTING GUIDE
================================================================================

OVERVIEW
--------
Common installation issues, error messages, and solutions for HFT system setup.
Organized by category with copy-paste ready commands.

PACKAGE MANAGER ISSUES
======================

1. vcpkg Bootstrap Fails
-------------------------
Error: "./bootstrap-vcpkg.sh: Permission denied"
Solution:
chmod +x /opt/vcpkg/bootstrap-vcpkg.sh
./bootstrap-vcpkg.sh

Error: "Could not find curl, zip, unzip, or tar"
Solution:
sudo apt install -y curl zip unzip tar pkg-config git

Error: "cmake not found"
Solution:
sudo apt install -y cmake
# Or install latest from Kitware repository (see 01_package_managers.txt)

2. vcpkg Package Installation Fails
------------------------------------
Error: "Error: Building package boost:x64-linux failed"
Solution:
# Check disk space
df -h
# Increase build timeout
vcpkg install boost:x64-linux --x-buildtrees-root=/tmp/vcpkg-build
# Or install from system packages
sudo apt install -y libboost-all-dev

Error: "Binary caching failed"
Solution:
# Check cache directory permissions
mkdir -p $HOME/.vcpkg-cache
chmod -R 755 $HOME/.vcpkg-cache
# Verify environment variable
echo $VCPKG_BINARY_SOURCES

3. Conan Profile Issues
------------------------
Error: "Conan profile not found"
Solution:
conan profile detect --force
cat ~/.conan2/profiles/default

Error: "Compiler not found"
Solution:
# Update profile with correct compiler path
conan profile path default
# Edit and set:
[buildenv]
CC=/usr/bin/gcc-13
CXX=/usr/bin/g++-13

4. APT/DNF Repository Issues
-----------------------------
Error: "Unable to fetch repository"
Solution:
# Ubuntu/Debian
sudo apt update --fix-missing
sudo apt clean
sudo apt update

# RHEL/CentOS
sudo dnf clean all
sudo dnf makecache


COMPILATION ISSUES
==================

5. Compiler Version Errors
---------------------------
Error: "error: #error This file requires compiler and library support for C++23"
Solution:
# Check compiler version
g++ --version  # Should be 13+
clang++ --version  # Should be 17+

# Update alternatives
sudo update-alternatives --config gcc
sudo update-alternatives --config g++

# Or install newer compiler
sudo apt install -y g++-13
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100

6. Missing Headers
------------------
Error: "fatal error: boost/asio.hpp: No such file or directory"
Solution:
# Check Boost installation
dpkg -l | grep libboost  # Ubuntu
rpm -qa | grep boost     # RHEL

# Install missing development headers
sudo apt install -y libboost-all-dev

# Verify include paths
g++ -v -E -x c++ - < /dev/null 2>&1 | grep include

# Add to CMakeLists.txt if needed
include_directories(/usr/local/include)

7. Linking Errors
-----------------
Error: "undefined reference to `boost::system::generic_category()'"
Solution:
# Add library to link command
target_link_libraries(your_target Boost::system)

# Or manually:
g++ ... -lboost_system

# Check library exists
ldconfig -p | grep boost_system

Error: "cannot find -lssl"
Solution:
sudo apt install -y libssl-dev
sudo ldconfig

8. CMake Configuration Fails
-----------------------------
Error: "CMake Error: Could NOT find Boost"
Solution:
# Set Boost root explicitly
cmake -DBOOST_ROOT=/usr/local ..

# Or use vcpkg toolchain
cmake -DCMAKE_TOOLCHAIN_FILE=/opt/vcpkg/scripts/buildsystems/vcpkg.cmake ..

# Increase CMake verbosity
cmake --debug-find ..

Error: "CMake version too old"
Solution:
# Install latest CMake from Kitware
wget https://github.com/Kitware/CMake/releases/download/v3.28.0/cmake-3.28.0-linux-x86_64.sh
chmod +x cmake-3.28.0-linux-x86_64.sh
sudo ./cmake-3.28.0-linux-x86_64.sh --prefix=/usr/local --skip-license


DATABASE ISSUES
===============

9. PostgreSQL Won't Start
--------------------------
Error: "could not connect to server: Connection refused"
Solution:
# Check status
sudo systemctl status postgresql

# Check logs
sudo journalctl -u postgresql -n 50

# Check port
sudo ss -tlnp | grep 5432

# Restart
sudo systemctl restart postgresql

# Check pg_hba.conf
sudo vim /etc/postgresql/16/main/pg_hba.conf

Error: "FATAL: role 'postgres' does not exist"
Solution:
sudo -u postgres createuser --superuser $USER

10. TimescaleDB Extension Fails
--------------------------------
Error: "could not open extension control file"
Solution:
# Verify TimescaleDB installation
dpkg -l | grep timescaledb

# Check PostgreSQL version compatibility
psql --version
dpkg -l | grep timescaledb

# Reinstall matching version
sudo apt install -y timescaledb-2-postgresql-16

# Add to postgresql.conf
echo "shared_preload_libraries = 'timescaledb'" | \
    sudo tee -a /etc/postgresql/16/main/postgresql.conf

sudo systemctl restart postgresql

11. Redis Connection Issues
----------------------------
Error: "Could not connect to Redis at 127.0.0.1:6379: Connection refused"
Solution:
# Check Redis status
sudo systemctl status redis
sudo systemctl start redis

# Check configuration
sudo vim /etc/redis/redis.conf
# Ensure: bind 127.0.0.1 or bind 0.0.0.0

# Check port
sudo ss -tlnp | grep 6379

# Test connection
redis-cli ping

Error: "MISCONF Redis is configured to save RDB snapshots"
Solution:
# Disable RDB persistence (for testing only)
redis-cli CONFIG SET save ""

# Or fix disk space issue
df -h
sudo rm -rf /var/lib/redis/dump.rdb.old

12. ClickHouse Won't Start
---------------------------
Error: "Cannot start ClickHouse server"
Solution:
# Check logs
sudo tail -f /var/log/clickhouse-server/clickhouse-server.log

# Check disk space
df -h /var/lib/clickhouse

# Verify configuration
sudo clickhouse-server --config-file=/etc/clickhouse-server/config.xml --test

# Reset permissions
sudo chown -R clickhouse:clickhouse /var/lib/clickhouse
sudo systemctl restart clickhouse-server


NETWORKING ISSUES
=================

13. WebSocket Connection Fails
-------------------------------
Error: "WebSocket handshake failed"
Solution:
# Test basic connectivity
curl -I https://stream.binance.com:9443

# Check SSL certificates
openssl s_client -connect stream.binance.com:9443 -showcerts

# Verify DNS
nslookup stream.binance.com
ping stream.binance.com

# Test with simple WebSocket client
wscat -c wss://stream.binance.com:9443/ws/btcusdt@trade

# Install wscat if needed
sudo npm install -g wscat

14. High Network Latency
-------------------------
Issue: Latency > 1ms to exchange
Solution:
# Measure latency
ping -c 100 api.binance.com | tail -1

# Check network path
traceroute api.binance.com
mtr api.binance.com

# Optimize TCP settings (see 04_networking_libraries.txt)
sudo sysctl -w net.ipv4.tcp_fastopen=3
sudo sysctl -w net.ipv4.tcp_slow_start_after_idle=0

# Check NIC offloading
sudo ethtool -k eth0 | grep offload

# Enable TCP optimizations
sudo ethtool -K eth0 tso on gso on gro on

15. SSL/TLS Certificate Errors
-------------------------------
Error: "SSL certificate problem: unable to get local issuer certificate"
Solution:
# Update CA certificates
sudo apt install -y ca-certificates
sudo update-ca-certificates

# For libcurl
export CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt

# For specific certificate
curl --cacert /path/to/cert.pem https://api.exchange.com

16. Port Already in Use
-----------------------
Error: "bind: Address already in use"
Solution:
# Find process using port
sudo ss -tlnp | grep :8080
sudo lsof -i :8080

# Kill process
kill -9 <PID>

# Or use different port
./your_app --port 8081


MONITORING STACK ISSUES
========================

17. Prometheus Won't Start
---------------------------
Error: "Error opening memory series storage"
Solution:
# Check disk space
df -h /var/lib/prometheus

# Fix permissions
sudo chown -R prometheus:prometheus /var/lib/prometheus

# Validate configuration
/opt/prometheus/promtool check config /etc/prometheus/prometheus.yml

# Check logs
sudo journalctl -u prometheus -f

18. Grafana Dashboard Issues
-----------------------------
Error: "Dashboard not loading"
Solution:
# Check Grafana status
sudo systemctl status grafana-server

# Check logs
sudo tail -f /var/log/grafana/grafana.log

# Verify data source
curl http://localhost:3000/api/datasources

# Test Prometheus connection
curl http://localhost:9090/api/v1/query?query=up

19. Metrics Not Appearing
--------------------------
Issue: Custom metrics not visible in Prometheus
Solution:
# Verify application is exposing metrics
curl http://localhost:8080/metrics

# Check Prometheus targets
# Visit: http://localhost:9090/targets

# Verify scrape configuration
cat /etc/prometheus/prometheus.yml | grep -A 5 hft_app

# Force reload Prometheus config
curl -X POST http://localhost:9090/-/reload

# Or restart
sudo systemctl restart prometheus


PERFORMANCE ISSUES
==================

20. Slow Build Times
--------------------
Issue: Compilation takes hours
Solution:
# Enable parallel builds
cmake -DCMAKE_BUILD_PARALLEL_LEVEL=$(nproc) ..
ninja -j $(nproc)

# Use ccache
sudo apt install -y ccache
export PATH="/usr/lib/ccache:$PATH"

# Check ccache stats
ccache -s

# Use tmpfs for build
sudo mount -t tmpfs -o size=16G tmpfs /tmp/build
cmake -B /tmp/build ..

21. High Memory Usage During Build
-----------------------------------
Error: "c++: fatal error: Killed signal terminated program"
Solution:
# Limit parallel jobs
ninja -j 4  # Instead of -j $(nproc)

# Increase swap
sudo fallocate -l 8G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# Monitor memory
watch -n 1 free -h

22. Runtime Performance Issues
-------------------------------
Issue: High latency in production
Solution:
# Check CPU frequency scaling
cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# Set to performance mode
echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# Disable CPU idle states
sudo cpupower idle-set -D 0

# Check process affinity
taskset -c -p $(pgrep hft_app)

# Set CPU affinity
taskset -c 0-7 ./hft_app

# Check for CPU throttling
sudo turbostat --quiet --show PkgWatt,PkgTmp,RAMWatt

23. Database Performance Issues
--------------------------------
Issue: High query latency
Solution:
# PostgreSQL - Check slow queries
psql -c "SELECT query, mean_exec_time FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 10;"

# Enable query timing
\timing on

# Check indexes
psql -c "\d+ trading.orders"

# Vacuum database
sudo -u postgres vacuumdb --all --analyze

# Redis - Check slow log
redis-cli SLOWLOG GET 10

# Monitor Redis memory
redis-cli INFO memory

# ClickHouse - Check query log
clickhouse-client --query "SELECT * FROM system.query_log WHERE query_duration_ms > 1000 ORDER BY query_duration_ms DESC LIMIT 10"


DEPENDENCY CONFLICTS
====================

24. Multiple Boost Versions
----------------------------
Issue: Linking against wrong Boost version
Solution:
# Find all Boost installations
locate libboost_system.so

# Remove old versions
sudo apt remove libboost-all-dev
sudo apt autoremove

# Install specific version via vcpkg
vcpkg install boost@1.84.0:x64-linux-hft

# Force CMake to use specific version
cmake -DBOOST_ROOT=/opt/vcpkg/installed/x64-linux-hft ..

25. Library ABI Incompatibility
--------------------------------
Error: "version 'GLIBCXX_3.4.30' not found"
Solution:
# Check available versions
strings /usr/lib/x86_64-linux-gnu/libstdc++.so.6 | grep GLIBCXX

# Update libstdc++
sudo apt install -y libstdc++6

# Or rebuild with correct compiler
export CXX=g++-13
make clean && make


SYSTEM-LEVEL ISSUES
===================

26. Insufficient File Descriptors
----------------------------------
Error: "Too many open files"
Solution:
# Check current limits
ulimit -n

# Increase for current session
ulimit -n 65536

# Make permanent
echo "* soft nofile 65536" | sudo tee -a /etc/security/limits.conf
echo "* hard nofile 65536" | sudo tee -a /etc/security/limits.conf

# For systemd services
sudo mkdir -p /etc/systemd/system/hft_app.service.d
echo -e "[Service]\nLimitNOFILE=65536" | \
    sudo tee /etc/systemd/system/hft_app.service.d/limits.conf

27. Shared Memory Issues
-------------------------
Error: "Cannot allocate memory in shared memory segment"
Solution:
# Increase shared memory limits
sudo sysctl -w kernel.shmmax=17179869184
sudo sysctl -w kernel.shmall=4194304

# Make permanent
echo "kernel.shmmax=17179869184" | sudo tee -a /etc/sysctl.conf
echo "kernel.shmall=4194304" | sudo tee -a /etc/sysctl.conf

28. Clock Synchronization Issues
---------------------------------
Issue: Timestamps inconsistent with exchanges
Solution:
# Install NTP
sudo apt install -y chrony

# Configure chrony for low latency
sudo vim /etc/chrony/chrony.conf
# Add: server time.google.com iburst

# Restart chrony
sudo systemctl restart chrony

# Check synchronization
chronyc tracking
chronyc sources


DIAGNOSTIC COMMANDS
===================

System Health Check:
-------------------
#!/bin/bash
echo "=== System Health Check ==="
echo "CPU: $(nproc) cores"
echo "Memory: $(free -h | awk '/^Mem:/{print $2}')"
echo "Disk: $(df -h / | awk 'NR==2{print $4}') free"
echo "Compiler: $(g++ --version | head -1)"
echo "CMake: $(cmake --version | head -1)"
echo "PostgreSQL: $(psql --version)"
echo "Redis: $(redis-cli --version)"
echo "Network latency to Binance: $(ping -c 5 api.binance.com | tail -1)"

Dependency Check:
----------------
#!/bin/bash
echo "=== Checking C++ Dependencies ==="
for lib in boost_system spdlog fmt gtest curl ssl crypto zmq; do
    if ldconfig -p | grep -q "lib$lib"; then
        echo "✓ $lib found"
    else
        echo "✗ $lib missing"
    fi
done

Service Status:
--------------
#!/bin/bash
echo "=== Service Status ==="
for service in postgresql redis clickhouse-server prometheus grafana-server; do
    if systemctl is-active --quiet $service; then
        echo "✓ $service running"
    else
        echo "✗ $service stopped"
    fi
done


GETTING HELP
============

Log Collection Script:
---------------------
#!/bin/bash
mkdir -p /tmp/hft_debug
echo "Collecting logs..."
sudo journalctl -u postgresql > /tmp/hft_debug/postgresql.log
sudo journalctl -u redis > /tmp/hft_debug/redis.log
sudo cp /var/log/grafana/grafana.log /tmp/hft_debug/
sudo cp /etc/prometheus/prometheus.yml /tmp/hft_debug/
tar -czf /tmp/hft_debug_$(date +%Y%m%d_%H%M%S).tar.gz /tmp/hft_debug/
echo "Logs collected in /tmp/hft_debug_*.tar.gz"

Community Resources:
-------------------
- Boost: https://lists.boost.org/Archives/boost/
- PostgreSQL: https://www.postgresql.org/list/
- Redis: https://redis.io/community
- ClickHouse: https://clickhouse.com/slack
- vcpkg: https://github.com/microsoft/vcpkg/issues

================================================================================
End of Installation Guide
================================================================================
